<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Command Center | National Portal</title>
    
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="theme.js"></script>

    <style>
        /* --- 1. CORE LAYOUT --- */
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; }
        .wrapper { display: flex; width: 100%; height: 100%; position: relative; }

        /* --- 2. COMMAND CENTER SIDEBAR (Strict Dark Mode) --- */
        .sidebar { width: 280px; background: #0f172a; border-right: 1px solid #1e293b; display: flex; flex-direction: column; flex-shrink: 0; color: white; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000;}
        .sidebar-header { padding: 25px; font-weight: 800; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 12px; font-size: 1.2rem; letter-spacing: -0.5px; }
        
        .nav-links { list-style: none; padding: 20px 0; margin: 0; flex: 1; overflow-y: auto; }
        .nav-links li { margin-bottom: 5px; padding: 0 15px; }
        .nav-links a { display: flex; align-items: center; gap: 15px; color: #94a3b8; text-decoration: none; padding: 14px 18px; border-radius: 8px; transition: all 0.2s ease; font-weight: 600; font-size: 0.95rem; border-left: 3px solid transparent; }
        .nav-links a:hover, .nav-links a.active { background: rgba(255,255,255,0.05); color: #f8fafc; border-left: 3px solid #3b82f6; }
        .nav-links a.active i { color: #3b82f6; }
        
        .sidebar-footer { padding: 20px 25px; border-top: 1px solid rgba(255,255,255,0.05); }

        /* --- 3. MAIN CONTENT & HEADER --- */
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg-color); position: relative; }
        .scroll-area { flex: 1; padding: 40px; overflow-y: auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; flex-wrap: wrap; gap: 15px; }
        .header h1 { margin: 0; font-size: 2rem; font-weight: 800; letter-spacing: -1px; color: var(--text-color); }
        
        .admin-badge { background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; border: 1px solid rgba(239, 68, 68, 0.2); display: flex; align-items: center; gap: 6px; }
        .server-status { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); }
        .pulse-dot { width: 10px; height: 10px; background: #10b981; border-radius: 50%; box-shadow: 0 0 10px #10b981; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }

        /* --- 4. KPI DASHBOARD --- */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .kpi-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.02); transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--card-accent, #3b82f6); }
        
        .kpi-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; letter-spacing: 1px; margin-bottom: 10px; display: block; }
        .kpi-val { font-size: 2.8rem; font-weight: 800; color: var(--text-color); margin: 0; font-family: 'Fira Code', monospace; line-height: 1; }
        .kpi-icon { position: absolute; right: 25px; top: 25px; font-size: 2.5rem; color: var(--border-color); opacity: 0.5; }

        /* --- 5. ENTERPRISE PANELS & TABLES --- */
        .admin-section { display: none; animation: fadeIn 0.3s ease-out; }
        .admin-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .section-box { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .section-title { font-size: 1.3rem; font-weight: 800; color: var(--text-color); display: flex; align-items: center; gap: 12px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }

        .admin-table { width: 100%; border-collapse: collapse; text-align: left; }
        .admin-table th { padding: 15px 20px; font-size: 0.8rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; letter-spacing: 1px; border-bottom: 2px solid var(--border-color); background: var(--input-bg); white-space: nowrap; }
        .admin-table td { padding: 16px 20px; border-bottom: 1px solid var(--border-color); font-size: 0.95rem; color: var(--text-color); vertical-align: middle; }
        .admin-table tr:hover td { background: rgba(37, 99, 235, 0.02); }

        /* Buttons & Badges */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        .btn-primary { background: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2); }
        .btn-primary:hover { background: #1d4ed8; transform: translateY(-2px); }
        
        .action-btn { padding: 8px 12px; border-radius: 6px; border: none; font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; }
        .btn-approve { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
        .btn-approve:hover { background: #10b981; color: #fff; }
        .btn-reject { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
        .btn-reject:hover { background: #ef4444; color: #fff; }

        .status-pill { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid transparent; white-space: nowrap; display: inline-block; }
        .status-pending { background: rgba(245, 158, 11, 0.1); color: #d97706; border-color: rgba(245, 158, 11, 0.3); }
        .status-approved { background: rgba(16, 185, 129, 0.1); color: #10b981; border-color: rgba(16, 185, 129, 0.3); }
        
        /* Danger Zone Button */
        .btn-danger-zone { background: repeating-linear-gradient(45deg, #7f1d1d, #7f1d1d 10px, #991b1b 10px, #991b1b 20px); color: white; border: 2px solid #ef4444; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .btn-danger-zone:hover { opacity: 0.9; transform: scale(1.02); }

        /* Search Input */
        .table-search { padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); outline: none; width: 250px; font-size: 0.9rem; }
        .table-search:focus { border-color: var(--primary-color); }

        /* --- 6. BROADCAST ENGINE --- */
        .broadcast-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .b-input, .b-select, .b-textarea { width: 100%; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); font-family: inherit; font-size: 1rem; outline: none; transition: 0.2s; box-sizing: border-box; }
        .b-input:focus, .b-select:focus, .b-textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        /* --- 7. PREMIUM ACTION MODAL --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 6, 23, 0.9); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .modal-content { background: var(--card-bg); padding: 35px; border-radius: 16px; max-width: 450px; width: 90%; text-align: center; border: 1px solid var(--border-color); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-icon { font-size: 3rem; margin-bottom: 15px; }
        .modal-title { margin: 0 0 10px; color: var(--text-color); font-weight: 800; font-size: 1.5rem; }
        .modal-desc { color: var(--text-muted); margin-bottom: 25px; line-height: 1.5; font-size: 0.95rem; }

        /* Danger Input for Wipe */
        #dangerInput { width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 8px; border: 2px dashed #ef4444; background: var(--input-bg); color: var(--text-color); text-align: center; font-weight: 800; font-family: monospace; display: none; }

        /* Mobile adjustments */
        .mobile-menu-btn { display: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color); }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 998; backdrop-filter: blur(3px); }

        @media (max-width: 900px) { 
            .broadcast-grid { grid-template-columns: 1fr; } 
            .mobile-menu-btn { display: block; }
            .sidebar { position: fixed; height: 100%; left: -280px; box-shadow: none; }
            .sidebar.mobile-open { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .sidebar-overlay.mobile-open { display: block; }
            .section-title { flex-direction: column; align-items: stretch; gap: 10px; }
            .table-search { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

    <div id="actionModal" class="modal">
        <div class="modal-content">
            <div id="modalIcon" class="modal-icon"><i class="fas fa-exclamation-circle" style="color: #f59e0b;"></i></div>
            <h2 id="modalTitle" class="modal-title">Confirm Action</h2>
            <p id="modalDesc" class="modal-desc">Are you sure you want to execute this administrative command?</p>
            
            <input type="text" id="dangerInput" placeholder="Type 'DELETE' to confirm">

            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn" style="background: transparent; border: 1px solid var(--border-color); color: var(--text-color);" onclick="closeModal()">Cancel</button>
                <button id="modalConfirmBtn" class="btn" style="background: var(--primary-color); color: white;">Confirm Execute</button>
            </div>
        </div>
    </div>

    <div class="wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-satellite-dish" style="color: #3b82f6;"></i> Command Center
                <i class="fas fa-times mobile-menu-btn" style="margin-left: auto; color: white;" onclick="toggleMobileSidebar()"></i>
            </div>
            <ul class="nav-links">
                <li><a href="#" class="active" onclick="switchTab('dashboard', this)"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li><a href="#" onclick="switchTab('users', this)"><i class="fas fa-users-cog"></i> Global User Matrix</a></li>
                <li><a href="#" onclick="switchTab('leadership', this)"><i class="fas fa-user-tie"></i> Vanguard Vetting</a></li>
                <li><a href="#" onclick="switchTab('broadcast', this)"><i class="fas fa-bullhorn"></i> Broadcast Engine</a></li>
                <li><a href="#" onclick="switchTab('library', this)"><i class="fas fa-book"></i> Library Quarantine</a></li>
                <li><a href="#" onclick="switchTab('reports', this)"><i class="fas fa-ticket-alt"></i> Support Tickets</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="dashboard.html" style="color: #10b981; text-decoration: none; display: flex; align-items: center; gap: 10px; font-weight: 600;"><i class="fas fa-sign-out-alt"></i> Exit to Portal</a>
            </div>
        </aside>

        <main class="main-content">
            <div class="scroll-area">
                
                <header class="header">
                    <div>
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                            <i class="fas fa-bars mobile-menu-btn" onclick="toggleMobileSidebar()"></i>
                            <h1>National Administrator Console</h1>
                        </div>
                        <div class="server-status">
                            <div class="pulse-dot"></div> System Online ‚Ä¢ Encrypted Connection Established
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div class="admin-badge"><i class="fas fa-fingerprint"></i> Root Access</div>
                        <div class="theme-wrapper">
                            <select onchange="setTheme(this.value)" style="padding: 8px 12px; border-radius: 8px; background: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); cursor: pointer; font-weight: 600;">
                                <option value="system">üíª System</option>
                                <option value="light">‚òÄÔ∏è Light Mode</option>
                                <option value="dark">üåô Dark Mode</option>
                            </select>
                        </div>
                    </div>
                </header>

                <div id="panel-dashboard" class="admin-section active">
                    <div class="kpi-grid">
                        <div class="kpi-card" style="--card-accent: #3b82f6;">
                            <i class="fas fa-users kpi-icon"></i>
                            <span class="kpi-label">Registered Students</span>
                            <div class="kpi-val" id="kpi-users">0</div>
                            <div style="font-size: 0.85rem; color: #3b82f6; font-weight: 600; margin-top: 5px;">Verified Accounts</div>
                        </div>
                        <div class="kpi-card" style="--card-accent: #f59e0b;">
                            <i class="fas fa-file-upload kpi-icon"></i>
                            <span class="kpi-label">Library Quarantine</span>
                            <div class="kpi-val" id="kpi-files">0</div>
                            <div style="font-size: 0.85rem; color: #f59e0b; font-weight: 600; margin-top: 5px;">Pending Scans</div>
                        </div>
                        <div class="kpi-card" style="--card-accent: #8b5cf6;">
                            <i class="fas fa-crown kpi-icon"></i>
                            <span class="kpi-label">Vanguard Apps</span>
                            <div class="kpi-val" id="kpi-leaders">0</div>
                            <div style="font-size: 0.85rem; color: #8b5cf6; font-weight: 600; margin-top: 5px;">Awaiting Review</div>
                        </div>
                        <div class="kpi-card" style="--card-accent: #ef4444;">
                            <i class="fas fa-ticket-alt kpi-icon"></i>
                            <span class="kpi-label">Support Tickets</span>
                            <div class="kpi-val" id="kpi-reports">0</div>
                            <div style="font-size: 0.85rem; color: #ef4444; font-weight: 600; margin-top: 5px;">Action Required</div>
                        </div>
                    </div>

                    <div class="section-box">
                        <div class="section-title"><i class="fas fa-bolt" style="color: #eab308;"></i> Quick Executive Actions</div>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="switchTab('broadcast', document.querySelectorAll('.nav-links a')[3])"><i class="fas fa-bullhorn"></i> New Broadcast</button>
                            <button class="btn" style="background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color);" onclick="switchTab('users', document.querySelectorAll('.nav-links a')[1])"><i class="fas fa-search"></i> Find Student</button>
                        </div>
                    </div>
                </div>

                <div id="panel-users" class="admin-section">
                    <div class="section-box">
                        <div class="section-title" style="flex-wrap: wrap; gap: 15px;">
                            <span style="flex: 1;"><i class="fas fa-users-cog" style="color: #3b82f6;"></i> Global User Matrix</span>
                            
                            <input type="text" id="userSearchBox" class="table-search" placeholder="Search ID or Name..." onkeyup="filterUserTable()">
                            
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="loadUsers()"><i class="fas fa-sync"></i> Refresh</button>
                                <button class="btn btn-danger-zone" onclick="triggerWipeModal()"><i class="fas fa-radiation-alt"></i> WIPE DATABASE</button>
                            </div>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table class="admin-table" id="userTable">
                                <thead>
                                    <tr>
                                        <th>Student ID</th>
                                        <th>Full Name</th>
                                        <th>Institution</th>
                                        <th>Status</th>
                                        <th style="text-align: right;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="user-table-body">
                                    <tr><td colspan="5" style="text-align:center;">Fetching secure database...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="panel-leadership" class="admin-section">
                    <div class="section-box">
                        <div class="section-title" style="flex-wrap: wrap;">
                            <span style="flex: 1;"><i class="fas fa-crown" style="color: #8b5cf6;"></i> Vanguard Applications</span>
                            <span class="status-pill status-pending" id="pending-count-badge">0 Pending</span>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Candidate Info</th>
                                        <th>Target Position</th>
                                        <th>Status</th>
                                        <th style="text-align: right;">Executive Decision</th>
                                    </tr>
                                </thead>
                                <tbody id="leadership-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="panel-broadcast" class="admin-section">
                    <div class="section-box">
                        <div class="section-title"><i class="fas fa-broadcast-tower" style="color: #ef4444;"></i> Global Broadcast Engine</div>
                        <div class="broadcast-grid">
                            <form class="broadcast-form" onsubmit="event.preventDefault(); sendBroadcast();">
                                <div class="input-group">
                                    <label>Broadcast Headline</label>
                                    <input type="text" id="b-title" class="b-input" placeholder="e.g. Mandatory SRC Townhall Meeting" required>
                                </div>
                                <div class="input-group">
                                    <label>Priority Classification</label>
                                    <select id="b-category" class="b-select">
                                        <option value="General">General News (Blue)</option>
                                        <option value="Urgent">üö® Urgent Alert (Red)</option>
                                        <option value="Academic">Academic Update (Green)</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label>Official Message Body</label>
                                    <textarea id="b-msg" class="b-textarea" rows="6" placeholder="Type the official announcement. This will be pushed to the Dashboard and pinned to the General Chat Hub..." required></textarea>
                                </div>
                                <button type="submit" id="b-submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 1.1rem;"><i class="fas fa-satellite-dish"></i> Transmit to National Network</button>
                            </form>

                            <div style="background: var(--input-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--border-color);">
                                <h4 style="margin-top: 0; color: var(--text-color); font-size: 1.1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Transmission History</h4>
                                <div id="news-history-list" style="max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-right: 5px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="panel-library" class="admin-section">
                    <div class="section-box">
                        <div class="section-title" style="flex-wrap: wrap;">
                            <span style="flex: 1;"><i class="fas fa-shield-alt" style="color: #f59e0b;"></i> Document Quarantine & Vetting</span>
                            <button class="btn btn-primary btn-sm" style="padding: 10px 15px;" onclick="loadResources()"><i class="fas fa-sync"></i> Scan Database</button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Date Submitted</th>
                                        <th>Document Title</th>
                                        <th>Category</th>
                                        <th>Status</th>
                                        <th style="text-align: right;">Moderation Action</th>
                                    </tr>
                                </thead>
                                <tbody id="resource-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="panel-reports" class="admin-section">
                    <div class="section-box">
                        <div class="section-title"><i class="fas fa-ticket-alt" style="color: #ef4444;"></i> IT Support & Reports</div>
                        <div style="overflow-x: auto;">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>User Account</th>
                                        <th>Issue Description</th>
                                        <th>Log Date</th>
                                        <th style="text-align: right;">Status / Action</th>
                                    </tr>
                                </thead>
                                <tbody id="reports-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        let currentActionUrl = null;
        let currentActionMethod = 'POST';
        let currentActionPayload = null;
        let currentActionCallback = null;

        // --- AUTH & INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const role = localStorage.getItem('portal-user-role');
            if (role !== 'ADMIN') {
                alert("SECURITY ALERT: Root Access Denied.");
                window.location.href = 'login.html';
                return;
            }
            initDashboard();
        });

        function initDashboard() {
            loadUsers();
            loadLeadership();
            loadNews();
            loadResources();
            loadReports();
        }

        // --- UI TOGGLES ---
        function toggleMobileSidebar() {
            document.querySelector('.sidebar').classList.toggle('mobile-open');
            document.querySelector('.sidebar-overlay').classList.toggle('mobile-open');
        }

        function switchTab(tabId, element) {
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`panel-${tabId}`).classList.add('active');
            
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            if(element) element.classList.add('active');

            if(tabId === 'users') loadUsers();
            if(tabId === 'library') loadResources();
        }

        // --- 1. GLOBAL USER MATRIX ---
        async function loadUsers() {
            const tbody = document.getElementById('user-table-body');
            try {
                const res = await fetch('/api/admin/users'); 
                const users = await res.json(); 
                
                tbody.innerHTML = '';
                let studentCount = 0;

                users.forEach(u => {
                    if(u.role === 'ADMIN') return;
                    studentCount++;
                    const idTag = u.id ? `102${u.id}09` : 'PENDING';
                    
                    tbody.innerHTML += `
                        <tr class="user-row">
                            <td style="font-family: 'Fira Code', monospace; color: var(--primary-color); font-weight: 600;">#${idTag}</td>
                            <td><strong style="color: var(--text-color); font-size: 1.05rem;" class="u-name">${u.name}</strong><br><small style="color: var(--text-muted);">${u.email || 'No email linked'}</small></td>
                            <td class="u-inst">${u.institution || 'National DB'}</td>
                            <td><span class="status-pill status-approved">Verified User</span></td>
                            <td style="text-align: right;">
                                <button class="action-btn btn-reject" title="Terminate Account" onclick="triggerDeleteUser(${u.id})"><i class="fas fa-trash"></i> Drop User</button>
                            </td>
                        </tr>
                    `;
                });
                document.getElementById('kpi-users').innerText = studentCount;

            } catch(e) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Database connection failed.</td></tr>`;
            }
        }

        function filterUserTable() {
            const input = document.getElementById('userSearchBox').value.toLowerCase();
            const rows = document.querySelectorAll('.user-row');
            rows.forEach(row => {
                const name = row.querySelector('.u-name').innerText.toLowerCase();
                const inst = row.querySelector('.u-inst').innerText.toLowerCase();
                row.style.display = (name.includes(input) || inst.includes(input)) ? '' : 'none';
            });
        }

        // --- 2. LEADERSHIP VANGUARD ---
        async function loadLeadership() {
            try {
                const res = await fetch('/api/admin/leadership-apps');
                const apps = await res.json();
                
                const pendingCount = apps.filter(a => a.status === 'PENDING').length;
                document.getElementById('kpi-leaders').innerText = pendingCount;
                document.getElementById('pending-count-badge').innerText = `${pendingCount} Pending`;

                const tbody = document.getElementById('leadership-table-body');
                tbody.innerHTML = '';
                
                if(apps.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:var(--text-muted);">No vanguard applications in queue.</td></tr>`;
                    return;
                }

                apps.forEach(app => {
                    let actions = '';
                    if(app.status === 'PENDING') {
                        actions = `
                            <button class="action-btn btn-approve" onclick="triggerReviewApp(${app.id}, 'APPROVED')"><i class="fas fa-check"></i> Induct</button>
                            <button class="action-btn btn-reject" onclick="triggerReviewApp(${app.id}, 'REJECTED')"><i class="fas fa-times"></i> Reject</button>
                        `;
                    } else {
                        actions = `<span style="color:var(--text-muted); font-size:0.85rem; font-weight: 600;"><i class="fas fa-lock"></i> Decision Locked</span>`;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td>
                                <strong style="color: var(--text-color); font-size: 1.05rem;">${app.name}</strong><br>
                                <small style="color:var(--text-muted);">${app.institution}</small>
                            </td>
                            <td>
                                <span style="color:var(--primary-color); font-weight:700;">${app.position}</span><br>
                                <small style="font-style: italic;">"${app.vision.substring(0, 45)}..."</small>
                            </td>
                            <td><span class="status-pill status-${app.status.toLowerCase()}">${app.status}</span></td>
                            <td style="text-align:right;">${actions}</td>
                        </tr>
                    `;
                });
            } catch(e) {}
        }

        // --- 3. LIBRARY MODERATION ---
        async function loadResources() { 
            try {
                const res = await fetch('/api/admin/pending-resources');
                const data = await res.json();
                
                const pendingCount = data.filter(r => r.status === 'PENDING').length;
                document.getElementById('kpi-files').innerText = pendingCount;

                const tbody = document.getElementById('resource-table-body');
                tbody.innerHTML = '';
                
                if(data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: var(--text-muted);">Database Quarantine is empty.</td></tr>`;
                    return;
                }

                data.forEach(item => {
                    let actions = '';
                    if(item.status === 'PENDING') {
                        actions = `
                            <button class="action-btn btn-approve" onclick="triggerReviewResource(${item.id}, 'APPROVED')"><i class="fas fa-check"></i> Authorize</button>
                            <button class="action-btn btn-reject" onclick="triggerReviewResource(${item.id}, 'REJECTED')"><i class="fas fa-times"></i> Purge</button>
                        `;
                    } else {
                        actions = `<button class="action-btn btn-reject" onclick="triggerReviewResource(${item.id}, 'REJECTED')"><i class="fas fa-trash"></i> Delete Record</button>`;
                    }

                    let icon = 'fa-file-alt'; let color = '#3b82f6';
                    if(item.category === 'BOOK') { icon = 'fa-book'; color = '#10b981'; }
                    if(item.category === 'PAST_QUESTION') { icon = 'fa-file-signature'; color = '#ef4444'; }

                    tbody.innerHTML += `
                        <tr>
                            <td style="font-size: 0.85rem; color: var(--text-muted);">${new Date(item.date).toLocaleDateString()}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fas ${icon}" style="color: ${color}; font-size: 1.2rem;"></i>
                                    <div>
                                        <strong style="color: var(--text-color);">${item.title}</strong><br>
                                        <small style="color: var(--text-muted);">By: ${item.uploaded_by || 'System'}</small>
                                    </div>
                                </div>
                            </td>
                            <td><span class="status-pill" style="background: var(--input-bg); color: var(--text-muted); border: 1px solid var(--border-color);">${item.category}</span></td>
                            <td><span class="status-pill status-${item.status.toLowerCase()}">${item.status}</span></td>
                            <td style="text-align:right;">${actions}</td>
                        </tr>
                    `;
                });
            } catch(e) { console.error(e); }
        }

        // --- 4. BROADCAST ENGINE ---
        async function sendBroadcast() {
            const btn = document.getElementById('b-submit');
            const title = document.getElementById('b-title').value;
            const category = document.getElementById('b-category').value;
            const msg = document.getElementById('b-msg').value;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Transmitting...';
            btn.disabled = true;

            try {
                await fetch('/api/news', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, message: msg, category })
                });

                await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_name: 'System Admin', message: `üì¢ [${category.toUpperCase()}] ${title}: ${msg}` })
                });

                btn.innerHTML = '<i class="fas fa-check-circle"></i> Transmitted';
                btn.style.background = '#10b981';

                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-satellite-dish"></i> Transmit to National Network';
                    btn.style.background = 'var(--primary-color)';
                    btn.disabled = false;
                    document.querySelector('.broadcast-form').reset();
                    loadNews();
                }, 2500);

            } catch(e) {
                alert("Transmission failed. Database connection lost.");
                btn.innerHTML = '<i class="fas fa-satellite-dish"></i> Transmit to National Network';
                btn.disabled = false;
            }
        }

        async function loadNews() {
            const res = await fetch('/api/news');
            const news = await res.json();
            const list = document.getElementById('news-history-list');
            list.innerHTML = '';
            
            news.forEach(n => {
                list.innerHTML += `
                    <div style="background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 700; color: var(--text-color); font-size: 0.95rem;">${n.title}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">${new Date(n.date).toLocaleDateString()} ‚Ä¢ ${n.category || 'General'}</div>
                        </div>
                        <button class="action-btn btn-reject" onclick="triggerDeleteNews(${n.id})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            });
        }

        // --- 5. SUPPORT TICKETS ---
        async function loadReports() { 
            try {
                const res = await fetch('/api/admin/reports');
                const data = await res.json();
                document.getElementById('kpi-reports').innerText = data.length;
                
                const tbody = document.getElementById('reports-table-body');
                tbody.innerHTML = '';

                if(data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color: var(--text-muted);">No active support tickets.</td></tr>`;
                    return;
                }

                data.forEach(r => {
                    tbody.innerHTML += `
                        <tr>
                            <td><strong style="color: var(--text-color);">${r.user_name}</strong></td>
                            <td style="color: var(--text-muted);">${r.message}</td>
                            <td style="font-size: 0.85rem;">${new Date(r.date).toLocaleDateString()}</td>
                            <td style="text-align:right;"><button class="action-btn btn-approve" onclick="triggerResolveTicket(${r.id})"><i class="fas fa-check-double"></i> Resolve</button></td>
                        </tr>
                    `;
                });
            } catch(e) {}
        }


        // =========================================================================
        // üî• THE PREMIUM UNIVERSAL ACTION MODAL ENGINE
        // =========================================================================

        function openModal(title, desc, iconHtml, btnText, btnColor, url, method, payload, callback) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalDesc').innerText = desc;
            document.getElementById('modalIcon').innerHTML = iconHtml;
            
            const btn = document.getElementById('modalConfirmBtn');
            btn.innerText = btnText;
            btn.style.background = btnColor;

            // Danger input logic
            const dangerInput = document.getElementById('dangerInput');
            if(title.includes('WIPE')) {
                dangerInput.style.display = 'block';
                dangerInput.value = '';
            } else {
                dangerInput.style.display = 'none';
            }

            currentActionUrl = url;
            currentActionMethod = method;
            currentActionPayload = payload;
            currentActionCallback = callback;

            document.getElementById('actionModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('actionModal').style.display = 'none';
        }

        document.getElementById('modalConfirmBtn').addEventListener('click', async function() {
            // Safety check for wipe
            if (document.getElementById('dangerInput').style.display === 'block') {
                if (document.getElementById('dangerInput').value !== 'DELETE') {
                    alert("Verification failed. You must type 'DELETE' to proceed.");
                    return;
                }
            }

            const originalText = this.innerText;
            this.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Executing...';
            this.disabled = true;

            try {
                const options = { method: currentActionMethod };
                if(currentActionPayload) {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = JSON.stringify(currentActionPayload);
                }

                const res = await fetch(currentActionUrl, options);
                
                if(res.ok) {
                    this.innerHTML = '<i class="fas fa-check"></i> Success';
                    
                    // --- üî• FIX: Trigger WhatsApp Link Alert if Vanguard is Approved
                    if (currentActionUrl === '/api/admin/leadership-review' && currentActionPayload.status === 'APPROVED') {
                        setTimeout(() => {
                            alert("Vanguard Student Approved!\n\nPlease send them this secure invite link to join the leadership hub:\n\nhttps://chat.whatsapp.com/IYFaOYoyrnmGhiZN80LC0K");
                        }, 500);
                    }

                    setTimeout(() => {
                        closeModal();
                        if(currentActionCallback) currentActionCallback();
                        initDashboard(); // Update KPIs
                        this.disabled = false;
                    }, 1000);
                } else { throw new Error(); }
            } catch (e) {
                alert('Database Execution Failed.');
                this.innerHTML = originalText;
                this.disabled = false;
            }
        });

        // Modal Triggers
        function triggerDeleteUser(id) {
            openModal('Terminate Account', 'Are you sure you want to permanently delete this user from the National Database?', '<i class="fas fa-user-times" style="color: #ef4444;"></i>', 'Delete User', '#ef4444', `/api/admin/delete-user/${id}`, 'DELETE', null, loadUsers);
        }

        function triggerReviewApp(id, status) {
            if(status === 'APPROVED') {
                openModal('Authorize Verification', 'This will permanently approve the user into the Leadership Vanguard. Proceed?', '<i class="fas fa-medal" style="color: #10b981;"></i>', 'Authorize', '#10b981', '/api/admin/leadership-review', 'POST', {id, status}, loadLeadership);
            } else {
                openModal('Reject Dossier', 'This will permanently deny the leadership application. Proceed?', '<i class="fas fa-times-circle" style="color: #ef4444;"></i>', 'Deny Application', '#ef4444', '/api/admin/leadership-review', 'POST', {id, status}, loadLeadership);
            }
        }

        function triggerReviewResource(id, status) {
            if(status === 'APPROVED') {
                openModal('Approve Document', 'This document will be made visible to all students in the National Library. Proceed?', '<i class="fas fa-book-open" style="color: #10b981;"></i>', 'Approve Upload', '#10b981', '/api/admin/resource-review', 'POST', {id, status}, loadResources);
            } else {
                openModal('Purge Document', 'This document will be rejected and deleted from the queue. Proceed?', '<i class="fas fa-trash-alt" style="color: #ef4444;"></i>', 'Purge File', '#ef4444', '/api/admin/resource-review', 'POST', {id, status}, loadResources);
            }
        }

        function triggerDeleteNews(id) {
            openModal('Delete Broadcast', 'Remove this official announcement from the network history?', '<i class="fas fa-broadcast-tower" style="color: #ef4444;"></i>', 'Delete Broadcast', '#ef4444', `/api/news/${id}`, 'DELETE', null, loadNews);
        }

        function triggerResolveTicket(id) {
            openModal('Resolve Ticket', 'Mark this IT support ticket as resolved and close the case?', '<i class="fas fa-check-double" style="color: #10b981;"></i>', 'Resolve', '#10b981', `/api/admin/reports/${id}`, 'DELETE', null, loadReports);
        }

        function triggerWipeModal() {
            openModal('SYSTEM WIPE', 'CRITICAL WARNING: This will delete ALL student accounts and reset the database. This cannot be undone.', '<i class="fas fa-radiation-alt" style="color: #ef4444;"></i>', 'EXECUTE WIPE', '#ef4444', '/api/admin/reset-system', 'DELETE', null, loadUsers);
        }

    </script>
</body>
</html>