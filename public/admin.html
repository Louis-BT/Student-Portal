<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Command Center | National Portal</title>
    
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="theme.js"></script>

    <style>
        /* --- 1. CORE LAYOUT --- */
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; }
        .wrapper { display: flex; width: 100%; height: 100%; }

        /* --- 2. COMMAND CENTER SIDEBAR (Strict Dark Mode) --- */
        .sidebar { width: 280px; background: #0f172a; border-right: 1px solid #1e293b; display: flex; flex-direction: column; flex-shrink: 0; color: white; }
        .sidebar-header { padding: 25px; font-weight: 800; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 12px; font-size: 1.2rem; letter-spacing: -0.5px; }
        
        .nav-links { list-style: none; padding: 20px 0; margin: 0; flex: 1; overflow-y: auto; }
        .nav-links li { margin-bottom: 5px; padding: 0 15px; }
        .nav-links a { display: flex; align-items: center; gap: 15px; color: #94a3b8; text-decoration: none; padding: 14px 18px; border-radius: 8px; transition: all 0.2s ease; font-weight: 600; font-size: 0.95rem; border-left: 3px solid transparent; }
        .nav-links a:hover, .nav-links a.active { background: rgba(255,255,255,0.05); color: #f8fafc; border-left: 3px solid #3b82f6; }
        .nav-links a.active i { color: #3b82f6; }
        
        .sidebar-footer { padding: 20px 25px; border-top: 1px solid rgba(255,255,255,0.05); }

        /* --- 3. MAIN CONTENT & HEADER --- */
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg-color); position: relative; }
        .scroll-area { flex: 1; padding: 40px; overflow-y: auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .header h1 { margin: 0; font-size: 2rem; font-weight: 800; letter-spacing: -1px; color: var(--text-color); }
        
        .admin-badge { background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; border: 1px solid rgba(239, 68, 68, 0.2); display: flex; align-items: center; gap: 6px; }
        .server-status { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); }
        .pulse-dot { width: 10px; height: 10px; background: #10b981; border-radius: 50%; box-shadow: 0 0 10px #10b981; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }

        /* --- 4. KPI DASHBOARD --- */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .kpi-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.02); transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--card-accent, #3b82f6); }
        
        .kpi-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; letter-spacing: 1px; margin-bottom: 10px; display: block; }
        .kpi-val { font-size: 2.8rem; font-weight: 800; color: var(--text-color); margin: 0; font-family: 'Fira Code', monospace; line-height: 1; }
        .kpi-icon { position: absolute; right: 25px; top: 25px; font-size: 2.5rem; color: var(--border-color); opacity: 0.5; }

        /* --- 5. ENTERPRISE PANELS & TABLES --- */
        .admin-section { display: none; animation: fadeIn 0.3s ease-out; }
        .admin-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .section-box { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .section-title { font-size: 1.3rem; font-weight: 800; color: var(--text-color); display: flex; align-items: center; gap: 12px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }

        .admin-table { width: 100%; border-collapse: collapse; text-align: left; }
        .admin-table th { padding: 15px 20px; font-size: 0.8rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; letter-spacing: 1px; border-bottom: 2px solid var(--border-color); background: var(--input-bg); }
        .admin-table td { padding: 16px 20px; border-bottom: 1px solid var(--border-color); font-size: 0.95rem; color: var(--text-color); vertical-align: middle; }
        .admin-table tr:hover td { background: rgba(37, 99, 235, 0.02); }

        /* Buttons & Badges */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        .btn-primary { background: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2); }
        .btn-primary:hover { background: #1d4ed8; transform: translateY(-2px); }
        
        .action-btn { padding: 8px 12px; border-radius: 6px; border: none; font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-approve { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
        .btn-approve:hover { background: #10b981; color: #fff; }
        .btn-reject { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
        .btn-reject:hover { background: #ef4444; color: #fff; }

        .status-pill { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid transparent; }
        .status-pending { background: rgba(245, 158, 11, 0.1); color: #d97706; border-color: rgba(245, 158, 11, 0.3); }
        .status-approved { background: rgba(16, 185, 129, 0.1); color: #10b981; border-color: rgba(16, 185, 129, 0.3); }
        
        /* Danger Zone Button */
        .btn-danger-zone { background: repeating-linear-gradient(45deg, #7f1d1d, #7f1d1d 10px, #991b1b 10px, #991b1b 20px); color: white; border: 2px solid #ef4444; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .btn-danger-zone:hover { opacity: 0.9; transform: scale(1.02); }

        /* Search Input */
        .table-search { padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); outline: none; width: 250px; font-size: 0.9rem; }
        .table-search:focus { border-color: var(--primary-color); }

        /* --- 6. BROADCAST ENGINE --- */
        .broadcast-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .b-input, .b-select, .b-textarea { width: 100%; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); font-family: inherit; font-size: 1rem; outline: none; transition: 0.2s; box-sizing: border-box; }
        .b-input:focus, .b-select:focus, .b-textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        @media (max-width: 900px) { .broadcast-grid { grid-template-columns: 1fr; } .sidebar { display: none; } }
    </style>
</head>
<body>

    <div class="wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-satellite-dish" style="color: #3b82f6;"></i> Command Center
            </div>
            <ul class="nav-links">
                <li><a href="#" class="active" onclick="switchTab('dashboard', this)"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li><a href="#" onclick="switchTab('users', this)"><i class="fas fa-users-cog"></i> Global User Matrix</a></li>
                <li><a href="#" onclick="switchTab('leadership', this)"><i class="fas fa-user-tie"></i> Vanguard Vetting</a></li>
                <li><a href="#" onclick="switchTab('broadcast', this)"><i class="fas fa-bullhorn"></i> Broadcast Engine</a></li>
                <li><a href="#" onclick="switchTab('library', this)"><i class="fas fa-book"></i> Library Quarantine</a></li>
                <li><a href="#" onclick="switchTab('reports', this)"><i class="fas fa-ticket-alt"></i> Support Tickets</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="dashboard.html" style="color: #10b981; text-decoration: none; display: flex; align-items: center; gap: 10px; font-weight: 600;"><i class="fas fa-sign-out-alt"></i> Exit to Portal</a>
            </div>
        </aside>

        <main class="main-content">
            <div class="scroll-area">
                
                <header class="header">
                    <div>
                        <h1>National Administrator Console</h1>
                        <div class="server-status" style="margin-top: 8px;">
                            <div class="pulse-dot"></div> System Online ‚Ä¢ Encrypted Connection Established
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div class="admin-badge"><i class="fas fa-fingerprint"></i> Root Access</div>
                        <div class="theme-wrapper">
                            <select onchange="setTheme(this.value)" style="padding: 8px 12px; border-radius: 8px; background: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); cursor: pointer; font-weight: 600;">
                                <option value="system">üíª System</option>
                                <option value="light">‚òÄÔ∏è Light Mode</option>
                                <option value="dark">üåô Dark Mode</option>
                            </select>
                        </div>
                    </div>
                </header>

                <div id="panel-dashboard" class="admin-section active">
                    <div class="kpi-grid">
                        <div class="kpi-card" style="--card-accent: #3b82f6;">
                            <i class="fas fa-users kpi-icon"></i>
                            <span class="kpi-label">Registered Students</span>
                            <div class="kpi-val" id="kpi-users">0</div>
                            <div style="font-size: 0.85rem; color: #3b82f6; font-weight: 600; margin-top: 5px;">Verified Accounts</div>
                        </div>
                        <div class="kpi-card" style="--card-accent: #f59e0b;">
                            <i class="fas fa-file-upload kpi-icon"></i>
                            <span class="kpi-label">Library Quarantine</span>
                            <div class="kpi-val" id="kpi-files">0</div>
                            <div style="font-size: 0.85rem; color: #f59e0b; font-weight: 600; margin-top: 5px;">Pending Scans</div>
                        </div>
                        <div class="kpi-card" style="--card-accent: #8b5cf6;">
                            <i class="fas fa-crown kpi-icon"></i>
                            <span class="kpi-label">Vanguard Apps</span>
                            <div class="kpi-val" id="kpi-leaders">0</div>
                            <div style="font-size: 0.85rem; color: #8b5cf6; font-weight: 600; margin-top: 5px;">Awaiting Review</div>
                        </div>
                        <div class="kpi-card" style="--card-accent: #ef4444;">
                            <i class="fas fa-ticket-alt kpi-icon"></i>
                            <span class="kpi-label">Support Tickets</span>
                            <div class="kpi-val" id="kpi-reports">0</div>
                            <div style="font-size: 0.85rem; color: #ef4444; font-weight: 600; margin-top: 5px;">Action Required</div>
                        </div>
                    </div>

                    <div class="section-box">
                        <div class="section-title"><i class="fas fa-bolt" style="color: #eab308;"></i> Quick Executive Actions</div>
                        <div style="display: flex; gap: 15px;">
                            <button class="btn btn-primary" onclick="switchTab('broadcast', document.querySelectorAll('.nav-links a')[3])"><i class="fas fa-bullhorn"></i> New Broadcast</button>
                            <button class="btn" style="background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color);" onclick="switchTab('users', document.querySelectorAll('.nav-links a')[1])"><i class="fas fa-search"></i> Find Student</button>
                        </div>
                    </div>
                </div>

                <div id="panel-users" class="admin-section">
                    <div class="section-box">
                        <div class="section-title">
                            <span style="flex: 1;"><i class="fas fa-users-cog" style="color: #3b82f6;"></i> Global User Matrix</span>
                            
                            <input type="text" id="userSearchBox" class="table-search" placeholder="Search ID or Name..." onkeyup="filterUserTable()">
                            
                            <div style="margin-left: 15px; display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="loadUsers()"><i class="fas fa-sync"></i> Refresh</button>
                                <button class="btn btn-danger-zone" onclick="systemReset()"><i class="fas fa-radiation-alt"></i> WIPE ALL STUDENTS</button>
                            </div>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table class="admin-table" id="userTable">
                                <thead>
                                    <tr>
                                        <th>Student ID</th>
                                        <th>Full Name</th>
                                        <th>Institution</th>
                                        <th>Status</th>
                                        <th style="text-align: right;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="user-table-body">
                                    <tr><td colspan="5" style="text-align:center;">Fetching secure database...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="panel-leadership" class="admin-section">
                    <div class="section-box">
                        <div class="section-title">
                            <span><i class="fas fa-crown" style="color: #8b5cf6;"></i> Vanguard Applications</span>
                            <span class="status-pill status-pending" id="pending-count-badge" style="margin-left:auto;">0 Pending</span>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Candidate Info</th>
                                        <th>Target Position</th>
                                        <th>Status</th>
                                        <th style="text-align: right;">Executive Decision</th>
                                    </tr>
                                </thead>
                                <tbody id="leadership-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="panel-broadcast" class="admin-section">
                    <div class="section-box">
                        <div class="section-title"><i class="fas fa-broadcast-tower" style="color: #ef4444;"></i> Global Broadcast Engine</div>
                        <div class="broadcast-grid">
                            <form class="broadcast-form" onsubmit="event.preventDefault(); sendBroadcast();">
                                <div class="input-group">
                                    <label>Broadcast Headline</label>
                                    <input type="text" id="b-title" class="b-input" placeholder="e.g. Mandatory SRC Townhall Meeting" required>
                                </div>
                                <div class="input-group">
                                    <label>Priority Classification</label>
                                    <select id="b-category" class="b-select">
                                        <option value="General">General News (Blue)</option>
                                        <option value="Urgent">üö® Urgent Alert (Red)</option>
                                        <option value="Academic">Academic Update (Green)</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label>Official Message Body</label>
                                    <textarea id="b-msg" class="b-textarea" rows="6" placeholder="Type the official announcement. This will be pushed to the Dashboard and pinned to the General Chat Hub..." required></textarea>
                                </div>
                                <button type="submit" id="b-submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 1.1rem;"><i class="fas fa-satellite-dish"></i> Transmit to National Network</button>
                            </form>

                            <div style="background: var(--input-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--border-color);">
                                <h4 style="margin-top: 0; color: var(--text-color); font-size: 1.1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Transmission History</h4>
                                <div id="news-history-list" style="max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-right: 5px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="panel-library" class="admin-section">
                    <div class="section-box">
                        <div class="section-title">
                            <span><i class="fas fa-shield-alt" style="color: #f59e0b;"></i> Document Quarantine & Vetting</span>
                            <button class="btn btn-primary btn-sm" style="margin-left: auto;" onclick="loadResources()"><i class="fas fa-sync"></i> Scan Database</button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Date Submitted</th>
                                        <th>Document Title</th>
                                        <th>Category</th>
                                        <th>Status</th>
                                        <th style="text-align: right;">Moderation Action</th>
                                    </tr>
                                </thead>
                                <tbody id="resource-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="panel-reports" class="admin-section">
                    <div class="section-box">
                        <div class="section-title"><i class="fas fa-ticket-alt" style="color: #ef4444;"></i> IT Support & Reports</div>
                        <div style="overflow-x: auto;">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>User Account</th>
                                        <th>Issue Description</th>
                                        <th>Log Date</th>
                                        <th style="text-align: right;">Status / Action</th>
                                    </tr>
                                </thead>
                                <tbody id="reports-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        // --- AUTH CHECK ---
        document.addEventListener('DOMContentLoaded', () => {
            const role = localStorage.getItem('portal-user-role');
            if (role !== 'ADMIN') {
                alert("SECURITY ALERT: Root Access Denied.");
                window.location.href = 'login.html';
                return;
            }
            initDashboard();
        });

        // --- CORE INITIALIZATION ---
        function initDashboard() {
            loadUsers();
            loadLeadership();
            loadNews();
            loadResources();
            loadReports();
        }

        // --- TAB SWITCHER ---
        function switchTab(tabId, element) {
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`panel-${tabId}`).classList.add('active');
            
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            if(element) element.classList.add('active');

            if(tabId === 'users') loadUsers();
            if(tabId === 'library') loadResources();
        }

        // --- 1. USERS MODULE ---
        async function loadUsers() {
            const tbody = document.getElementById('user-table-body');
            try {
                const res = await fetch('/api/admin/users'); 
                const users = await res.json(); 
                
                tbody.innerHTML = '';
                let studentCount = 0;

                users.forEach(u => {
                    if(u.role === 'ADMIN') return;
                    studentCount++;
                    
                    const idTag = u.id ? `102${u.id}09` : 'PENDING';
                    
                    tbody.innerHTML += `
                        <tr class="user-row">
                            <td style="font-family: 'Fira Code', monospace; color: var(--primary-color); font-weight: 600;">#${idTag}</td>
                            <td><strong style="color: var(--text-color); font-size: 1.05rem;" class="u-name">${u.name}</strong><br><small style="color: var(--text-muted);">${u.email || 'No email linked'}</small></td>
                            <td class="u-inst">${u.institution || 'National DB'}</td>
                            <td><span class="status-pill status-approved">Verified User</span></td>
                            <td style="text-align: right;">
                                <button class="action-btn btn-reject" title="Terminate Account" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i> Drop User</button>
                            </td>
                        </tr>
                    `;
                });

                document.getElementById('kpi-users').innerText = studentCount;

            } catch(e) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Database connection failed.</td></tr>`;
            }
        }

        // Premium Frontend Filtering
        function filterUserTable() {
            const input = document.getElementById('userSearchBox').value.toLowerCase();
            const rows = document.querySelectorAll('.user-row');
            
            rows.forEach(row => {
                const name = row.querySelector('.u-name').innerText.toLowerCase();
                const inst = row.querySelector('.u-inst').innerText.toLowerCase();
                if (name.includes(input) || inst.includes(input)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        async function deleteUser(id) {
            if(!confirm("‚ö†Ô∏è WARNING: Permanently delete this user from the National Database?")) return;
            await fetch(`/api/admin/delete-user/${id}`, { method: 'DELETE' });
            loadUsers();
        }

        // DANGER ZONE
        async function systemReset() {
            if(!confirm("‚ö†Ô∏è CRITICAL WARNING ‚ö†Ô∏è\n\nThis will DELETE ALL STUDENT ACCOUNTS and reset the database.\n\nThis action cannot be undone. Proceed?")) return;
            
            const verify = prompt("To confirm destruction, type 'DELETE' below:");
            if(verify !== 'DELETE') return alert("Action Aborted.");

            try {
                const res = await fetch('/api/admin/reset-system', { method: 'DELETE' });
                const data = await res.json();
                
                if(data.success) {
                    alert("‚úÖ System Reset Complete. Database wiped.");
                    loadUsers(); 
                    document.getElementById('kpi-users').innerText = "0"; 
                } else {
                    alert("Error: " + data.error);
                }
            } catch (e) { alert("Server Error: Could not execute reset protocol."); }
        }

        // --- 2. LEADERSHIP MODULE ---
        async function loadLeadership() {
            try {
                const res = await fetch('/api/admin/leadership-apps');
                const apps = await res.json();
                
                const pendingCount = apps.filter(a => a.status === 'PENDING').length;
                document.getElementById('kpi-leaders').innerText = pendingCount;
                document.getElementById('pending-count-badge').innerText = `${pendingCount} Pending`;

                const tbody = document.getElementById('leadership-table-body');
                tbody.innerHTML = '';
                
                if(apps.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:var(--text-muted);">No vanguard applications in queue.</td></tr>`;
                    return;
                }

                apps.forEach(app => {
                    let actions = '';
                    if(app.status === 'PENDING') {
                        actions = `
                            <button class="action-btn btn-approve" onclick="reviewApp(${app.id}, ${app.user_id}, 'APPROVED')"><i class="fas fa-check"></i> Induct</button>
                            <button class="action-btn btn-reject" onclick="reviewApp(${app.id}, ${app.user_id}, 'REJECTED')"><i class="fas fa-times"></i> Reject</button>
                        `;
                    } else {
                        actions = `<span style="color:var(--text-muted); font-size:0.85rem; font-weight: 600;"><i class="fas fa-lock"></i> Decision Locked</span>`;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td>
                                <strong style="color: var(--text-color); font-size: 1.05rem;">${app.name}</strong><br>
                                <small style="color:var(--text-muted);">${app.institution}</small>
                            </td>
                            <td>
                                <span style="color:var(--primary-color); font-weight:700;">${app.position}</span><br>
                                <small style="font-style: italic;">"${app.vision.substring(0, 45)}..."</small>
                            </td>
                            <td><span class="status-pill status-${app.status.toLowerCase()}">${app.status}</span></td>
                            <td style="text-align:right;">${actions}</td>
                        </tr>
                    `;
                });
            } catch(e) {}
        }

        async function reviewApp(id, userId, status) {
            await fetch('/api/admin/leadership-review', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, user_id: userId, status })
            });
            loadLeadership();
        }

        // --- 3. DUAL-BROADCAST ENGINE ---
        async function sendBroadcast() {
            const btn = document.getElementById('b-submit');
            const title = document.getElementById('b-title').value;
            const category = document.getElementById('b-category').value;
            const msg = document.getElementById('b-msg').value;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Transmitting...';
            btn.disabled = true;

            try {
                // 1. Send to Dashboard News Feed
                await fetch('/api/news', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, message: msg, category })
                });

                // 2. Send to Global Chat Hub
                await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_name: 'System Admin', message: `üì¢ [${category.toUpperCase()}] ${title}: ${msg}` })
                });

                btn.innerHTML = '<i class="fas fa-check-circle"></i> Transmitted to Network';
                btn.style.background = '#10b981';

                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-satellite-dish"></i> Transmit to National Network';
                    btn.style.background = 'var(--primary-color)';
                    btn.disabled = false;
                    document.querySelector('.broadcast-form').reset();
                    loadNews();
                }, 2500);

            } catch(e) {
                alert("Transmission failed. Database connection lost.");
                btn.innerHTML = '<i class="fas fa-satellite-dish"></i> Transmit to National Network';
                btn.disabled = false;
            }
        }

        async function loadNews() {
            const res = await fetch('/api/news');
            const news = await res.json();
            const list = document.getElementById('news-history-list');
            list.innerHTML = '';
            
            news.forEach(n => {
                list.innerHTML += `
                    <div style="background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 700; color: var(--text-color); font-size: 0.95rem;">${n.title}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">${new Date(n.date).toLocaleDateString()} ‚Ä¢ ${n.category || 'General'}</div>
                        </div>
                        <button class="action-btn btn-reject" onclick="deleteNews(${n.id})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            });
        }

        async function deleteNews(id) {
            if(confirm("Delete this broadcast from the network?")) {
                await fetch(`/api/news/${id}`, { method: 'DELETE' });
                loadNews();
            }
        }

        // --- 4. LIBRARY MODERATION ---
        async function loadResources() { 
            try {
                const res = await fetch('/api/admin/pending-resources');
                const data = await res.json();
                
                const pendingCount = data.filter(r => r.status === 'PENDING').length;
                document.getElementById('kpi-files').innerText = pendingCount;

                const tbody = document.getElementById('resource-table-body');
                tbody.innerHTML = '';
                
                if(data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: var(--text-muted);">Database Quarantine is empty.</td></tr>`;
                    return;
                }

                data.forEach(item => {
                    let actions = '';
                    if(item.status === 'PENDING') {
                        actions = `
                            <button class="action-btn btn-approve" onclick="reviewResource(${item.id}, 'APPROVED')"><i class="fas fa-check"></i> Authorize</button>
                            <button class="action-btn btn-reject" onclick="reviewResource(${item.id}, 'REJECTED')"><i class="fas fa-times"></i> Purge</button>
                        `;
                    } else {
                        actions = `<button class="action-btn btn-reject" onclick="reviewResource(${item.id}, 'REJECTED')"><i class="fas fa-trash"></i> Delete Record</button>`;
                    }

                    // Assign icon based on category
                    let icon = 'fa-file-alt'; let color = '#3b82f6';
                    if(item.category === 'BOOK') { icon = 'fa-book'; color = '#10b981'; }
                    if(item.category === 'PAST_QUESTION') { icon = 'fa-file-signature'; color = '#ef4444'; }

                    tbody.innerHTML += `
                        <tr>
                            <td style="font-size: 0.85rem; color: var(--text-muted);">${new Date(item.date).toLocaleDateString()}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fas ${icon}" style="color: ${color}; font-size: 1.2rem;"></i>
                                    <div>
                                        <strong style="color: var(--text-color);">${item.title}</strong><br>
                                        <small style="color: var(--text-muted);">By: ${item.uploaded_by || 'System'}</small>
                                    </div>
                                </div>
                            </td>
                            <td><span class="status-pill" style="background: var(--input-bg); color: var(--text-muted);">${item.category}</span></td>
                            <td><span class="status-pill status-${item.status.toLowerCase()}">${item.status}</span></td>
                            <td style="text-align:right;">${actions}</td>
                        </tr>
                    `;
                });
            } catch(e) { console.error(e); }
        }

        async function reviewResource(id, status) {
            try {
                const res = await fetch('/api/admin/resource-review', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id, status })
                });
                if(res.ok) {
                    loadResources(); 
                    initDashboard(); 
                }
            } catch(e) { alert("Server error updating document status."); }
        }

        // --- 5. SUPPORT TICKETS ---
        async function loadReports() { 
            try {
                const res = await fetch('/api/admin/reports');
                const data = await res.json();
                document.getElementById('kpi-reports').innerText = data.length;
                
                const tbody = document.getElementById('reports-table-body');
                tbody.innerHTML = '';

                if(data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color: var(--text-muted);">No active support tickets.</td></tr>`;
                    return;
                }

                data.forEach(r => {
                    tbody.innerHTML += `
                        <tr>
                            <td><strong style="color: var(--text-color);">${r.user_name}</strong></td>
                            <td style="color: var(--text-muted);">${r.message}</td>
                            <td style="font-size: 0.85rem;">${new Date(r.date).toLocaleDateString()}</td>
                            <td style="text-align:right;"><button class="action-btn btn-approve" onclick="resolveTicket(${r.id})"><i class="fas fa-check-double"></i> Mark Resolved</button></td>
                        </tr>
                    `;
                });
            } catch(e) {}
        }

        async function resolveTicket(id) {
            if(confirm("Mark this system ticket as resolved?")) {
                await fetch(`/api/admin/reports/${id}`, { method: 'DELETE' });
                loadReports();
                initDashboard();
            }
        }
    </script>
</body>
</html>