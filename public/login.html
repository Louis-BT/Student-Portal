<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Login | National Portal</title>
    
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="theme.js"></script>
    
    <link rel="apple-touch-icon" href="icon.png?v=v2">
    <link rel="icon" type="image/png" href="icon.png?v=v2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">

    <style>
        /* --- LAYOUT CONFIGURATION --- */
        body { margin: 0; height: 100vh; overflow: hidden; display: flex; font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-color); }
        .auth-grid { display: grid; grid-template-columns: 1fr 1.2fr; width: 100%; height: 100%; }

        /* BRANDING SIDE */
        .brand-side { background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%); color: white; display: flex; flex-direction: column; justify-content: center; padding: 60px; position: relative; overflow: hidden; }
        .brand-side::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 20px 20px; opacity: 0.3; }
        .brand-content { position: relative; z-index: 2; max-width: 450px; }
        .brand-icon { font-size: 3.5rem; margin-bottom: 25px; display: inline-block; animation: float 6s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        
        .brand-quote { font-size: 2.5rem; font-weight: 800; line-height: 1.2; margin-bottom: 20px; }
        .brand-author { color: #93c5fd; font-size: 1.1rem; font-weight: 500; display: flex; align-items: center; gap: 10px; }
        .brand-author::before { content: ''; display: block; width: 30px; height: 2px; background: #93c5fd; }

        /* FORM SIDE */
        .form-side { background: var(--bg-color); display: flex; align-items: center; justify-content: center; padding: 40px; position: relative; }
        .auth-card { width: 100%; max-width: 400px; animation: fadeUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        h2 { font-size: 2.2rem; margin-bottom: 8px; color: var(--text-color); font-weight: 800; letter-spacing: -0.5px; }
        p.sub-text { color: var(--text-muted); margin-bottom: 30px; font-size: 0.95rem; }

        /* Professional Error Banner */
        .error-message { display: none; background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 14px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; text-align: left; border: 1px solid rgba(239, 68, 68, 0.3); font-weight: 600; display: flex; align-items: center; gap: 10px; }

        /* Input Engineering */
        .input-group { margin-bottom: 20px; position: relative; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color); font-size: 0.9rem; }
        .input-group input { width: 100%; padding: 15px 16px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); font-size: 1rem; font-family: inherit; transition: all 0.3s ease; box-sizing: border-box; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }
        .input-group input:focus { outline: none; border-color: var(--primary-color); background: var(--card-bg); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
        .toggle-password { position: absolute; right: 15px; top: 43px; cursor: pointer; color: var(--text-muted); font-size: 1.1rem; transition: color 0.2s; padding: 5px; }
        .toggle-password:hover { color: var(--primary-color); }

        .form-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; font-size: 0.9rem; }
        .remember-me { display: flex; align-items: center; gap: 8px; color: var(--text-muted); cursor: pointer; font-weight: 500; }
        .forgot-pass { color: var(--primary-color); text-decoration: none; font-weight: 600; transition: 0.2s; }
        .forgot-pass:hover { text-decoration: underline; }
        
        .btn-auth { width: 100%; padding: 16px; background: var(--primary-color); color: white; border: none; border-radius: 10px; font-size: 1.05rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: center; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2); }
        .btn-auth:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3); }
        .btn-auth:disabled { opacity: 0.7; cursor: not-allowed; transform: none; box-shadow: none; }

        .links { margin-top: 30px; text-align: center; font-size: 0.95rem; color: var(--text-muted); }
        .links a { color: var(--primary-color); text-decoration: none; font-weight: 700; transition: 0.2s; }
        .links a:hover { text-decoration: underline; }
        
        .theme-float { position: absolute; top: 30px; right: 30px; z-index: 10; }

        @media (max-width: 900px) { .auth-grid { grid-template-columns: 1fr; } .brand-side { display: none; } }
    </style>
</head>
<body>

    <div class="auth-grid">
        <div class="brand-side">
            <div class="brand-content">
                <div class="brand-icon">üéì</div>
                <div class="brand-quote">"True education enables one to develop the ability to think and to do."</div>
                <div class="brand-author">Louis B-T</div>
            </div>
        </div>

        <div class="form-side">
            <div class="theme-float">
                <select onchange="setTheme(this.value)" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                    <option value="system">üíª System</option>
                    <option value="light">‚òÄÔ∏è Light</option>
                    <option value="dark">üåô Dark</option>
                </select>
            </div>

            <div class="auth-card">
                <h2>Welcome Back</h2>
                <p class="sub-text">Enter your credentials to securely access your portal.</p>

                <div id="errorMessage" class="error-message" style="display: none;"></div>

                <form id="masterLoginForm">
                    <div class="input-group">
                        <label>Email Address or ID</label>
                        <input type="text" id="email" placeholder="student@gmail.com or 'admin'" autocomplete="username" required>
                    </div>

                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" required>
                        <i class="fas fa-eye toggle-password" id="togglePassBtn" title="Toggle Password Visibility"></i>
                    </div>

                    <div class="form-actions">
                        <label class="remember-me"><input type="checkbox" id="rememberMe"> Remember me</label>
                        <a href="#" class="forgot-pass" onclick="alert('Contact the Directorate IT Support for password recovery.')">Forgot Password?</a>
                    </div>

                    <button type="submit" class="btn-auth" id="submitBtn">
                        <span>Authenticate</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </form>

                <div class="links">
                    Don't have an account? <a href="signup.html">Create Account</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('masterLoginForm');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const submitBtn = document.getElementById('submitBtn');
            const togglePassBtn = document.getElementById('togglePassBtn');
            const errorMessage = document.getElementById('errorMessage');
            
            // Password Toggle
            togglePassBtn.addEventListener('click', () => {
                const isPass = passwordInput.getAttribute('type') === 'password';
                passwordInput.setAttribute('type', isPass ? 'text' : 'password');
                togglePassBtn.classList.toggle('fa-eye');
                togglePassBtn.classList.toggle('fa-eye-slash');
            });

            // --- THE OFFLINE-RESILIENT AUTH ENGINE ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault(); 
                errorMessage.style.display = 'none';
                
                const email = emailInput.value.trim().toLowerCase();
                const password = passwordInput.value.trim();

                const originalHtml = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Verifying...';

                try {
                    // Attempt Live Server Connection
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    if (!response.ok) throw new Error("Offline");

                    const data = await response.json();
                    if (data.error) throw new Error(data.error);

                    executeLoginSuccess(data.user);

                } catch (err) {
                    console.log("Live server unreachable. Engaging Offline Auth Bridge...");

                    // 1. MASTER ADMIN BYPASS
                    if ((email === 'admin' || email === 'admin@portal.com') && password === 'admin') {
                        executeLoginSuccess({ role: 'ADMIN', name: 'Directorate Admin', email: email, id: '000000' });
                        return;
                    }

                    // 2. MASTER STUDENT BYPASS (Demo Mode)
                    if ((email === 'student' || email === 'student@portal.com') && password === 'student') {
                        executeLoginSuccess({ role: 'STUDENT', name: 'Demo Student', email: email, id: '10284909' });
                        return;
                    }

                    // 3. CHECK LOCAL STORAGE FOR REGISTERED USERS
                    const localUsers = JSON.parse(localStorage.getItem('portal-registered-users')) || [];
                    const foundUser = localUsers.find(u => u.email.toLowerCase() === email && u.password === password);

                    if (foundUser) {
                        executeLoginSuccess({ role: 'STUDENT', name: foundUser.name, email: foundUser.email, id: foundUser.id || Math.floor(Math.random() * 90000) + 10000 });
                        return;
                    }

                    // Failure State
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHtml;
                    errorMessage.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Invalid Credentials. Please try again.';
                    errorMessage.style.display = 'flex';
                }
            });

            function executeLoginSuccess(user) {
                localStorage.setItem('portal-user-role', user.role);
                localStorage.setItem('portal-user-name', user.name);
                localStorage.setItem('portal-user-email', user.email);
                localStorage.setItem('portal-user-id', user.id);
                
                submitBtn.innerHTML = '<i class="fas fa-shield-check"></i> Security Cleared';
                submitBtn.style.background = '#10b981'; 
                submitBtn.style.boxShadow = '0 4px 15px rgba(16, 185, 129, 0.4)';

                setTimeout(() => {
                    window.location.href = user.role === 'ADMIN' ? "admin.html" : "dashboard.html";
                }, 800);
            }
        });
    </script>
</body>
</html>