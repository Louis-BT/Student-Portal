<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard | SRC Portal</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- CORE LAYOUT --- */
        body { margin: 0; font-family: 'Inter', sans-serif; background: #f1f5f9; display: flex; height: 100vh; overflow: hidden; }
        .dashboard-wrapper { display: flex; width: 100%; height: 100%; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background: #1e293b;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 25px;
            box-sizing: border-box;
            z-index: 10; /* Ensures it stays on top */
        }
        .sidebar-logo { font-size: 1.4rem; font-weight: 700; margin-bottom: 40px; color: #38bdf8; }
        
        /* CLICKABLE LINKS */
        .sidebar-nav a {
            color: #cbd5e1;
            text-decoration: none;
            padding: 12px 15px;
            display: block;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            cursor: pointer; /* Shows hand icon */
        }
        .sidebar-nav a:hover, .sidebar-nav a.active { 
            background: #334155; 
            color: white; 
            transform: translateX(5px); /* Moves slightly right on hover */
        }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }

        /* CLICKABLE CARDS */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        .card { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            text-align: center; 
            cursor: pointer; /* Shows hand icon */
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid transparent;
        }
        .card:hover { 
            transform: translateY(-5px); /* Lifts up */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: #2563eb; /* Blue border on hover */
        }
        
        .stat-num { font-size: 2.2rem; font-weight: 700; color: #2563eb; margin: 10px 0; }
        .card h3 { margin: 0; color: #64748b; font-size: 0.9rem; text-transform: uppercase; }

        /* GRAPH & NEWS */
        .bottom-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .chart-section, .news-section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .news-item { border-bottom: 1px solid #f1f5f9; padding: 10px 0; }
        .news-title { font-weight: 600; color: #1e293b; }
        .news-date { font-size: 0.75rem; color: #94a3b8; }
        .news-msg { font-size: 0.85rem; color: #475569; margin-top: 4px; }

        /* --- MOBILE --- */
        @media (max-width: 850px) {
            body { flex-direction: column; overflow: auto; }
            .dashboard-wrapper { flex-direction: column; }
            .sidebar { 
                width: 100%; height: auto; padding: 10px; 
                flex-direction: row; align-items: center; justify-content: space-between;
                position: sticky; top: 0; 
            }
            .sidebar-logo { margin-bottom: 0; font-size: 1rem; }
            .sidebar-nav { display: flex; gap: 5px; }
            .sidebar-nav a { padding: 8px; font-size: 0.8rem; margin: 0; }
            .bottom-grid { grid-template-columns: 1fr; }
            .main-content { padding: 15px; }
        }
    </style>
</head>
<body>

    <div class="dashboard-wrapper">
        <aside class="sidebar">
            <div class="sidebar-logo">üéì SRC Portal</div>
            <nav class="sidebar-nav">
                <a href="/dashboard" class="active">üè† Home</a>
                <a href="/gpa">üìä GPA Calc</a>
                <a href="/courses">üìö Courses</a>
                <a href="/profile">üë§ Profile</a>
                <a href="/logout" style="margin-top: 20px; color: #f87171;">üö™ Logout</a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <h1 id="welcome-message">Welcome! üëã</h1>
                <span id="nav-username" style="font-weight: 600; color: #64748b;">...</span>
            </header>

            <div class="dashboard-grid">
                <div class="card" onclick="window.location.href='/gpa'">
                    <h3>Current GPA</h3>
                    <p id="dashboard-gpa" class="stat-num">--</p>
                    <small style="color: #94a3b8;">Click to Update</small>
                </div>
                
                <div class="card" onclick="window.location.href='/courses'">
                    <h3>Registered Courses</h3>
                    <p id="course-count" class="stat-num">0</p>
                    <small style="color: #94a3b8;">Click to View</small>
                </div>

                <div class="card" onclick="window.location.href='/profile'">
                    <h3>My Profile</h3>
                    <div style="font-size: 2rem; margin: 10px 0;">üë§</div>
                    <small style="color: #94a3b8;">Edit Details</small>
                </div>
            </div>

            <div class="bottom-grid">
                <div class="chart-section">
                    <h3>üìà Academic Performance</h3>
                    <div style="position: relative; height: 300px;">
                        <canvas id="gpaChart"></canvas>
                    </div>
                </div>

                <div class="news-section">
                    <h3>üì¢ Announcements</h3>
                    <div id="news-feed">
                        <p style="color: #94a3b8; font-size: 0.9rem;">Loading news...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="theme.js"></script>
    <script>
        // FETCH DATA
        fetch('/api/user').then(res => res.json()).then(data => {
            document.getElementById('welcome-message').innerText = `Welcome, ${data.username} üëã`;
            document.getElementById('nav-username').innerText = data.username;
            
            if (data.gpa) document.getElementById('dashboard-gpa').innerText = Number(data.gpa).toFixed(2);
            if (data.courses) document.getElementById('course-count').innerText = JSON.parse(data.courses).length;

            // DRAW CHART
            let history = [];
            if (data.gpa_history) try { history = JSON.parse(data.gpa_history); } catch(e) {}
            if (history.length === 0 && data.gpa) history = [data.gpa];

            new Chart(document.getElementById('gpaChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: history.map((_, i) => `Sem ${i + 1}`),
                    datasets: [{
                        label: 'GPA History',
                        data: history,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 4.0 } }
                }
            });
        });

        // FETCH NEWS
        fetch('/api/news').then(res => res.json()).then(newsList => {
            const feed = document.getElementById('news-feed');
            if (newsList.length > 0) {
                feed.innerHTML = '';
                newsList.forEach(news => {
                    feed.innerHTML += `
                        <div class="news-item">
                            <div class="news-title">${news.title}</div>
                            <div class="news-date">${news.date}</div>
                            <p class="news-msg">${news.message}</p>
                        </div>
                    `;
                });
            } else {
                feed.innerHTML = '<p style="color: #94a3b8;">No announcements yet.</p>';
            }
        });
    </script>
</body>
</html>