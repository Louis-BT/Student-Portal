<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard | Student Portal</title>
    <link rel="stylesheet" href="/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- CORE LAYOUT --- */
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: #f1f5f9;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        .dashboard-wrapper { display: flex; width: 100%; height: 100%; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background: #1e293b;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 25px;
            box-sizing: border-box;
            border-right: 1px solid #334155;
        }
        .sidebar-logo { font-size: 1.4rem; font-weight: 700; margin-bottom: 30px; color: #38bdf8; }

        .profile-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #334155;
        }
        .profile-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #38bdf8;
        }

        .sidebar-nav a {
            color: #cbd5e1;
            text-decoration: none;
            padding: 12px 15px;
            display: block;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }
        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            background: #334155;
            color: white;
        }

        /* --- MAIN --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .top-header { margin-bottom: 20px; }

        /* Student Identity Strip */
        .identity-strip {
            background: white;
            padding: 15px 25px;
            border-radius: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
        .id-item { flex: 1; min-width: 120px; }
        .id-label { font-size: 0.75rem; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .id-value { font-size: 0.95rem; font-weight: 600; color: #1e293b; margin-top: 4px; display: block;}

        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        .badge-regular { background: #dbeafe; color: #1e40af; }
        .badge-scholarship { background: #dcfce7; color: #166534; }
        .badge-fee { background: #ffedd5; color: #9a3412; }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid #e2e8f0;
            position: relative;
        }
        .card:hover { transform: translateY(-5px); border-color: #cbd5e1; }

        .stat-num { font-size: 2rem; font-weight: 800; color: #2563eb; margin: 10px 0; }

        .bottom-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        .chart-section, .news-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        @media (max-width: 768px) {
            .bottom-grid { grid-template-columns: 1fr; }
            .identity-strip { gap: 15px; }
        }
    </style>
</head>

<body>

<div class="dashboard-wrapper">

    <aside class="sidebar">
        <div class="sidebar-logo">üéì Student Portal</div>
        
        <div class="profile-section">
            <a href="/profile.html">
                <img id="sidebar-pic" src="/uploads/default.png" class="profile-img" alt="Profile">
            </a>
            <div style="line-height: 1.2;">
                <div id="sidebar-name" style="font-weight: 600; font-size: 0.9rem;">Student</div>
                <div id="sidebar-role" style="font-size: 0.75rem; color: #94a3b8;">User</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <a href="/dashboard.html" class="active">üìä Dashboard</a>
            <a href="/profile.html">üë§ My Profile</a>
            <a href="/leadership.html" style="color: #f59e0b; font-weight: bold;">üèÖ Leadership Vanguard</a> 
            <a href="/courses.html">üìö Courses</a>
            <a href="/gpa.html">üßÆ GPA Calculator</a>
            <a href="/library.html">üìñ National Library</a> 
            <a href="/connect.html">üí¨ Student Connect</a>
            <a href="/logout" style="margin-top:20px; color:#f87171;">üö™ Logout</a>
        </nav>
    </aside>

    <main class="main-content">

        <header class="top-header">
            <h1 id="welcome-message" style="margin:0; color: #1e293b;">Welcome back!</h1>
            <p style="color:#64748b; margin-top: 5px;">Here is your academic overview.</p>
        </header>

        <div class="identity-strip">
            <div class="id-item">
                <span class="id-label">Institution</span>
                <span id="id-school" class="id-value">--</span>
            </div>
            <div class="id-item">
                <span class="id-label">Faculty / Dept</span>
                <span id="id-dept" class="id-value">--</span>
            </div>
            <div class="id-item">
                <span class="id-label">Level</span>
                <span id="id-level" class="id-value">--</span>
            </div>
            <div class="id-item">
                <span class="id-label">Status</span>
                <span id="id-financial" class="id-value">--</span>
            </div>
            <div class="id-item">
                <span class="id-label">Entry / Completion</span>
                <span id="id-years" class="id-value">-- / --</span>
            </div>
        </div>

        <div id="vanguard-banner" style="display: flex; justify-content: space-between; align-items: center; background: #0f172a; color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 6px solid #f59e0b;">
            <div>
                <h3 style="margin: 0; color: #f59e0b;">Join the Leadership Vanguard</h3>
                <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #cbd5e1;">Are you a visionary? Apply to join our elite circle of dedicated student leaders.</p>
            </div>
            <a href="/leadership.html" style="background: #f59e0b; color: #0f172a; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: bold; font-size: 0.9rem;">Apply Now</a>
        </div>

        <div id="news-box" style="background:#f0fdf4; border-left:4px solid #10b981; padding:15px; border-radius:8px; margin-bottom:25px; display: none;">
            <strong style="color:#10b981;">üì¢ Latest Update:</strong>
            <p id="announcement-text" style="margin: 5px 0 0 0; color: #14532d;">...</p>
        </div>

        <div class="dashboard-grid">
            <div class="card" onclick="window.location.href='/profile.html'">
                <h3>Academic Profile</h3>
                <div style="font-size: 2rem; margin: 10px 0;">üìÇ</div>
                <small style="color: #2563eb; font-weight: bold;">View & Download Record</small>
            </div>

            <div class="card" onclick="window.location.href='/courses.html'">
                <h3>Registered Courses</h3>
                <p id="course-count" class="stat-num">0</p>
                <small>View Details</small>
            </div>

            <div class="card" onclick="window.location.href='/gpa.html'">
                <h3>Current CGPA</h3>
                <p id="dashboard-gpa" class="stat-num">0.00</p>
                <small>View Transcript</small>
            </div>
        </div>

        <div class="bottom-grid">
            <div class="chart-section">
                <h3>üìà Performance History</h3>
                <div style="height:250px;">
                    <canvas id="gpaChart"></canvas>
                </div>
            </div>

            <div class="news-section">
                <h3>üîî Announcements</h3>
                <div id="news-feed" style="max-height: 250px; overflow-y: auto;">
                    <p style="color:#94a3b8;">Loading news...</p>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 30px; background: #dcfce7; border: 1px solid #22c55e; text-align: left; cursor: default;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="background: #22c55e; color: white; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 1.5rem;">
                    üì±
                </div>
                <div>
                    <h3 style="color: #14532d; margin: 0;">Join the General Platform</h3>
                    <p style="color: #166534; margin: 5px 0 0 0; font-size: 0.9rem;">
                        Connect with thousands of students. Get instant updates and network.
                    </p>
                </div>
            </div>
            <a href="https://chat.whatsapp.com/YOUR_GENERAL_GROUP_LINK" target="_blank" 
               style="display: block; margin-top: 15px; background: #22c55e; color: white; text-align: center; padding: 12px; border-radius: 6px; text-decoration: none; font-weight: bold;">
                Join WhatsApp Community &rarr;
            </a>
        </div>

        <div class="card" style="margin-top:30px; border: none; border-left:5px solid #f59e0b; text-align: left; background: #fffbeb; cursor: default;">
            <h3 style="color: #92400e; margin-top: 0;">Help & Support</h3>
            <p style="font-size: 0.9rem; color: #78350f;">Facing an issue? Message the Administrator directly.</p>

            <form action="/api/support" method="POST" style="display:flex; gap:10px; margin-top:15px;">
                <input type="text" name="message" placeholder="Describe your issue here..." required
                       style="flex:1; padding:10px; border:1px solid #fcd34d; border-radius:6px;">
                <button type="submit"
                        style="background:#f59e0b; color:white; padding:10px 20px; border:none; border-radius:6px; cursor: pointer; font-weight: bold;">
                    Report
                </button>
            </form>
        </div>

    </main>
</div>

<script src="/theme.js"></script>
<script>
    // --- 1. FETCH USER DATA ---
    fetch('/user-data') 
    .then(res => res.json())
    .then(data => {
        const name = data.name || data.username || 'Student';
        document.getElementById('welcome-message').innerText = `Welcome, ${name} üëã`;
        document.getElementById('sidebar-name').innerText = name;
        document.getElementById('sidebar-role').innerText = data.role || 'Student';

        if (data.profile_pic) {
            document.getElementById('sidebar-pic').src = '/uploads/' + data.profile_pic;
        }

        // Identity Strip
        document.getElementById('id-school').innerText = data.institution || 'Not Set';
        const faculty = data.faculty || '';
        const dept = data.department || '';
        document.getElementById('id-dept').innerText = (faculty && dept) ? `${faculty} / ${dept}` : (faculty || dept || 'Not Set');
        document.getElementById('id-level').innerText = data.level ? `Level ${data.level}` : '--';
        document.getElementById('id-years').innerText = `${data.year_entry || '?'} - ${data.year_completion || '?'}`;

        const finStatus = document.getElementById('id-financial');
        finStatus.innerText = data.financial_status || 'Regular';
        if(data.financial_status === 'Scholarship') finStatus.className = 'id-value badge badge-scholarship';
        else if(data.financial_status === 'Fee Paying') finStatus.className = 'id-value badge badge-fee';
        else finStatus.className = 'id-value badge badge-regular';

        if (data.gpa) {
            document.getElementById('dashboard-gpa').innerText = Number(data.gpa).toFixed(2);
        }

        if (data.courses) {
            try {
                const courseArr = JSON.parse(data.courses);
                document.getElementById('course-count').innerText = courseArr.length;
            } catch(e) { console.log("Error parsing courses"); }
        }

        // Chart.js
        let history = [0];
        if (data.gpa) history = [data.gpa]; 
        
        const ctx = document.getElementById('gpaChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: history.map((_, i) => `Sem ${i+1}`),
                datasets: [{
                    label: 'CGPA Progress',
                    data: history,
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37,99,235,0.1)',
                    fill: true,
                    tension: 0.3,
                    pointBackgroundColor: '#2563eb'
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: false, min: 0, max: 5.0 } } 
            }
        });
    });

    // --- 2. LEADERSHIP STATUS CHECK (Banner Logic) ---
    fetch('/api/leadership/my-status')
    .then(res => res.json())
    .then(data => {
        if (data.status === 'APPROVED') {
            document.getElementById('vanguard-banner').style.display = 'none';
            document.getElementById('welcome-message').innerHTML += ' <span title="Verified Leader" style="cursor:pointer; font-size:1.2rem;">üèÖ</span>';
        }
    })
    .catch(() => {});

    // --- 3. FETCH NEWS ---
    fetch('/api/news')
    .then(res => res.json())
    .catch(() => []) 
    .then(newsList => {
        const feed = document.getElementById('news-feed');
        const box = document.getElementById('news-box');
        const boxText = document.getElementById('announcement-text');

        if (newsList && newsList.length > 0) {
            feed.innerHTML = '';
            box.style.display = 'block';
            boxText.innerText = newsList[0].message || newsList[0].title;

            newsList.forEach(news => {
                feed.innerHTML += `
                    <div style="border-bottom:1px solid #eee; padding: 10px 0;">
                        <strong style="color:#334155; display:block;">${news.title || 'Update'}</strong>
                        <span style="font-size:0.9rem; color:#64748b;">${news.message}</span>
                    </div>
                `;
            });
        } else {
            feed.innerHTML = '<p style="color:#94a3b8; font-style:italic;">No active announcements.</p>';
        }
    });
</script>

</body>
</html>