<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Academic Profile | National Portal</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="theme.js"></script>

    <style>
        /* --- LAYOUT CONFIGURATION --- */
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; }
        .wrapper { display: flex; width: 100%; height: 100%; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: #0f172a; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 25px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; }
        .nav-links { list-style: none; padding: 20px; margin: 0; }
        .nav-links li { margin-bottom: 8px; }
        .nav-links a { display: flex; align-items: center; gap: 12px; color: #94a3b8; text-decoration: none; padding: 12px 15px; border-radius: 8px; transition: 0.2s; }
        .nav-links a:hover, .nav-links a.active { background: rgba(255,255,255,0.1); color: white; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: var(--bg-color); position: relative; }
        
        /* PROFILE CONTAINER */
        .profile-container { max-width: 900px; margin: 0 auto; }

        /* HEADER CARD */
        .profile-header-card {
            background: var(--card-bg); padding: 40px; border-radius: 16px;
            border: 1px solid var(--border-color); margin-bottom: 30px;
            display: flex; align-items: center; gap: 30px; position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }

        .avatar-wrapper { position: relative; width: 140px; height: 140px; flex-shrink: 0; }
        .profile-img {
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
            border: 4px solid var(--bg-color); box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: #e2e8f0;
        }
        .edit-avatar-btn {
            position: absolute; bottom: 5px; right: 5px; background: var(--primary-color);
            color: white; width: 35px; height: 35px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s;
        }
        .edit-avatar-btn:hover { transform: scale(1.1); }

        .profile-info h1 { margin: 0 0 5px 0; font-size: 1.8rem; color: var(--text-color); }
        .profile-info p { margin: 0 0 15px 0; color: var(--text-muted); }
        .badge {
            background: rgba(37, 99, 235, 0.1); color: var(--primary-color);
            padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase;
        }

        /* FORM SECTION */
        .form-section { background: var(--card-bg); padding: 30px; border-radius: 16px; border: 1px solid var(--border-color); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-top: 20px; }
        
        .form-group { position: relative; } 
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; font-weight: 600; color: var(--text-muted); }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color);
            background: var(--input-bg); color: var(--text-color); font-family: inherit; box-sizing: border-box;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        /* SEARCH SUGGESTIONS */
        .suggestions-list {
            position: absolute; top: 100%; left: 0; width: 100%; z-index: 1000;
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 8px; max-height: 200px; overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; margin-top: 5px;
        }
        .suggestion-item { padding: 12px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: 0.2s; }
        .suggestion-item:hover { background: var(--primary-color); color: white; }

        /* ACTION BAR */
        .action-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color);
        }
        .btn-primary {
            padding: 10px 20px; background: var(--primary-color); color: white; border: none;
            border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-secondary {
            padding: 10px 20px; background: transparent; border: 1px solid var(--border-color);
            color: var(--text-color); border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;
        }

        /* MODAL */
        #cropper-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; max-width: 500px; width: 90%; text-align: center; }
        .img-container { max-height: 400px; overflow: hidden; margin-bottom: 20px; }

        @media (max-width: 900px) { .sidebar { display: none; } }
    </style>
</head>
<body>

    <div class="wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-user-circle"></i> Student Portal
            </div>
            <ul class="nav-links">
                <li><a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="profile.html" class="active"><i class="fas fa-user"></i> My Profile</a></li>
                <li><a href="leadership.html"><i class="fas fa-medal"></i> Leadership</a></li>
                <li><a href="courses.html"><i class="fas fa-book-open"></i> Courses</a></li>
                <li><a href="gpa.html"><i class="fas fa-calculator"></i> GPA Calc</a></li>
                <li><a href="library.html"><i class="fas fa-book"></i> Library</a></li>
                <li><a href="connect.html"><i class="fas fa-comments"></i> Connect</a></li>
                <li style="margin-top: 20px;"><a href="index.html" style="color: #ef4444;"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </aside>

        <main class="main-content">
            
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="margin:0; font-size:1.5rem;">Academic Profile</h2>
                    <p style="margin:5px 0 0; color:var(--text-muted);">Manage your personal records.</p>
                </div>
                <div class="theme-wrapper">
                    <select onchange="setTheme(this.value)" style="padding: 8px; border-radius: 6px; border: 1px solid var(--border-color);">
                        <option value="system">üíª System</option>
                        <option value="light">‚òÄÔ∏è Light</option>
                        <option value="dark">üåô Dark</option>
                    </select>
                </div>
            </header>

            <div class="profile-container" id="printable-area">
                
                <div class="profile-header-card">
                    <div class="avatar-wrapper">
                        <img id="profile-display" src="https://via.placeholder.com/150" alt="Profile" class="profile-img">
                        <label for="img-input" class="edit-avatar-btn" title="Change Photo">
                            <i class="fas fa-camera"></i>
                        </label>
                        <input type="file" id="img-input" style="display:none" accept="image/*">
                    </div>
                    
                    <div class="profile-info">
                        <h1 id="student-name">Loading...</h1>
                        <p id="student-email">student@gmail.com</p>
                        <span class="badge" id="student-role">Student</span>
                    </div>
                </div>

                <div class="form-section">
                    <h3 style="margin-top:0; border-bottom:1px solid var(--border-color); padding-bottom:15px; color:var(--text-color);">
                        <i class="fas fa-user-graduate"></i> Academic Details
                    </h3>
                    
                    <form id="profile-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="name" placeholder="Your Full Name">
                            </div>

                            <div class="form-group">
                                <label>Institution / University</label>
                                <input type="text" id="schoolSearch" placeholder="Type university name..." autocomplete="off">
                                <div id="school-suggestions" class="suggestions-list"></div>
                            </div>

                            <div class="form-group">
                                <label>Faculty / School</label>
                                <input type="text" id="faculty" placeholder="e.g. Physical Sciences">
                            </div>
                            
                            <div class="form-group">
                                <label>Department</label>
                                <input type="text" id="department" placeholder="e.g. Computer Science">
                            </div>
                            
                            <div class="form-group">
                                <label>Program of Study</label>
                                <input type="text" id="program" placeholder="e.g. BSc. Information Technology">
                            </div>

                            <div class="form-group">
                                <label>Current Level</label>
                                <select id="level">
                                    <option value="100">Level 100</option>
                                    <option value="200">Level 200</option>
                                    <option value="300">Level 300</option>
                                    <option value="400">Level 400</option>
                                    <option value="500">Level 500</option>
                                    <option value="600">Level 600</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Financial Status</label>
                                <select id="financial">
                                    <option value="Regular">Regular</option>
                                    <option value="Fee Paying">Fee Paying</option>
                                    <option value="Scholarship">Scholarship / Bursary</option>
                                    <option value="International">International Student</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Entry Year</label>
                                <input type="number" id="entry-year" placeholder="2024">
                            </div>
                            
                            <div class="form-group">
                                <label>Graduation Year</label>
                                <input type="number" id="grad-year" placeholder="2028">
                            </div>
                        </div>

                        <div class="action-bar">
                            <div style="display:flex; gap:15px;">
                                <button type="button" class="btn-primary" onclick="saveProfile()">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button type="button" class="btn-secondary" onclick="downloadPDF()">
                                    <i class="fas fa-file-pdf"></i> Download PDF
                                </button>
                            </div>
                            <span id="save-status" style="font-weight:600; color:#10b981; opacity:0; transition:0.3s;"></span>
                        </div>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <div id="cropper-modal">
        <div class="modal-content">
            <h3 style="color:#333;">Adjust Photo</h3>
            <div class="img-container">
                <img id="crop-target" style="max-width: 100%;">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="closeCropper()" style="padding:10px 20px; background:#e2e8f0; border:none; border-radius:6px; cursor:pointer;">Cancel</button>
                <button onclick="saveCroppedImage()" style="padding:10px 20px; background:#2563eb; color:white; border:none; border-radius:6px; cursor:pointer;">Apply</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA: GHANA UNIVERSITIES ---
        const ghanaInstitutions = [
            "University of Ghana (UG)", "Kwame Nkrumah University of Science and Technology (KNUST)",
            "University of Cape Coast (UCC)", "University for Development Studies (UDS)",
            "University of Education, Winneba (UEW)", "Ghana Institute of Management and Public Administration (GIMPA)",
            "University of Professional Studies, Accra (UPSA)", "University of Mines and Technology (UMaT)",
            "University of Health and Allied Sciences (UHAS)", "University of Energy and Natural Resources (UENR)",
            "Ashesi University", "Central University", "Valley View University", "Pentecost University",
            "Accra Technical University (ATU)", "Kumasi Technical University (KsTU)", "Takoradi Technical University (TTU)",
            "Koforidua Technical University (KTU)", "Ho Technical University (HTU)", "Tamale Technical University (TaTU)",
            "Sunyani Technical University (STU)", "Cape Coast Technical University (CCTU)", "Bolgatanga Technical University",
            "Akenten Appiah-Menka University (AAMUSTED)", "Ghana Communication Technology University (GCTU)", 
            "All Nations University", "Regent University College"
        ];

        // --- 1. INITIALIZATION & SERVER LOAD ---
        document.addEventListener("DOMContentLoaded", async () => {
            // Load LocalStorage Basics first (for instant feel)
            const role = localStorage.getItem("portal-user-role") || "Student";
            const pic = localStorage.getItem("portal-avatar");
            
            document.getElementById("student-role").innerText = role.toUpperCase();
            if(pic) document.getElementById("profile-display").src = pic;

            // FETCH DATA FROM SERVER (Database Sync)
            try {
                const res = await fetch('/api/user/profile');
                if(!res.ok) throw new Error("Not logged in");
                
                const data = await res.json();
                
                // Update Header
                document.getElementById("student-name").innerText = data.name || "Student User";
                document.getElementById("student-email").innerText = data.email || "";

                // Populate ALL Form Fields (Making them editable)
                if(data.name) document.getElementById("name").value = data.name;
                if(data.institution) document.getElementById("schoolSearch").value = data.institution;
                if(data.faculty) document.getElementById("faculty").value = data.faculty;
                if(data.department) document.getElementById("department").value = data.department;
                if(data.program) document.getElementById("program").value = data.program;
                if(data.level) document.getElementById("level").value = data.level;
                if(data.financial_status) document.getElementById("financial").value = data.financial_status;
                if(data.year_entry) document.getElementById("entry-year").value = data.year_entry;
                if(data.year_completion) document.getElementById("grad-year").value = data.year_completion;
                
            } catch (e) {
                console.error("Using offline/local mode");
            }
        });

        // --- 2. SCHOOL SEARCH LOGIC (Editable) ---
        const schoolInput = document.getElementById('schoolSearch');
        const suggestionBox = document.getElementById('school-suggestions');

        schoolInput.addEventListener('input', function() {
            const val = this.value.toLowerCase();
            suggestionBox.innerHTML = '';
            
            if (!val) { 
                suggestionBox.style.display = 'none'; 
                return; 
            }

            const matches = ghanaInstitutions.filter(s => s.toLowerCase().includes(val));
            
            if (matches.length > 0) {
                suggestionBox.style.display = 'block';
                matches.forEach(match => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerHTML = match;
                    div.onclick = () => {
                        schoolInput.value = match;
                        suggestionBox.style.display = 'none';
                    };
                    suggestionBox.appendChild(div);
                });
            } else {
                suggestionBox.style.display = 'none';
            }
        });

        document.addEventListener('click', (e) => {
            if (!schoolInput.contains(e.target)) suggestionBox.style.display = 'none';
        });

        // --- 3. SAVE LOGIC (SERVER SYNC for ALL fields) ---
        async function saveProfile() {
            const btn = document.querySelector('button[onclick="saveProfile()"]');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            const payload = {
                name: document.getElementById("name").value,
                institution: document.getElementById("schoolSearch").value,
                faculty: document.getElementById("faculty").value,
                department: document.getElementById("department").value,
                program: document.getElementById("program").value,
                level: document.getElementById("level").value,
                financial: document.getElementById("financial").value,
                entry: document.getElementById("entry-year").value,
                completion: document.getElementById("grad-year").value
            };

            try {
                // Save to Database
                const res = await fetch('/api/user/update-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if(res.ok) {
                    // Feedback
                    const msg = document.getElementById("save-status");
                    msg.innerText = "‚úì Saved to Database";
                    msg.style.opacity = 1;
                    setTimeout(() => { msg.style.opacity = 0; }, 3000);

                    // Instant UI Update
                    document.getElementById("student-name").innerText = payload.name;
                    
                    // Update LocalStorage for immediate use by Dashboard
                    localStorage.setItem("portal-institution", payload.institution);
                } else {
                    alert("Error saving to database.");
                }

            } catch (err) {
                alert("Connection error. Check your internet.");
            } finally {
                btn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            }
        }

        // --- 4. IMAGE CROPPER LOGIC ---
        let cropper;
        const imgInput = document.getElementById('img-input');
        const cropTarget = document.getElementById('crop-target');
        const modal = document.getElementById('cropper-modal');

        imgInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    cropTarget.src = e.target.result;
                    modal.style.display = 'flex';
                    if(cropper) cropper.destroy();
                    cropper = new Cropper(cropTarget, { aspectRatio: 1, viewMode: 1 });
                };
                reader.readAsDataURL(file);
            }
        });

        function closeCropper() {
            modal.style.display = 'none';
            imgInput.value = '';
        }

        function saveCroppedImage() {
            const canvas = cropper.getCroppedCanvas({ width: 300, height: 300 });
            const url = canvas.toDataURL();
            document.getElementById("profile-display").src = url;
            localStorage.setItem("portal-avatar", url); // Keep Avatar in LocalStorage for now
            closeCropper();
        }

        // --- 5. PDF DOWNLOAD ---
        function downloadPDF() {
            const element = document.getElementById('printable-area');
            const opt = {
                margin: 10,
                filename: 'Academic_Profile.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }
    </script>
</body>
</html>