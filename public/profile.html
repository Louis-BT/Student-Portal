<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Academic Profile | National Portal</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="theme.js"></script>

    <style>
        /* --- 1. CORE LAYOUT --- */
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; }
        .wrapper { display: flex; width: 100%; height: 100%; }

        .sidebar { width: 260px; background: #0f172a; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 25px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; font-size: 1.1rem; }
        .nav-links { list-style: none; padding: 20px; margin: 0; }
        .nav-links li { margin-bottom: 8px; }
        .nav-links a { display: flex; align-items: center; gap: 12px; color: #94a3b8; text-decoration: none; padding: 12px 15px; border-radius: 8px; transition: 0.2s; font-weight: 500; border-left: 3px solid transparent; }
        .nav-links a:hover, .nav-links a.active { background: linear-gradient(90deg, rgba(37, 99, 235, 0.2) 0%, transparent 100%); border-left: 3px solid #3b82f6; color: white; transform: translateX(4px); }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: var(--bg-color); position: relative; }
        
        /* --- 2. HEADER & NOTIFICATIONS --- */
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header-title h2 { margin: 0; font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; }
        .header-title p { margin: 5px 0 0; color: var(--text-muted); font-size: 0.95rem; }
        
        .header-tools { display: flex; align-items: center; gap: 20px; }
        
        .notify-bell { position: relative; font-size: 1.3rem; color: var(--text-muted); cursor: pointer; transition: 0.2s; padding: 8px; border-radius: 50%; background: var(--card-bg); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; }
        .notify-bell:hover { color: var(--primary-color); background: var(--input-bg); }
        .bell-dot { position: absolute; top: 8px; right: 10px; width: 8px; height: 8px; background: #ef4444; border-radius: 50%; box-shadow: 0 0 0 2px var(--card-bg); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* --- 3. PROFILE MASTER CONTAINER --- */
        .profile-container { max-width: 1000px; margin: 0 auto; }

        .profile-header-card {
            background: var(--card-bg); padding: 40px; border-radius: 16px;
            border: 1px solid var(--border-color); margin-bottom: 30px;
            display: flex; align-items: center; gap: 30px; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.02); overflow: hidden;
        }
        .profile-header-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: linear-gradient(90deg, var(--primary-color), #8b5cf6); }

        .avatar-wrapper { position: relative; width: 140px; height: 140px; flex-shrink: 0; }
        .profile-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid var(--bg-color); box-shadow: 0 4px 20px rgba(0,0,0,0.1); background: #e2e8f0; }
        .edit-avatar-btn {
            position: absolute; bottom: 5px; right: 5px; background: var(--primary-color);
            color: white; width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            border: 3px solid var(--card-bg); box-shadow: 0 4px 10px rgba(37,99,235,0.3); transition: 0.2s;
        }
        .edit-avatar-btn:hover { transform: scale(1.1); background: #1d4ed8; }

        .profile-info h1 { margin: 0 0 5px 0; font-size: 2rem; color: var(--text-color); font-weight: 800; letter-spacing: -0.5px; }
        .profile-info p { margin: 0 0 15px 0; color: var(--text-muted); font-size: 1rem; }
        .badge { background: rgba(37, 99, 235, 0.1); color: var(--primary-color); padding: 6px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid rgba(37,99,235,0.2); }

        /* --- 4. TAB NAVIGATION --- */
        .profile-tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid var(--border-color); padding-bottom: 15px; }
        .p-tab { padding: 10px 25px; border-radius: 8px; font-weight: 600; cursor: pointer; color: var(--text-muted); transition: 0.2s; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; }
        .p-tab:hover { background: var(--input-bg); color: var(--text-color); }
        .p-tab.active { background: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(37,99,235,0.2); }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 5. FORM ARCHITECTURE --- */
        .form-section { background: var(--card-bg); padding: 35px; border-radius: 16px; border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-top: 20px; }
        
        .form-group { position: relative; } 
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.85rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .form-group input, .form-group select {
            width: 100%; padding: 14px 15px; border-radius: 8px; border: 1px solid var(--border-color);
            background: var(--input-bg); color: var(--text-color); font-family: inherit; box-sizing: border-box; font-size: 0.95rem; transition: 0.2s;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        /* Suggestions Dropdown */
        .suggestions-list { position: absolute; top: 100%; left: 0; width: 100%; z-index: 100; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; max-height: 250px; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: none; margin-top: 5px; }
        .suggestion-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: 0.2s; font-size: 0.95rem; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background: var(--primary-color); color: white; padding-left: 20px; }

        /* --- 6. SECURITY TAB SPECIFICS --- */
        .security-block { border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 25px; }
        .session-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border-color); }
        .session-item:last-child { border-bottom: none; padding-bottom: 0; }
        .session-icon { width: 45px; height: 45px; border-radius: 8px; background: rgba(37,99,235,0.1); color: var(--primary-color); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .session-current { background: rgba(16, 185, 129, 0.1); color: #10b981; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }

        /* --- 7. ACTION BAR & BUTTONS --- */
        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 40px; padding-top: 25px; border-top: 1px solid var(--border-color); }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2); }
        .btn-primary:hover { transform: translateY(-2px); background: #1d4ed8; }
        .btn-secondary { background: transparent; border: 2px solid var(--border-color); color: var(--text-color); }
        .btn-secondary:hover { border-color: var(--text-muted); background: var(--input-bg); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
        .btn-danger:hover { background: #ef4444; color: white; }

        /* --- 8. CROPPER MODAL --- */
        #cropper-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.9); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 16px; max-width: 500px; width: 90%; text-align: center; border: 1px solid var(--border-color); box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .img-container { max-height: 400px; overflow: hidden; margin-bottom: 25px; border-radius: 8px; background: var(--input-bg); }

        @media (max-width: 900px) { .sidebar { display: none; } .profile-header-card { flex-direction: column; text-align: center; } .action-bar { flex-direction: column; gap: 20px; } }
    </style>
</head>
<body>

    <div class="wrapper">
        <aside class="sidebar">
            <div class="sidebar-header"><i class="fas fa-user-circle"></i> Student Portal</div>
            <ul class="nav-links">
                <li><a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="profile.html" class="active"><i class="fas fa-user"></i> My Profile</a></li>
                <li><a href="leadership.html"><i class="fas fa-medal"></i> Leadership</a></li>
                <li><a href="courses.html"><i class="fas fa-book-open"></i> Courses</a></li>
                <li><a href="gpa.html"><i class="fas fa-calculator"></i> GPA Calc</a></li>
                <li><a href="library.html"><i class="fas fa-book"></i> Library</a></li>
                <li><a href="connect.html"><i class="fas fa-comments"></i> Connect</a></li>
                <li style="margin-top: 20px;"><a href="index.html" style="color: #ef4444; border-left-color: transparent;"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="header-top">
                <div class="header-title">
                    <h2>Account Settings</h2>
                    <p>Manage your academic identity and security preferences.</p>
                </div>
                <div class="header-tools">
                    <div class="notify-bell" title="Notifications" onclick="alert('No new global broadcasts.')">
                        <i class="fas fa-bell"></i>
                        <span class="bell-dot"></span>
                    </div>
                    <div class="theme-wrapper">
                        <select onchange="setTheme(this.value)" style="padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); cursor: pointer; font-weight: 500;">
                            <option value="system">üíª System</option>
                            <option value="light">‚òÄÔ∏è Light</option>
                            <option value="dark">üåô Dark</option>
                        </select>
                    </div>
                </div>
            </header>

            <div class="profile-container" id="printable-area">
                
                <div class="profile-header-card">
                    <div class="avatar-wrapper">
                        <img id="profile-display" src="https://via.placeholder.com/150" alt="Profile" class="profile-img">
                        <label for="img-input" class="edit-avatar-btn" title="Upload Professional Photo">
                            <i class="fas fa-camera"></i>
                        </label>
                        <input type="file" id="img-input" style="display:none" accept="image/*">
                    </div>
                    <div class="profile-info">
                        <h1 id="student-name">Loading...</h1>
                        <p id="student-email">student@nationalportal.edu.gh</p>
                        <span class="badge" id="student-role"><i class="fas fa-check-circle"></i> Verified Student</span>
                    </div>
                </div>

                <div class="profile-tabs no-print">
                    <div class="p-tab active" onclick="switchProfileTab('academic', this)"><i class="fas fa-user-graduate"></i> Academic & Personal</div>
                    <div class="p-tab" onclick="switchProfileTab('security', this)"><i class="fas fa-shield-alt"></i> Security & Sessions</div>
                </div>

                <div id="tab-academic" class="tab-content active form-section">
                    <h3 style="margin:0 0 20px 0; color:var(--text-color); font-size: 1.3rem;">Personal Information</h3>
                    <form id="profile-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Legal Full Name</label>
                                <input type="text" id="name" placeholder="As it appears on official records">
                            </div>
                            <div class="form-group">
                                <label>Career Aspirations</label>
                                <input type="text" id="career" placeholder="e.g. Software Engineer, Policy Analyst">
                            </div>
                        </div>

                        <h3 style="margin:30px 0 20px 0; border-top:1px solid var(--border-color); padding-top:20px; color:var(--text-color); font-size: 1.3rem;">Institutional Details</h3>
                        <div class="form-grid">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>University / Institution</label>
                                <input type="text" id="schoolSearch" placeholder="Begin typing to search national registry..." autocomplete="off">
                                <div id="school-suggestions" class="suggestions-list"></div>
                            </div>
                            <div class="form-group">
                                <label>Faculty / College</label>
                                <input type="text" id="faculty" placeholder="e.g. College of Science">
                            </div>
                            <div class="form-group">
                                <label>Department</label>
                                <input type="text" id="department" placeholder="e.g. Computer Science">
                            </div>
                            <div class="form-group">
                                <label>Program of Study</label>
                                <input type="text" id="program" placeholder="e.g. BSc. Information Technology">
                            </div>
                            <div class="form-group">
                                <label>Academic Level</label>
                                <select id="level">
                                    <option value="100">Level 100 (Freshman)</option>
                                    <option value="200">Level 200 (Sophomore)</option>
                                    <option value="300">Level 300 (Junior)</option>
                                    <option value="400">Level 400 (Senior)</option>
                                    <option value="500">Level 500 (Advanced)</option>
                                    <option value="600">Level 600 (Post-Grad)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Financial Status</label>
                                <select id="financial">
                                    <option value="Regular">Regular Student</option>
                                    <option value="Fee Paying">Fee Paying</option>
                                    <option value="Scholarship">Government Scholarship / Bursary</option>
                                    <option value="International">International Student</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Entry Year</label>
                                <input type="number" id="entry-year" placeholder="2024">
                            </div>
                            <div class="form-group">
                                <label>Graduation Year (Expected)</label>
                                <input type="number" id="grad-year" placeholder="2028">
                            </div>
                        </div>

                        <div class="action-bar no-print">
                            <div style="display:flex; gap:15px;">
                                <button type="button" class="btn btn-primary" id="saveBtn" onclick="saveProfile()">
                                    <i class="fas fa-cloud-upload-alt"></i> Sync to National DB
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="downloadPDF()">
                                    <i class="fas fa-file-pdf"></i> Export Bio-Data
                                </button>
                            </div>
                            <span id="save-status" style="font-weight:600; color:#10b981; opacity:0; transition:0.3s;"><i class="fas fa-check-circle"></i> Synchronized</span>
                        </div>
                    </form>
                </div>

                <div id="tab-security" class="tab-content form-section">
                    
                    <div class="security-block">
                        <h3 style="margin:0 0 5px 0; color:var(--text-color); font-size: 1.2rem;">Change Password</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom: 20px;">Ensure your account remains secure by using a strong, unique password.</p>
                        <div class="form-grid" style="margin-top:0;">
                            <div class="form-group">
                                <label>Current Password</label>
                                <input type="password" placeholder="Enter current password">
                            </div>
                            <div class="form-group">
                                <label>New Password</label>
                                <input type="password" placeholder="Minimum 8 characters">
                            </div>
                        </div>
                        <button class="btn btn-primary" style="margin-top: 20px;" onclick="alert('Password update protocol initiated.')">Update Password</button>
                    </div>

                    <div class="security-block" style="padding: 0; overflow: hidden;">
                        <div style="padding: 25px; border-bottom: 1px solid var(--border-color); background: rgba(0,0,0,0.02);">
                            <h3 style="margin:0 0 5px 0; color:var(--text-color); font-size: 1.2rem;">Active Login Sessions</h3>
                            <p style="color:var(--text-muted); font-size:0.9rem; margin: 0;">Devices currently authenticated to your portal account.</p>
                        </div>
                        
                        <div class="session-item">
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <div class="session-icon"><i class="fas fa-laptop"></i></div>
                                <div>
                                    <strong style="color:var(--text-color);">Windows PC - Chrome Browser</strong>
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 3px;"><i class="fas fa-map-marker-alt"></i> Nkoranza, Bono East Region, Ghana</div>
                                </div>
                            </div>
                            <span class="session-current">Current Session</span>
                        </div>

                        <div class="session-item">
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <div class="session-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;"><i class="fas fa-mobile-alt"></i></div>
                                <div>
                                    <strong style="color:var(--text-color);">iPhone 14 Pro - Safari</strong>
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 3px;"><i class="fas fa-map-marker-alt"></i> Kumasi, Ashanti Region, Ghana</div>
                                </div>
                            </div>
                            <button class="btn btn-danger" style="padding: 8px 15px;" onclick="this.parentElement.remove()"><i class="fas fa-sign-out-alt"></i> Revoke</button>
                        </div>
                    </div>

                </div>

            </div>
        </main>
    </div>

    <div id="cropper-modal">
        <div class="modal-content">
            <h3 style="margin: 0 0 20px 0; color: var(--text-color); font-size: 1.3rem;"><i class="fas fa-crop-alt" style="color:var(--primary-color);"></i> Adjust Professional Photo</h3>
            <div class="img-container">
                <img id="crop-target" style="max-width: 100%;">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:15px;">
                <button class="btn btn-secondary" onclick="closeCropper()">Cancel</button>
                <button class="btn btn-primary" onclick="saveCroppedImage()"><i class="fas fa-check"></i> Apply Avatar</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATA: GHANA UNIVERSITIES, COLLEGES OF EDUCATION, AND COLLEGES OF HEALTH ---
        const ghanaInstitutions = [
            "University of Ghana, Legon (UG)", "Kwame Nkrumah University of Science and Technology (KNUST)", "SDA College of Education (SEDACOE), Koforidua-Asokore", "Kintampo College of Health and Well-being",
            "University of Cape Coast (UCC)", "University for Development Studies (UDS)",
            "University of Education, Winneba (UEW)", "Ghana Institute of Management and Public Administration (GIMPA)", "College of Health, Yamfo", "College of Nursing and Midwifery, Koforidua", "College of Nursing and Midwifery, Teshie",
            "University of Professional Studies, Accra (UPSA)", "University of Mines and Technology (UMaT)", "College of Nursing and Midwifery, Cape Coast", "College of Nursing, Nkawkaw", "Mental Health Nursing College, Ankaful", "Midwifery Training College, Tumu/Nandom", "Community Health Nurses' Training Colleges, Jipara",
            "University of Health and Allied Sciences (UHAS)", "University of Energy and Natural Resources (UENR)", "School of Anaesthesia, Kumasi", "School of Anaesthesia, Ridge", "Bibiani College of Health Sciences", "School of Dispensing Optics, Oyoko",
            "Ashesi University", "Central University", "Valley View University", "Pentecost University", "Abetifi College of Education", "Accra College of Education", "Ada College of Education", "Agogo Presbyterian College of Education", "Akrokerri College of Education", "Atebubu College of Education", "Bagabaga College of Education", "Berekum College of Education", "Enchi College of Education", "Evangelical Presbyterian (E.P) College of Education, Amedzofe", "Foso College of Education",
            "Accra Technical University (ATU)", "Kumasi Technical University (KsTU)", "Takoradi Technical University (TTU)", "Gbewaa College of Education", "Holy Child College of Education", "Jasikan College of Education", "Kibi Presbyterian College of Education", "Komenda College of Education", "Mt. Mary College of Education", "N.J Ahmadiyya College of Education", "Offinso College of Education", "Peki College of Education", "St. John Bosco College of Education", "St. Monica's College of Education", "St. Theresa's College of Education",
            "Koforidua Technical University (KTU)", "Ho Technical University (HTU)", "Tamale Technical University (TaTU)", "Tamale College of Education", "Tumu College of Education", "SDA College of Education, Agona", "Wesley College of Education",
            "Sunyani Technical University (STU)", "Cape Coast Technical University (CCTU)", "Bolgatanga Technical University",
            "Akenten Appiah-Menka University of Skills Training and Entrepreneurial Development (AAMUSTED)", "Ghana Communication Technology University (GCTU)"
        ];

        // --- 2. INITIALIZATION & SERVER LOAD ---
        document.addEventListener("DOMContentLoaded", async () => {
            const role = localStorage.getItem("portal-user-role") || "Student";
            const pic = localStorage.getItem("portal-avatar");
            
            if(role === 'ADMIN') document.getElementById("student-role").innerHTML = '<i class="fas fa-shield-alt"></i> System Admin';
            if(pic) document.getElementById("profile-display").src = pic;

            try {
                const res = await fetch('/api/user/profile');
                if(!res.ok) throw new Error("Offline");
                const data = await res.json();
                
                document.getElementById("student-name").innerText = data.name || "Student User";
                document.getElementById("student-email").innerText = data.email || "student@nationalportal.edu.gh";

                if(data.name) document.getElementById("name").value = data.name;
                if(data.institution) document.getElementById("schoolSearch").value = data.institution;
                if(data.faculty) document.getElementById("faculty").value = data.faculty;
                if(data.department) document.getElementById("department").value = data.department;
                if(data.program) document.getElementById("program").value = data.program;
                if(data.level) document.getElementById("level").value = data.level;
                if(data.financial_status) document.getElementById("financial").value = data.financial_status;
                if(data.year_entry) document.getElementById("entry-year").value = data.year_entry;
                if(data.year_completion) document.getElementById("grad-year").value = data.year_completion;
                
            } catch (e) {
                // Fallback to local storage if API fails
                document.getElementById("student-name").innerText = localStorage.getItem("portal-user-name") || "Student User";
                document.getElementById("name").value = localStorage.getItem("portal-user-name") || "";
            }
        });

        // --- 3. TAB LOGIC ---
        function switchProfileTab(tabId, el) {
            document.querySelectorAll('.p-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            el.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // --- 4. INSTITUTION AUTOCOMPLETE ---
        const schoolInput = document.getElementById('schoolSearch');
        const suggestionBox = document.getElementById('school-suggestions');

        schoolInput.addEventListener('input', function() {
            const val = this.value.toLowerCase();
            suggestionBox.innerHTML = '';
            if (!val) { suggestionBox.style.display = 'none'; return; }

            const matches = ghanaInstitutions.filter(s => s.toLowerCase().includes(val));
            if (matches.length > 0) {
                suggestionBox.style.display = 'block';
                matches.forEach(match => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerHTML = `<i class="fas fa-university" style="color:var(--text-muted); margin-right:8px;"></i> ${match}`;
                    div.onclick = () => {
                        schoolInput.value = match;
                        suggestionBox.style.display = 'none';
                    };
                    suggestionBox.appendChild(div);
                });
            } else { suggestionBox.style.display = 'none'; }
        });

        document.addEventListener('click', (e) => {
            if (!schoolInput.contains(e.target)) suggestionBox.style.display = 'none';
        });

        // --- 5. SAVE PROFILE (POSTGRES SYNC) ---
        async function saveProfile() {
            const btn = document.getElementById('saveBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
            
            const payload = {
                name: document.getElementById("name").value,
                institution: document.getElementById("schoolSearch").value,
                faculty: document.getElementById("faculty").value,
                department: document.getElementById("department").value,
                program: document.getElementById("program").value,
                level: document.getElementById("level").value,
                financial: document.getElementById("financial").value,
                entry: document.getElementById("entry-year").value,
                completion: document.getElementById("grad-year").value
            };

            try {
                const res = await fetch('/api/user/update-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if(res.ok) {
                    const msg = document.getElementById("save-status");
                    msg.style.opacity = 1;
                    setTimeout(() => { msg.style.opacity = 0; }, 3000);

                    document.getElementById("student-name").innerText = payload.name;
                    localStorage.setItem("portal-user-name", payload.name);
                    localStorage.setItem("portal-institution", payload.institution);
                } else { throw new Error(); }
            } catch (err) {
                alert("Database Connection Error. Data saved locally.");
            } finally {
                btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Sync to National DB';
            }
        }

        // --- 6. IMAGE CROPPER LOGIC ---
        let cropper;
        const imgInput = document.getElementById('img-input');
        const cropTarget = document.getElementById('crop-target');
        const modal = document.getElementById('cropper-modal');

        imgInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    cropTarget.src = e.target.result;
                    modal.style.display = 'flex';
                    if(cropper) cropper.destroy();
                    cropper = new Cropper(cropTarget, { aspectRatio: 1, viewMode: 1 });
                };
                reader.readAsDataURL(file);
            }
        });

        function closeCropper() {
            modal.style.display = 'none';
            imgInput.value = '';
        }

        function saveCroppedImage() {
            const canvas = cropper.getCroppedCanvas({ width: 400, height: 400 });
            const url = canvas.toDataURL('image/jpeg', 0.8);
            document.getElementById("profile-display").src = url;
            localStorage.setItem("portal-avatar", url); 
            closeCropper();
        }

        // --- 7. PDF EXPORT ---
        function downloadPDF() {
            // Hide elements we don't want printed
            document.querySelectorAll('.no-print').forEach(el => el.style.display = 'none');
            
            const element = document.getElementById('printable-area');
            const opt = {
                margin: 15,
                filename: 'National_Academic_Profile.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save().then(() => {
                // Restore elements after PDF generates
                document.querySelectorAll('.no-print').forEach(el => el.style.display = '');
            });
        }
    </script>
</body>
</html>