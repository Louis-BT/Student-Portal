<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Academic Profile | National Portal</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="theme.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="db.js"></script> <style>
        /* --- 1. CORE LAYOUT --- */
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; }
        .wrapper { display: flex; width: 100%; height: 100%; position: relative; }

        .sidebar { width: 260px; background: #0f172a; color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; }
        .sidebar-header { padding: 25px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; font-size: 1.1rem; }
        .nav-links { list-style: none; padding: 20px; margin: 0; }
        .nav-links li { margin-bottom: 8px; }
        .nav-links a { display: flex; align-items: center; gap: 12px; color: #94a3b8; text-decoration: none; padding: 12px 15px; border-radius: 8px; transition: 0.2s; font-weight: 500; border-left: 3px solid transparent; }
        .nav-links a:hover, .nav-links a.active { background: linear-gradient(90deg, rgba(37, 99, 235, 0.2) 0%, transparent 100%); border-left: 3px solid #3b82f6; color: white; transform: translateX(4px); }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: var(--bg-color); position: relative; }
        
        /* --- 2. HEADER & NOTIFICATIONS --- */
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header-title h2 { margin: 0; font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; }
        .header-title p { margin: 5px 0 0; color: var(--text-muted); font-size: 0.95rem; }
        
        .header-tools { display: flex; align-items: center; gap: 20px; }
        
        .notify-bell { position: relative; font-size: 1.3rem; color: var(--text-muted); cursor: pointer; transition: 0.2s; padding: 8px; border-radius: 50%; background: var(--card-bg); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; }
        .notify-bell:hover { color: var(--primary-color); background: var(--input-bg); }
        .bell-dot { position: absolute; top: 8px; right: 10px; width: 8px; height: 8px; background: #ef4444; border-radius: 50%; box-shadow: 0 0 0 2px var(--card-bg); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* --- 3. PROFILE MASTER CONTAINER --- */
        .profile-container { max-width: 1000px; margin: 0 auto; }

        .profile-header-card {
            background: var(--card-bg); padding: 40px; border-radius: 16px;
            border: 1px solid var(--border-color); margin-bottom: 30px;
            display: flex; align-items: center; gap: 30px; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.02); overflow: hidden;
        }
        .profile-header-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: linear-gradient(90deg, var(--primary-color), #8b5cf6); }

        .avatar-wrapper { position: relative; width: 140px; height: 140px; flex-shrink: 0; }
        .profile-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid var(--bg-color); box-shadow: 0 4px 20px rgba(0,0,0,0.1); background: #e2e8f0; }
        .edit-avatar-btn {
            position: absolute; bottom: 5px; right: 5px; background: var(--primary-color);
            color: white; width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            border: 3px solid var(--card-bg); box-shadow: 0 4px 10px rgba(37,99,235,0.3); transition: 0.2s;
        }
        .edit-avatar-btn:hover { transform: scale(1.1); background: #1d4ed8; }

        .profile-info h1 { margin: 0 0 5px 0; font-size: 2rem; color: var(--text-color); font-weight: 800; letter-spacing: -0.5px; }
        .profile-info p { margin: 0 0 15px 0; color: var(--text-muted); font-size: 1rem; }
        .badge { background: rgba(37, 99, 235, 0.1); color: var(--primary-color); padding: 6px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid rgba(37,99,235,0.2); }

        /* --- 4. TAB NAVIGATION --- */
        .profile-tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid var(--border-color); padding-bottom: 15px; }
        .p-tab { padding: 10px 25px; border-radius: 8px; font-weight: 600; cursor: pointer; color: var(--text-muted); transition: 0.2s; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; }
        .p-tab:hover { background: var(--input-bg); color: var(--text-color); }
        .p-tab.active { background: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(37,99,235,0.2); }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 5. FORM ARCHITECTURE --- */
        .form-section { background: var(--card-bg); padding: 35px; border-radius: 16px; border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-top: 20px; }
        
        .form-group { position: relative; } 
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.85rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .form-group input, .form-group select {
            width: 100%; padding: 14px 15px; border-radius: 8px; border: 1px solid var(--border-color);
            background: var(--input-bg); color: var(--text-color); font-family: inherit; box-sizing: border-box; font-size: 0.95rem; transition: 0.2s;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        /* Suggestions Dropdown */
        .suggestions-list { position: absolute; top: 100%; left: 0; width: 100%; z-index: 100; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; max-height: 250px; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: none; margin-top: 5px; }
        .suggestion-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: 0.2s; font-size: 0.95rem; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background: var(--primary-color); color: white; padding-left: 20px; }

        /* --- 6. SECURITY TAB SPECIFICS --- */
        .security-block { border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 25px; }
        .session-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border-color); }
        .session-item:last-child { border-bottom: none; padding-bottom: 0; }
        .session-icon { width: 45px; height: 45px; border-radius: 8px; background: rgba(37,99,235,0.1); color: var(--primary-color); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .session-current { background: rgba(16, 185, 129, 0.1); color: #10b981; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }

        /* --- 7. ACTION BAR & BUTTONS --- */
        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 40px; padding-top: 25px; border-top: 1px solid var(--border-color); }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2); }
        .btn-primary:hover { transform: translateY(-2px); background: #1d4ed8; }
        .btn-secondary { background: transparent; border: 2px solid var(--border-color); color: var(--text-color); }
        .btn-secondary:hover { border-color: var(--text-muted); background: var(--input-bg); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
        .btn-danger:hover { background: #ef4444; color: white; }

        /* --- 8. CROPPER MODAL --- */
        #cropper-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.9); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 16px; max-width: 500px; width: 90%; text-align: center; border: 1px solid var(--border-color); box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .img-container { max-height: 400px; overflow: hidden; margin-bottom: 25px; border-radius: 8px; background: var(--input-bg); }

        /* Mobile Adjustments */
        .mobile-menu-btn { display: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color); }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 998; backdrop-filter: blur(3px); }

        @media (max-width: 900px) { 
            .profile-header-card { flex-direction: column; text-align: center; } 
            .action-bar { flex-direction: column; gap: 20px; } 
            
            .mobile-menu-btn { display: block; }
            .sidebar { position: fixed; height: 100%; left: -280px; box-shadow: none; }
            .sidebar.mobile-open { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .sidebar-overlay.mobile-open { display: block; }
        }
    </style>
</head>
<body>

    <div class="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

    <div class="wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-university"></i> Student Portal
                <i class="fas fa-times mobile-menu-btn" style="margin-left: auto; color: white;" onclick="toggleMobileSidebar()"></i>
            </div>
            <ul class="nav-links">
                <li><a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="profile.html" class="active"><i class="fas fa-user"></i> My Profile</a></li>
                <li><a href="leadership.html"><i class="fas fa-medal"></i> Leadership</a></li>
                <li><a href="courses.html"><i class="fas fa-book-open"></i> Courses</a></li>
                <li><a href="gpa.html"><i class="fas fa-calculator"></i> GPA Calc</a></li>
                <li><a href="library.html"><i class="fas fa-book"></i> Library</a></li>
                <li><a href="opportunities.html"><i class="fas fa-briefcase"></i> Opportunities Hub</a></li>
                <li><a href="connect.html"><i class="fas fa-comments"></i> Connect</a></li>
                <li style="margin-top: 20px;">
    <a href="#" onclick="executeSecureLogout(event)" style="color: #ef4444; border-left-color: transparent;">
        <i class="fas fa-sign-out-alt"></i> Logout
    </a>
</li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="header-top">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-bars mobile-menu-btn" onclick="toggleMobileSidebar()"></i>
                    <div class="header-title">
                        <h2>Account Settings</h2>
                        <p>Manage your academic identity and security preferences.</p>
                    </div>
                </div>
                <div class="header-tools">
                    <div class="notify-bell" title="Notifications" onclick="alert('No new global broadcasts.')">
                        <i class="fas fa-bell"></i>
                        <span class="bell-dot"></span>
                    </div>
                    <div class="theme-wrapper">
                        <select onchange="setTheme(this.value)" style="padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); cursor: pointer; font-weight: 500;">
                            <option value="system">üíª System</option>
                            <option value="light">‚òÄÔ∏è Light</option>
                            <option value="dark">üåô Dark</option>
                        </select>
                    </div>
                </div>
            </header>

            <div class="profile-container">
                
                <div class="profile-header-card">
                    <div class="avatar-wrapper">
                        <img id="profile-display" src="https://via.placeholder.com/150" alt="Profile" class="profile-img">
                        <label for="img-input" class="edit-avatar-btn" title="Upload Professional Photo">
                            <i class="fas fa-camera"></i>
                        </label>
                        <input type="file" id="img-input" style="display:none" accept="image/*">
                    </div>
                    <div class="profile-info">
                        <h1 id="student-name"><i class="fas fa-circle-notch fa-spin"></i> Syncing...</h1>
                        <p id="student-email">student@nationalportal.edu.gh</p>
                        <span class="badge" id="student-role"><i class="fas fa-check-circle"></i> Cloud Verified</span>
                    </div>
                </div>

                <div class="profile-tabs no-print">
                    <div class="p-tab active" onclick="switchProfileTab('academic', this)"><i class="fas fa-user-graduate"></i> Academic & Personal</div>
                    <div class="p-tab" onclick="switchProfileTab('security', this)"><i class="fas fa-shield-alt"></i> Security & Sessions</div>
                </div>

                <div id="tab-academic" class="tab-content active form-section">
                    <h3 style="margin:0 0 20px 0; color:var(--text-color); font-size: 1.3rem;">Personal Information</h3>
                    <form id="profile-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Legal Full Name</label>
                                <input type="text" id="name" placeholder="As it appears on official records">
                            </div>
                            <div class="form-group">
                                <label>Career Aspirations</label>
                                <input type="text" id="career" placeholder="e.g. Software Engineer, Policy Analyst">
                            </div>
                        </div>

                        <h3 style="margin:30px 0 20px 0; border-top:1px solid var(--border-color); padding-top:20px; color:var(--text-color); font-size: 1.3rem;">Institutional Details</h3>
                        <div class="form-grid">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>University / Institution</label>
                                <input type="text" id="schoolSearch" placeholder="Begin typing to search national registry..." autocomplete="off">
                                <div id="school-suggestions" class="suggestions-list"></div>
                            </div>
                            <div class="form-group">
                                <label>Faculty / College / School</label>
                                <input type="text" id="faculty" placeholder="e.g. College of Science">
                            </div>
                            <div class="form-group">
                                <label>Department</label>
                                <input type="text" id="department" placeholder="e.g. Computer Science">
                            </div>
                            <div class="form-group">
                                <label>Program of Study</label>
                                <input type="text" id="program" placeholder="e.g. BSc. Information Technology">
                            </div>
                            <div class="form-group">
                                <label>Academic Level</label>
                                <select id="level">
                                    <option value="100">Level 100 (Freshman)</option>
                                    <option value="200">Level 200 (Sophomore)</option>
                                    <option value="300">Level 300 (Junior)</option>
                                    <option value="400">Level 400 (Senior)</option>
                                    <option value="500">Level 500 (Advanced)</option>
                                    <option value="600">Level 600 (Post-Grad)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Financial Status</label>
                                <select id="financial">
                                    <option value="Regular">Regular Student</option>
                                    <option value="Fee Paying">Fee Paying</option>
                                    <option value="Scholarship">Government Scholarship / Bursary</option>
                                    <option value="International">International Student</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Entry Year</label>
                                <input type="number" id="entry-year" placeholder="2024">
                            </div>
                            <div class="form-group">
                                <label>Graduation Year (Expected)</label>
                                <input type="number" id="grad-year" placeholder="2028">
                            </div>
                        </div>

                        <div class="action-bar no-print">
                            <div style="display:flex; gap:15px; flex-wrap: wrap;">
                                <button type="button" class="btn btn-primary" id="saveBtn" onclick="saveProfile()">
                                    <i class="fas fa-cloud-upload-alt"></i> Sync to National DB
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="downloadPDF()">
                                    <i class="fas fa-file-pdf"></i> Export Bio-Data
                                </button>
                            </div>
                            <span id="save-status" style="font-weight:600; color:#10b981; opacity:0; transition:0.3s;"><i class="fas fa-check-circle"></i> Synchronized</span>
                        </div>
                    </form>
                </div>

                <div id="tab-security" class="tab-content form-section">
                    
                    <div class="security-block">
                        <h3 style="margin:0 0 5px 0; color:var(--text-color); font-size: 1.2rem;">Change Password</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom: 20px;">Ensure your account remains secure by using a strong, unique password.</p>
                        <div class="form-grid" style="margin-top:0;">
                            <div class="form-group">
                                <label>Current Password</label>
                                <input type="password" placeholder="Enter current password">
                            </div>
                            <div class="form-group">
                                <label>New Password</label>
                                <input type="password" placeholder="Minimum 8 characters">
                            </div>
                        </div>
                        <button class="btn btn-primary" style="margin-top: 20px;" onclick="alert('Password update protocol initiated.')">Update Password</button>
                    </div>

                    <div class="security-block" style="padding: 0; overflow: hidden;">
                        <div style="padding: 25px; border-bottom: 1px solid var(--border-color); background: rgba(0,0,0,0.02);">
                            <h3 style="margin:0 0 5px 0; color:var(--text-color); font-size: 1.2rem;">Active Login Sessions</h3>
                            <p style="color:var(--text-muted); font-size:0.9rem; margin: 0;">Devices currently authenticated to your portal account.</p>
                        </div>
                        
                        <div class="session-item">
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <div class="session-icon"><i class="fas fa-laptop"></i></div>
                                <div>
                                    <strong style="color:var(--text-color);">Windows PC - Chrome Browser</strong>
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 3px;"><i class="fas fa-map-marker-alt"></i> Nkoranza, Bono East Region, Ghana</div>
                                </div>
                            </div>
                            <span class="session-current">Current Session</span>
                        </div>

                        <div class="session-item">
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <div class="session-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;"><i class="fas fa-mobile-alt"></i></div>
                                <div>
                                    <strong style="color:var(--text-color);">iPhone 14 Pro - Safari</strong>
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 3px;"><i class="fas fa-map-marker-alt"></i> Kumasi, Ashanti Region, Ghana</div>
                                </div>
                            </div>
                            <button class="btn btn-danger" style="padding: 8px 15px;" onclick="this.parentElement.remove()"><i class="fas fa-sign-out-alt"></i> Revoke</button>
                        </div>
                    </div>

                </div>

            </div>
        </main>
    </div>

    <div id="cropper-modal">
        <div class="modal-content">
            <h3 style="margin: 0 0 20px 0; color: var(--text-color); font-size: 1.3rem;"><i class="fas fa-crop-alt" style="color:var(--primary-color);"></i> Adjust Professional Photo</h3>
            <div class="img-container">
                <img id="crop-target" style="max-width: 100%;">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:15px;">
                <button class="btn btn-secondary" onclick="closeCropper()">Cancel</button>
                <button class="btn btn-primary" onclick="saveCroppedImage()"><i class="fas fa-check"></i> Apply Avatar</button>
            </div>
        </div>
    </div>

    <div id="official-print-template" style="display: none; padding: 40px; font-family: 'Times New Roman', serif; color: black; background: white; width: 800px; position: absolute; left: 0; top: 0; z-index: -1;">
        
        <div style="text-align: center; border-bottom: 3px solid #000; padding-bottom: 20px; margin-bottom: 30px;">
            <h1 style="margin: 0; font-size: 24px; text-transform: uppercase;">National Tertiary Student Portal</h1>
            <h2 style="margin: 5px 0 0; font-size: 18px; color: #444;">Official Student Bio-Data Record</h2>
            <p style="margin: 5px 0 0; font-size: 12px; font-family: Arial, sans-serif;">Generated on: <span id="print-date"></span></p>
        </div>

        <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; font-family: Arial, sans-serif; font-size: 14px;">
            <tr>
                <td style="padding: 10px; border: 1px solid #ccc; font-weight: bold; width: 30%; background: #f5f5f5;">Full Legal Name</td>
                <td style="padding: 10px; border: 1px solid #ccc;" id="print-name"></td>
            </tr>
            <tr>
                <td style="padding: 10px; border: 1px solid #ccc; font-weight: bold; background: #f5f5f5;">Institution</td>
                <td style="padding: 10px; border: 1px solid #ccc;" id="print-inst"></td>
            </tr>
            <tr>
                <td style="padding: 10px; border: 1px solid #ccc; font-weight: bold; background: #f5f5f5;">Program & Department</td>
                <td style="padding: 10px; border: 1px solid #ccc;" id="print-prog"></td>
            </tr>
            <tr>
                <td style="padding: 10px; border: 1px solid #ccc; font-weight: bold; background: #f5f5f5;">Academic Level</td>
                <td style="padding: 10px; border: 1px solid #ccc;" id="print-level"></td>
            </tr>
            <tr>
                <td style="padding: 10px; border: 1px solid #ccc; font-weight: bold; background: #f5f5f5;">Career Aspirations</td>
                <td style="padding: 10px; border: 1px solid #ccc;" id="print-career"></td>
            </tr>
        </table>

        <div style="margin-top: 80px; display: flex; justify-content: space-between; text-align: center; font-family: Arial, sans-serif;">
            <div style="width: 200px;">
                <div style="border-bottom: 1px solid #000; height: 40px; margin-bottom: 5px;"></div>
                <strong>Student Signature</strong>
            </div>
            <div style="width: 200px;">
                <div style="border-bottom: 1px solid #000; height: 40px; margin-bottom: 5px;">
                    <span style="font-size: 24px; font-family: 'Times New Roman', serif; font-style: italic; opacity: 0.7;">NTS-AUTH</span>
                </div>
                <strong>NTS Registrar Authorization</strong>
            </div>
        </div>
    </div>

    <script>
        // --- MOBILE MENU LOGIC ---
        function toggleMobileSidebar() {
            document.querySelector('.sidebar').classList.toggle('mobile-open');
            document.querySelector('.sidebar-overlay').classList.toggle('mobile-open');
        }

        // --- 1. DATA: GHANA UNIVERSITIES & COLLEGES ---
        const ghanaInstitutions = [
            "University of Ghana, Legon (UG)", "Kwame Nkrumah University of Science and Technology (KNUST)", "SDA College of Education (SEDACOE), Koforidua-Asokore", "Kintampo College of Health and Well-being",
            "University of Cape Coast (UCC)", "University for Development Studies (UDS)",
            "University of Education, Winneba (UEW)", "Ghana Institute of Management and Public Administration (GIMPA)", "College of Health, Yamfo", "College of Nursing and Midwifery, Koforidua", "College of Nursing and Midwifery, Teshie",
            "University of Professional Studies, Accra (UPSA)", "University of Mines and Technology (UMaT)", "College of Nursing and Midwifery, Cape Coast", "College of Nursing, Nkawkaw", "Mental Health Nursing College, Ankaful", "Midwifery Training College, Tumu/Nandom", "Community Health Nurses' Training Colleges, Jipara",
            "University of Health and Allied Sciences (UHAS)", "University of Energy and Natural Resources (UENR)", "School of Anaesthesia, Kumasi", "School of Anaesthesia, Ridge", "Bibiani College of Health Sciences", "School of Dispensing Optics, Oyoko",
            "Ashesi University", "Central University", "Valley View University", "Pentecost University", "Abetifi College of Education", "Accra College of Education", "Ada College of Education", "Agogo Presbyterian College of Education", "Akrokerri College of Education", "Atebubu College of Education", "Bagabaga College of Education", "Berekum College of Education", "Enchi College of Education", "Evangelical Presbyterian (E.P) College of Education, Amedzofe", "Foso College of Education",
            "Accra Technical University (ATU)", "Kumasi Technical University (KsTU)", "Takoradi Technical University (TTU)", "Gbewaa College of Education", "Holy Child College of Education", "Jasikan College of Education", "Kibi Presbyterian College of Education", "Komenda College of Education", "Mt. Mary College of Education", "N.J Ahmadiyya College of Education", "Offinso College of Education", "Peki College of Education", "St. John Bosco College of Education", "St. Monica's College of Education", "St. Theresa's College of Education",
            "Koforidua Technical University (KTU)", "Ho Technical University (HTU)", "Tamale Technical University (TaTU)", "Tamale College of Education", "Tumu College of Education", "SDA College of Education, Agona", "Wesley College of Education",
            "Sunyani Technical University (STU)", "Cape Coast Technical University (CCTU)", "Bolgatanga Technical University",
            "Akenten Appiah-Menka University of Skills Training and Entrepreneurial Development (AAMUSTED)", "Ghana Communication Technology University (GCTU)"
        ];

        // --- 2. FIREBASE INITIALIZATION & SYNC ---
        let userDbKey = null; // Store the unique Firebase ID for this user

        document.addEventListener("DOMContentLoaded", () => {
            const role = localStorage.getItem("portal-user-role") || "Student";
            if(role === 'ADMIN') {
                document.getElementById("student-role").innerHTML = '<i class="fas fa-shield-alt"></i> System Admin';
                document.getElementById("student-email").innerText = "admin@nationalportal.edu.gh";
                document.getElementById("student-name").innerText = "Directorate Admin";
                document.getElementById("name").value = "Directorate Admin";
                return;
            }

            const cachedEmail = localStorage.getItem("portal-user-email");
            if (!cachedEmail) {
                window.location.href = 'login.html';
                return;
            }

            // Pull live data from Firebase
            db.ref('users').orderByChild('email').equalTo(cachedEmail).once('value', (snapshot) => {
                if(snapshot.exists()) {
                    snapshot.forEach(child => {
                        userDbKey = child.key; // Crucial for updating later
                        const data = child.val();
                        
                        document.getElementById("student-name").innerText = data.name || "Student User";
                        document.getElementById("student-email").innerText = data.email;

                        if(data.name) document.getElementById("name").value = data.name;
                        if(data.institution) document.getElementById("schoolSearch").value = data.institution;
                        if(data.faculty) document.getElementById("faculty").value = data.faculty;
                        if(data.department) document.getElementById("department").value = data.department;
                        if(data.program) document.getElementById("program").value = data.program;
                        if(data.level) document.getElementById("level").value = data.level;
                        if(data.financial_status) document.getElementById("financial").value = data.financial_status;
                        if(data.year_entry) document.getElementById("entry-year").value = data.year_entry;
                        if(data.year_completion) document.getElementById("grad-year").value = data.year_completion;
                        if(data.career) document.getElementById("career").value = data.career;
                        
                        // Load cloud avatar if it exists, else load local fallback
                        if(data.avatar) {
                            document.getElementById("profile-display").src = data.avatar;
                            localStorage.setItem("portal-avatar", data.avatar); // keep cache synced
                        } else {
                            const localPic = localStorage.getItem("portal-avatar");
                            if(localPic) document.getElementById("profile-display").src = localPic;
                        }
                    });
                } else {
                    // Fail-safe if somehow deleted from DB while logged in
                    document.getElementById("student-name").innerText = localStorage.getItem("portal-user-name") || "Student User";
                }
            });
        });

        // --- 3. TAB LOGIC ---
        function switchProfileTab(tabId, el) {
            document.querySelectorAll('.p-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            el.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // --- 4. INSTITUTION AUTOCOMPLETE ---
        const schoolInput = document.getElementById('schoolSearch');
        const suggestionBox = document.getElementById('school-suggestions');

        schoolInput.addEventListener('input', function() {
            const val = this.value.toLowerCase();
            suggestionBox.innerHTML = '';
            if (!val) { suggestionBox.style.display = 'none'; return; }

            const matches = ghanaInstitutions.filter(s => s.toLowerCase().includes(val));
            if (matches.length > 0) {
                suggestionBox.style.display = 'block';
                matches.forEach(match => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerHTML = `<i class="fas fa-university" style="color:var(--text-muted); margin-right:8px;"></i> ${match}`;
                    div.onclick = () => {
                        schoolInput.value = match;
                        suggestionBox.style.display = 'none';
                    };
                    suggestionBox.appendChild(div);
                });
            } else { suggestionBox.style.display = 'none'; }
        });

        document.addEventListener('click', (e) => {
            if (!schoolInput.contains(e.target)) suggestionBox.style.display = 'none';
        });

        // --- 5. SAVE PROFILE TO FIREBASE ---
       function saveProfile() {
    // 1. Get the currently logged-in student directly from Firebase
    const user = firebase.auth().currentUser;
    const btn = document.querySelector('button[onclick="saveProfile()"]');
    
    if (!user) {
        alert("Authentication Error: Please log out and log back in.");
        return;
    }

    // 2. Prepare the data exactly as the Dashboard expects it
    const payload = {
        institution: document.getElementById('institution-input')?.value || "National University",
        faculty: document.getElementById('faculty-input').value,
        department: document.getElementById('dept-input').value,
        program: document.getElementById('program-input').value,
        level: document.getElementById('level-select').value,
        gradYear: document.getElementById('grad-year').value,
        lastUpdated: new Date().toISOString()
    };

    // 3. UI Feedback: Change button to show activity
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
    btn.disabled = true;

    // 4. Push directly to the cloud node 'users/[UID]'
    db.ref('users/' + user.uid).update(payload)
        .then(() => {
            console.log("Cloud Sync Successful for UID:", user.uid);
            alert("Success! Profile synced with National Database.");
            window.location.href = "dashboard.html"; // Redirect to stop the 'Syncing...' spinner
        })
        .catch((error) => {
            console.error("Firebase Sync Error:", error);
            alert("Sync Failed: " + error.message);
            btn.innerHTML = 'Sync to National DB';
            btn.disabled = false;
        });
}
        // --- 6. IMAGE CROPPER LOGIC (Cloud Wired) ---
        let cropper;
        const imgInput = document.getElementById('img-input');
        const cropTarget = document.getElementById('crop-target');
        const modal = document.getElementById('cropper-modal');

        imgInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    cropTarget.src = e.target.result;
                    modal.style.display = 'flex';
                    if(cropper) cropper.destroy();
                    cropper = new Cropper(cropTarget, { aspectRatio: 1, viewMode: 1 });
                };
                reader.readAsDataURL(file);
            }
        });

        function closeCropper() {
            modal.style.display = 'none';
            imgInput.value = '';
        }

        function saveCroppedImage() {
            const canvas = cropper.getCroppedCanvas({ width: 400, height: 400 });
            // Compress heavily for real-time DB limits
            const url = canvas.toDataURL('image/jpeg', 0.6); 
            
            document.getElementById("profile-display").src = url;
            localStorage.setItem("portal-avatar", url); 

            // Push avatar string to Firebase
            if (userDbKey) {
                db.ref('users/' + userDbKey).update({ avatar: url })
                .then(() => { console.log("Avatar synced to cloud."); })
                .catch(err => { console.error("Avatar sync failed.", err); });
            }

            closeCropper();
        }

        // --- 7. PREMIUM PDF EXPORT ENGINE ---
        function downloadPDF() {
            const btn = document.querySelector('button[onclick="downloadPDF()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            btn.disabled = true;

            document.getElementById('print-date').innerText = new Date().toLocaleDateString();
            document.getElementById('print-name').innerText = document.getElementById('name').value || "N/A";
            document.getElementById('print-inst').innerText = document.getElementById('schoolSearch').value || "N/A";
            document.getElementById('print-prog').innerText = (document.getElementById('program').value || "N/A") + " - " + (document.getElementById('department').value || "N/A");
            document.getElementById('print-level').innerText = "Level " + document.getElementById('level').value;
            document.getElementById('print-career').innerText = document.getElementById('career').value || "N/A";

            const element = document.getElementById('official-print-template');
            
            element.style.display = 'block';
            element.style.zIndex = '999999';
            element.style.background = 'white';

            const opt = {
                margin: 15,
                filename: 'Official_NTS_BioData.pdf',
                image: { type: 'jpeg', quality: 1.0 },
                html2canvas: { scale: 3, useCORS: true, logging: false }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            setTimeout(() => {
                html2pdf().set(opt).from(element).save().then(() => {
                    element.style.display = 'none'; 
                    element.style.zIndex = '-1';
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            }, 100);
        }
    </script>
</body>
</html>