<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | Student Portal</title>
    <link rel="stylesheet" href="/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body { background: #f8fafc; font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; }
        .wrapper { display: flex; width: 100%; height: 100%; }
        
        /* Sidebar styling remains consistent with dashboard */
        .sidebar { width: 260px; background: #1e293b; color: white; padding: 25px; box-sizing: border-box; }
        .sidebar a { color: #cbd5e1; text-decoration: none; padding: 12px; display: block; border-radius: 8px; margin-bottom: 5px; }
        .sidebar a.active { background: #334155; color: white; }

        .main-content { flex: 1; padding: 40px; overflow-y: auto; }
        
        .profile-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); max-width: 900px; margin: 0 auto; }
        
        .profile-header { display: flex; align-items: center; gap: 30px; border-bottom: 1px solid #e2e8f0; padding-bottom: 30px; margin-bottom: 30px; }
        .avatar-container { position: relative; width: 150px; height: 150px; }
        .avatar-preview { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; color: #64748b; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; box-sizing: border-box; }
        
        .btn-save { background: #2563eb; color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 20px; }
        .btn-download { background: #0f172a; color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-left: 10px; }

        /* Cropper Modal */
        #cropper-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; max-width: 500px; width: 90%; }
        #crop-image { max-width: 100%; }
    </style>
</head>
<body>

<div class="wrapper">
    <aside class="sidebar">
        <h2 style="color: #38bdf8;">Student Portal</h2>
        <a href="/dashboard.html">üìä Dashboard</a>
        <a href="/profile.html" class="active">üë§ My Profile</a>
        <a href="/leadership.html">üèÖ Leadership Vanguard</a>
        <a href="/courses.html">üìö Courses</a>
        <a href="/gpa.html">üßÆ GPA Calculator</a>
        <a href="/logout" style="margin-top: 50px; color: #f87171;">üö™ Logout</a>
    </aside>

    <main class="main-content" id="profile-area">
        <div class="profile-card">
            <div class="profile-header">
                <div class="avatar-container">
                    <img id="profile-img" src="/uploads/default.png" class="avatar-preview">
                    <label for="img-input" style="cursor: pointer; position: absolute; bottom: 0; right: 0; background: #2563eb; color: white; padding: 8px; border-radius: 50%;">üì∑</label>
                    <input type="file" id="img-input" style="display:none" accept="image/*">
                </div>
                <div>
                    <h1 id="user-display-name" style="margin: 0;">Student Name</h1>
                    <p id="user-display-email" style="color: #64748b;">email@institution.edu</p>
                    <span id="badge-role" class="badge-regular" style="padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">STUDENT</span>
                </div>
            </div>

            <form id="profile-form" onsubmit="event.preventDefault(); saveProfileDetails();">
                <div class="form-grid">
                    <div>
                        <label>Faculty / School</label>
                        <input type="text" id="faculty" placeholder="e.g. Faculty of Computing">
                    </div>
                    <div>
                        <label>Department</label>
                        <input type="text" id="department" placeholder="e.g. Computer Science">
                    </div>
                    <div>
                        <label>Current Level</label>
                        <select id="level">
                            <option value="100">Level 100</option>
                            <option value="200">Level 200</option>
                            <option value="300">Level 300</option>
                            <option value="400">Level 400</option>
                            <option value="500">Post-Grad</option>
                        </select>
                    </div>
                    <div>
                        <label>Financial Status</label>
                        <select id="financial_status">
                            <option value="Regular">Regular</option>
                            <option value="Fee Paying">Fee Paying</option>
                            <option value="Scholarship">Scholarship</option>
                        </select>
                    </div>
                    <div>
                        <label>Academic Status (Program Type)</label>
                        <select id="academic_status">
                            <option value="Bachelor's Degree">Bachelor's Degree</option>
                            <option value="Diploma">Diploma</option>
                            <option value="Certificate">Certificate</option>
                            <option value="Master's degree">Master's degree</option>
                            <option value="PhD">PhD</option>
                        </select>
                    </div>
                    <div>
                        <label>Course of Study</label>
                        <input type="text" id="program" placeholder="e.g. B.Sc. Software Engineering">
                    </div>
                    <div>
                        <label>Year of Entry</label>
                        <input type="number" id="year_entry" placeholder="2022">
                    </div>
                    <div>
                        <label>Year of Completion</label>
                        <input type="number" id="year_completion" placeholder="2026">
                    </div>
                </div>

                <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 30px;">
                    <div>
                        <button type="submit" class="btn-save">Save Changes</button>
                        <button type="button" class="btn-download" onclick="downloadRecord()">üì• Download Academic Record</button>
                    </div>
                    <div id="status-msg" style="font-weight: 600;"></div>
                </div>
            </form>
        </div>
    </main>
</div>

<div id="cropper-modal">
    <div class="modal-content">
        <h3>Crop Profile Picture</h3>
        <div style="max-height: 400px; overflow: hidden;">
            <img id="crop-image">
        </div>
        <div style="margin-top: 20px; text-align: right;">
            <button onclick="closeCropper()" style="padding: 10px; background: #ccc; border: none; border-radius: 6px;">Cancel</button>
            <button onclick="doCrop()" style="padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: bold;">Apply & Save</button>
        </div>
    </div>
</div>

<script>
    let cropper;
    const imgInput = document.getElementById('img-input');
    const cropImage = document.getElementById('crop-image');
    const cropperModal = document.getElementById('cropper-modal');

    // --- 1. LOAD USER DATA ---
    fetch('/user-data')
    .then(res => res.json())
    .then(data => {
        document.getElementById('user-display-name').innerText = data.name;
        document.getElementById('user-display-email').innerText = data.email;
        document.getElementById('badge-role').innerText = data.role;
        
        if(data.profile_pic) document.getElementById('profile-img').src = '/uploads/' + data.profile_pic;
        
        // Populate inputs
        document.getElementById('faculty').value = data.faculty || '';
        document.getElementById('department').value = data.department || '';
        document.getElementById('level').value = data.level || '100';
        document.getElementById('financial_status').value = data.financial_status || 'Regular';
        document.getElementById('academic_status').value = data.academic_status || "Bachelor's Degree";
        document.getElementById('program').value = data.program || '';
        document.getElementById('year_entry').value = data.year_entry || '';
        document.getElementById('year_completion').value = data.year_completion || '';
    });

    // --- 2. IMAGE CROPPING LOGIC ---
    imgInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                cropImage.src = event.target.result;
                cropperModal.style.display = 'flex';
                if(cropper) cropper.destroy();
                cropper = new Cropper(cropImage, {
                    aspectRatio: 1,
                    viewMode: 1
                });
            };
            reader.readAsDataURL(file);
        }
    });

    function closeCropper() { cropperModal.style.display = 'none'; }

    function doCrop() {
        const canvas = cropper.getCroppedCanvas({ width: 300, height: 300 });
        canvas.toBlob((blob) => {
            const formData = new FormData();
            formData.append('avatar', blob, 'profile.jpg');
            
            fetch('/upload-profile', { method: 'POST', body: formData })
            .then(() => location.reload());
        });
    }

    // --- 3. SAVE PROFILE DETAILS (With VALIDATION) ---
    function saveProfileDetails() {
        const entry = parseInt(document.getElementById('year_entry').value);
        const completion = parseInt(document.getElementById('year_completion').value);
        const faculty = document.getElementById('faculty').value.trim();
        const msg = document.getElementById('status-msg');

        // --- üõë VALIDATION SECTION ---
        if (!faculty || faculty.length < 3) {
            alert("Please enter a valid Faculty name.");
            return;
        }

        if (isNaN(entry) || isNaN(completion)) {
            alert("Please provide both Year of Entry and Completion.");
            return;
        }

        if (completion <= entry) {
            alert("Refined Error: Year of Completion must be after the Year of Entry.");
            return;
        }

        // --- PREPARE DATA ---
        const profileData = {
            faculty: faculty,
            department: document.getElementById('department').value,
            level: document.getElementById('level').value,
            financial: document.getElementById('financial_status').value,
            academic: document.getElementById('academic_status').value,
            program: document.getElementById('program').value,
            entry: entry,
            completion: completion
        };

        msg.innerText = "Saving...";
        msg.style.color = "#2563eb";

        fetch('/api/update-profile-details', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(profileData)
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                msg.innerText = "‚úì Saved Successfully";
                msg.style.color = "green";
                setTimeout(() => msg.innerText = "", 3000);
            }
        });
    }

    // --- 4. DOWNLOAD RECORD (PDF) ---
    function downloadRecord() {
        const element = document.getElementById('profile-area');
        const opt = {
            margin: 10,
            filename: 'Student_Academic_Record.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }
</script>

</body>
</html>