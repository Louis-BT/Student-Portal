<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Connect | Secure Hub</title>
    
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="theme.js"></script>

    <style>
        /* --- 1. CORE LAYOUT & NAVBAR --- */
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-color); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        .navbar { height: 65px; background: var(--card-bg); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; flex-shrink: 0; z-index: 50; }
        .logo { font-weight: 800; font-size: 1.3rem; color: var(--primary-color); display: flex; align-items: center; gap: 10px; letter-spacing: -0.5px; }

        .chat-layout { display: grid; grid-template-columns: 340px 1fr; flex: 1; overflow: hidden; max-width: 1600px; margin: 0 auto; width: 100%; background: var(--bg-color); }

        /* --- 2. SIDEBAR (CHATS & HUBS) --- */
        .chat-sidebar { border-right: 1px solid var(--border-color); background: var(--card-bg); display: flex; flex-direction: column; overflow: hidden; z-index: 10; }
        .chat-search { padding: 20px; border-bottom: 1px solid var(--border-color); }
        .chat-search input { width: 100%; padding: 12px 18px; border-radius: 25px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); outline: none; font-size: 0.9rem; transition: 0.2s; }
        .chat-search input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        
        .user-list { flex: 1; overflow-y: auto; padding: 15px 10px; }
        .chat-category { font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin: 15px 10px 8px; display: flex; justify-content: space-between; align-items: center; }
        .add-btn { cursor: pointer; color: var(--primary-color); font-size: 1.1rem; transition: 0.2s; }
        .add-btn:hover { transform: scale(1.1); }
        
        .user-item { display: flex; align-items: center; gap: 15px; padding: 12px 15px; border-radius: 10px; cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; margin-bottom: 2px; }
        .user-item:hover { background: var(--input-bg); }
        .user-item.active { background: rgba(37, 99, 235, 0.08); border-left: 3px solid var(--primary-color); }

        .avatar-wrapper { position: relative; width: 45px; height: 45px; flex-shrink: 0; }
        .avatar-initials { width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; background: var(--primary-color); font-size: 1.2rem; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; position: absolute; bottom: 0; right: 0; border: 2px solid var(--card-bg); background: #10b981; }

        /* --- 3. MAIN CHAT AREA --- */
        .chat-main { display: flex; flex-direction: column; background: var(--bg-color); position: relative; min-width: 0; }
        
        .chat-header { padding: 15px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); flex-shrink: 0; height: 75px; z-index: 5; }
        .header-actions { display: flex; gap: 12px; }
        .action-icon { width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-muted); background: var(--input-bg); cursor: pointer; transition: 0.2s; font-size: 1.1rem; }
        .action-icon:hover { background: rgba(37, 99, 235, 0.1); color: var(--primary-color); }
        .action-icon.video:hover { background: rgba(16, 185, 129, 0.1); color: #10b981; }

        .pinned-banner { background: rgba(245, 158, 11, 0.1); border-bottom: 1px solid rgba(245, 158, 11, 0.2); padding: 12px 25px; display: flex; align-items: center; gap: 12px; font-size: 0.85rem; color: #d97706; cursor: pointer; transition: 0.2s; }
        .pinned-banner:hover { background: rgba(245, 158, 11, 0.15); }

        /* --- 4. MESSAGES FEED --- */
        .messages-area { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; background: url('https://www.transparenttextures.com/patterns/cubes.png'); }

        .msg-wrapper { display: flex; flex-direction: column; max-width: 70%; position: relative; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg-wrapper.in { align-self: flex-start; }
        .msg-wrapper.out { align-self: flex-end; align-items: flex-end; }
        
        .msg-sender { font-size: 0.75rem; font-weight: 700; color: var(--primary-color); margin-bottom: 5px; display: flex; align-items: center; gap: 6px; }
        .msg-sender.admin-badge::after { content: 'Admin'; background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .msg-bubble { padding: 14px 18px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.02); position: relative; }
        .msg-wrapper.in .msg-bubble { background: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); border-top-left-radius: 4px; }
        .msg-wrapper.out .msg-bubble { background: var(--primary-color); color: white; border-top-right-radius: 4px; }
        
        /* Message Meta (Time & Read Receipts) */
        .msg-meta { display: flex; align-items: center; gap: 5px; font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; font-weight: 500; }
        .msg-wrapper.out .msg-meta { justify-content: flex-end; }
        .read-receipt { font-size: 0.8rem; color: #94a3b8; transition: color 0.5s ease; }
        .read-receipt.read { color: #3b82f6; } /* Blue ticks */

        /* Edited Tag */
        .edited-tag { font-size: 0.65rem; opacity: 0.7; font-style: italic; margin-left: 5px; }

        /* Premium Message Blocks */
        .code-block { background: #0f172a; color: #e2e8f0; font-family: 'Fira Code', monospace; padding: 15px; border-radius: 8px; margin-top: 8px; font-size: 0.85rem; overflow-x: auto; border: 1px solid #334155; }
        .code-header { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px; border-bottom: 1px solid #334155; padding-bottom: 5px; display: flex; justify-content: space-between; }
        
        .reactions { display: flex; gap: 5px; margin-top: 6px; flex-wrap: wrap; }
        .reaction-badge { background: var(--input-bg); border: 1px solid var(--border-color); padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px; color: var(--text-color); transition: 0.2s; font-weight: 600; }
        .reaction-badge:hover, .reaction-badge.active { background: rgba(37,99,235,0.1); border-color: var(--primary-color); color: var(--primary-color); }

        /* Premium Audio Player */
        .audio-msg { display: flex; align-items: center; gap: 12px; min-width: 240px; }
        .play-btn { width: 35px; height: 35px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .play-btn:hover { background: rgba(255,255,255,0.4); }
        .audio-wave { flex: 1; height: 30px; display: flex; align-items: center; gap: 2px; }
        .wave-bar { width: 3px; background: rgba(255,255,255,0.4); border-radius: 2px; transition: height 0.1s ease; }
        .wave-bar.active { background: white; animation: bounce 0.5s infinite alternate; }
        @keyframes bounce { 0% { height: 5px; } 100% { height: 25px; } }

        /* Hover Tools (Reply/Edit) */
        .msg-hover-tools { position: absolute; top: -15px; right: 10px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; display: flex; box-shadow: 0 4px 15px rgba(0,0,0,0.08); opacity: 0; transform: translateY(5px); transition: all 0.2s ease; z-index: 10; padding: 2px; }
        .msg-wrapper:hover .msg-hover-tools { opacity: 1; transform: translateY(0); }
        .msg-wrapper.out .msg-hover-tools { right: auto; left: 10px; }
        .tool-btn { padding: 6px 12px; cursor: pointer; color: var(--text-muted); font-size: 0.9rem; transition: 0.2s; border-radius: 6px; }
        .tool-btn:hover { background: var(--input-bg); color: var(--primary-color); }

        /* --- 5. INPUT & MENUS --- */
        .chat-input-area { padding: 18px 25px; border-top: 1px solid var(--border-color); display: flex; gap: 15px; background: var(--card-bg); align-items: center; z-index: 20; position: relative; }
        
        .input-tool-btn { background: none; border: none; color: var(--text-muted); font-size: 1.4rem; cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .input-tool-btn:hover { color: var(--primary-color); background: var(--input-bg); }
        
        .input-wrapper { flex: 1; position: relative; display: flex; align-items: center; }
        .chat-input { width: 100%; padding: 15px 50px 15px 20px; border-radius: 25px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); font-size: 0.95rem; outline: none; transition: 0.2s; font-family: inherit; }
        .chat-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .chat-input.edit-mode { border-color: #f59e0b; box-shadow: 0 0 0 3px rgba(245,158,11,0.1); }
        
        .voice-btn { position: absolute; right: 15px; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .voice-btn:hover { color: #dc2626; }
        .voice-btn.recording { color: #dc2626; animation: flash 1s infinite; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        
        .send-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--primary-color); color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); flex-shrink: 0; }
        .send-btn:hover { transform: scale(1.05); background: #1d4ed8; }
        .send-btn.edit-mode { background: #f59e0b; box-shadow: 0 4px 15px rgba(245,158,11,0.3); }
        .send-btn.edit-mode:hover { background: #d97706; }

        /* Popover Menus (Attachments & Emojis) */
        .popover-menu { position: absolute; bottom: 85px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: none; z-index: 100; animation: slideUp 0.2s ease-out; }
        .popover-menu.active { display: block; }
        @keyframes slideUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        
        /* Attachment Specific */
        .attach-menu { left: 25px; width: 220px; }
        .menu-item { padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: var(--text-color); border-radius: 8px; font-size: 0.95rem; font-weight: 600; transition: 0.2s; }
        .menu-item:hover { background: var(--input-bg); }
        .menu-icon { width: 30px; display: flex; justify-content: center; font-size: 1.1rem; }

        /* Emoji Specific */
        .emoji-menu { right: 85px; width: 280px; display: none; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 15px; }
        .emoji-menu.active { display: grid; }
        .emoji-item { font-size: 1.5rem; cursor: pointer; text-align: center; padding: 5px; border-radius: 8px; transition: 0.2s; }
        .emoji-item:hover { background: var(--input-bg); transform: scale(1.2); }

        /* --- 6. CALL MODAL --- */
        .call-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .call-avatar { width: 150px; height: 150px; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 4rem; background: var(--primary-color); color: white; position: relative; }
        .call-avatar::after { content:''; position: absolute; width:100%; height:100%; border-radius:50%; border:2px solid var(--primary-color); animation: ripple 2s infinite; }
        @keyframes ripple { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

        @media (max-width: 850px) {
            .chat-layout { display: block; position: relative; }
            .chat-sidebar { width: 100%; height: 100%; position: absolute; border: none; }
            .chat-main { display: none; height: 100%; }
            .chat-layout.mobile-chat-active .chat-sidebar { display: none; }
            .chat-layout.mobile-chat-active .chat-main { display: flex; }
        }
    </style>
</head>
<body>

    <div id="callModal" class="call-modal">
        <div style="text-align: center; color: white;">
            <div class="call-avatar" id="callAvatarBg"><i class="fas fa-video"></i></div>
            <div style="font-size: 2rem; font-weight: 800; margin-bottom: 10px;" id="callName">...</div>
            <div style="font-size: 1.1rem; color: #94a3b8; margin-bottom: 40px; letter-spacing: 2px; text-transform: uppercase;" id="callStatus">Establishing Secure P2P Connection...</div>
            
            <div style="display: flex; justify-content: center; gap: 30px;">
                <button style="width: 65px; height: 65px; border-radius: 50%; border: none; font-size: 1.5rem; cursor: pointer; color: white; background: rgba(255,255,255,0.2); backdrop-filter: blur(5px);"><i class="fas fa-microphone-slash"></i></button>
                <button style="width: 65px; height: 65px; border-radius: 50%; border: none; font-size: 1.5rem; cursor: pointer; color: white; background: #ef4444; box-shadow: 0 0 20px rgba(239,68,68,0.4);" onclick="document.getElementById('callModal').style.display='none'"><i class="fas fa-phone-slash"></i></button>
            </div>
        </div>
    </div>

    <nav class="navbar">
        <div class="logo"><i class="fas fa-network-wired"></i> Student Connect</div>
        <div style="display: flex; gap: 20px; align-items: center;">
            <a href="dashboard.html" style="font-weight: 600; text-decoration: none; color: var(--text-color); display: flex; align-items: center; gap: 8px;"><i class="fas fa-arrow-left"></i> Dashboard</a>
            <div class="theme-wrapper">
                <select onchange="setTheme(this.value)" style="padding: 8px 12px; border-radius: 8px; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); cursor: pointer; font-weight: 600;">
                    <option value="system">üíª System</option>
                    <option value="light">‚òÄÔ∏è Light</option>
                    <option value="dark">üåô Dark</option>
                </select>
            </div>
        </div>
    </nav>

    <div class="chat-layout" id="mainLayout">
        
        <aside class="chat-sidebar">
            <div class="chat-search">
                <input type="text" id="searchInput" placeholder="Search hubs or students...">
            </div>
            
            <div class="user-list" id="userList">
                <div class="chat-category">
                    <span>Public Hubs</span>
                    <i class="fas fa-plus-circle add-btn" title="Create Hub"></i>
                </div>
                
                <div class="user-item active" onclick="openChat('general', 'National General Room', 'fa-globe-africa', '#2563eb')" id="chat-general">
                    <div class="avatar-wrapper">
                        <div class="avatar-initials" style="background:#2563eb"><i class="fas fa-globe-africa"></i></div>
                        <div class="status-dot"></div>
                    </div>
                    <div>
                        <div style="font-weight: 700; color: var(--text-color); font-size: 0.95rem;">National General Room</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Global Campus Hub</div>
                    </div>
                </div>

                <div class="chat-category" style="margin-top: 25px;">Direct Messages</div>
                <div id="dynamic-users"></div>
            </div>
        </aside>

        <main class="chat-main">
            <header class="chat-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-arrow-left" style="font-size: 1.3rem; cursor: pointer; display: none; color: var(--text-color);" id="mobileBack" onclick="closeChat()"></i>
                    <div class="avatar-wrapper" style="width: 45px; height: 45px;">
                        <div class="avatar-initials" id="activeAvatar" style="background:#2563eb"><i class="fas fa-globe-africa"></i></div>
                    </div>
                    <div>
                        <h3 id="chat-title" style="margin: 0; font-size: 1.15rem;">National General Room</h3>
                        <div id="chat-status" style="font-size: 0.8rem; color: #10b981; font-weight: 600; margin-top: 2px;">Secure Connection Active</div>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="action-icon" title="Search Thread"><i class="fas fa-search"></i></div>
                    <div class="action-icon" title="Shared Media"><i class="fas fa-folder-open"></i></div>
                    <div class="action-icon video" title="Start WebRTC Call" onclick="startCall()"><i class="fas fa-video"></i></div>
                </div>
            </header>

            <div class="pinned-banner" id="pinnedBanner">
                <i class="fas fa-thumbtack"></i>
                <div style="flex: 1;"><strong>Pinned by Admin:</strong> Welcome to the Secure Hub. Please ensure all shared code snippets and library documents follow academic integrity guidelines.</div>
            </div>

            <div class="messages-area" id="msg-container">
                <div style="text-align: center; margin-top: 50px; color: var(--text-muted);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2.5rem; margin-bottom: 15px; color: var(--primary-color);"></i>
                    <p style="font-weight: 500;">Establishing secure connection to National Database...</p>
                </div>
            </div>

            <div class="popover-menu attach-menu" id="attachMenu">
                <div class="menu-item">
                    <div class="menu-icon"><i class="fas fa-image" style="color: #a855f7;"></i></div> Photos & Video
                </div>
                <div class="menu-item">
                    <div class="menu-icon"><i class="fas fa-file-pdf" style="color: #ef4444;"></i></div> Document
                </div>
                <div class="menu-item" style="border-top: 1px solid var(--border-color); margin-top: 5px; padding-top: 10px;">
                    <div class="menu-icon"><i class="fas fa-book" style="color: #10b981;"></i></div> Link Library Item
                </div>
            </div>

            <div class="popover-menu emoji-menu" id="emojiMenu">
                <div class="emoji-item" onclick="insertEmoji('üëç')">üëç</div>
                <div class="emoji-item" onclick="insertEmoji('üëè')">üëè</div>
                <div class="emoji-item" onclick="insertEmoji('üí°')">üí°</div>
                <div class="emoji-item" onclick="insertEmoji('üéØ')">üéØ</div>
                <div class="emoji-item" onclick="insertEmoji('‚úÖ')">‚úÖ</div>
                <div class="emoji-item" onclick="insertEmoji('üî•')">üî•</div>
                <div class="emoji-item" onclick="insertEmoji('üöÄ')">üöÄ</div>
                <div class="emoji-item" onclick="insertEmoji('üíØ')">üíØ</div>
                <div class="emoji-item" onclick="insertEmoji('üìö')">üìö</div>
                <div class="emoji-item" onclick="insertEmoji('üôè')">üôè</div>
            </div>

            <div class="chat-input-area">
                <button class="input-tool-btn" onclick="toggleMenu('attachMenu')" title="Attach Media"><i class="fas fa-paperclip"></i></button>
                
                <div class="input-wrapper">
                    <input type="text" id="msg-input" class="chat-input" placeholder="Type a message or use /code for snippets..." onkeypress="handleKeyPress(event)">
                    <div class="voice-btn" id="micBtn" title="Hold to Record Audio" onclick="toggleRecording()"><i class="fas fa-microphone"></i></div>
                </div>
                
                <button class="input-tool-btn" onclick="toggleMenu('emojiMenu')" title="Insert Emoji/Sticker"><i class="far fa-smile"></i></button>
                <button class="send-btn" id="sendBtn" onclick="handleSendAction()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </main>
    </div>

    <script>
        // --- 1. GLOBAL STATE & DB SYNC ---
        let activeChatId = 'general';
        const currentUser = localStorage.getItem('portal-user-name') || 'Student';
        
        // Editing State Tracking
        let isEditing = false;
        let editMsgId = null; // Used for local storage finding
        let editMsgElement = null; // The DOM element being edited

        document.addEventListener('DOMContentLoaded', async () => {
            await fetchRealUsers();
            loadMessages('general');
            
            setInterval(() => {
                if (activeChatId === 'general') loadMessages('general', true);
            }, 3000);

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.chat-input-area')) {
                    document.getElementById('attachMenu').classList.remove('active');
                    document.getElementById('emojiMenu').classList.remove('active');
                }
            });
        });

        // --- 2. FETCH REAL USERS ---
        async function fetchRealUsers() {
            try {
                const res = await fetch('/api/admin/users');
                const students = await res.json();
                
                const dynamicList = document.getElementById('dynamic-users');
                dynamicList.innerHTML = '';

                students.forEach(s => {
                    if (s.role !== 'ADMIN') {
                        const avatarChar = s.name.charAt(0).toUpperCase();
                        dynamicList.innerHTML += `
                            <div class="user-item" onclick="openChat('${s.id}', '${s.name}', '${avatarChar}', '#10b981')" id="chat-${s.id}">
                                <div class="avatar-wrapper">
                                    <div class="avatar-initials" style="background:#10b981">${avatarChar}</div>
                                    <div class="status-dot"></div>
                                </div>
                                <div style="flex: 1; overflow: hidden;">
                                    <div style="font-weight: 700; color: var(--text-color); font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${s.name}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">${s.institution || 'Student'}</div>
                                </div>
                            </div>
                        `;
                    }
                });
            } catch (e) { console.warn("User list sync offline."); }
        }

        // --- 3. UI TOGGLES ---
        function toggleMenu(menuId) {
            document.querySelectorAll('.popover-menu').forEach(m => {
                if(m.id !== menuId) m.classList.remove('active');
            });
            document.getElementById(menuId).classList.toggle('active');
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('msg-input');
            input.value += emoji;
            input.focus();
            document.getElementById('emojiMenu').classList.remove('active');
        }

        function openChat(id, name, avatarData, color) {
            activeChatId = id;
            resetEditState(); // Cancel any active edits when switching chats
            
            document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`chat-${id}`).classList.add('active');

            document.getElementById('chat-title').innerText = name;
            const avatarBox = document.getElementById('activeAvatar');
            avatarBox.style.background = color;
            avatarBox.innerHTML = id === 'general' ? '<i class="fas fa-globe-africa"></i>' : avatarData;

            if (window.innerWidth <= 850) {
                document.getElementById('mainLayout').classList.add('mobile-chat-active');
                document.getElementById('mobileBack').style.display = 'block';
            }

            document.getElementById('pinnedBanner').style.display = id === 'general' ? 'flex' : 'none';
            loadMessages(id);
        }

        function closeChat() {
            document.getElementById('mainLayout').classList.remove('mobile-chat-active');
        }

        function startCall() {
            const modal = document.getElementById('callModal');
            document.getElementById('callName').innerText = document.getElementById('chat-title').innerText;
            document.getElementById('callAvatarBg').innerHTML = document.getElementById('activeAvatar').innerHTML;
            document.getElementById('callAvatarBg').style.background = document.getElementById('activeAvatar').style.background;
            modal.style.display = 'flex';
        }

        // --- 4. MESSAGE ENGINE ---
        async function loadMessages(chatId, isSilentRefresh = false) {
            const container = document.getElementById('msg-container');
            
            if (chatId === 'general') {
                try {
                    const res = await fetch('/api/chat');
                    const messages = await res.json();
                    
                    if(isSilentRefresh && container.childElementCount - 1 >= messages.length) return;

                    container.innerHTML = `<div style="text-align: center; margin: 20px 0;"><span style="background: var(--input-bg); padding: 5px 15px; border-radius: 20px; font-size: 0.75rem; color: var(--text-muted); font-weight: bold; border: 1px solid var(--border-color);">SECURE P2P CONNECTION ESTABLISHED</span></div>`;
                    
                    messages.forEach(msg => {
                        const type = msg.user_name === currentUser ? 'out' : 'in';
                        const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        appendMessageUI(msg.user_name, msg.message, type, time, msg.user_name.includes('Admin'), msg.id || Date.now(), true);
                    });
                    
                    if(!isSilentRefresh) scrollToBottom();

                } catch (e) { 
                    if(!isSilentRefresh) container.innerHTML = '<p style="text-align:center; color:red;">Database offline.</p>'; 
                }
            } else {
                const history = JSON.parse(localStorage.getItem(`chat_history_${chatId}`)) || [];
                container.innerHTML = '<div style="text-align: center; margin: 20px 0;"><span style="background: var(--input-bg); padding: 5px 15px; border-radius: 20px; font-size: 0.75rem; color: var(--text-muted); font-weight: bold; border: 1px solid var(--border-color);">END-TO-END ENCRYPTED</span></div>';
                history.forEach(msg => appendMessageUI(msg.sender, msg.text, msg.type, msg.time, false, msg.id, msg.isRead, msg.isEdited));
                scrollToBottom();
            }
        }

        function handleSendAction() {
            if (isEditing) saveEditedMessage();
            else sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !activeChatId) return;

            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const tempId = Date.now();

            if (activeChatId === 'general') {
                try {
                    await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: text }) 
                    });
                    input.value = '';
                    loadMessages('general');
                } catch (e) { alert("Server connection error."); }
            } else {
                const history = JSON.parse(localStorage.getItem(`chat_history_${activeChatId}`)) || [];
                // Push new message object. isRead is false initially.
                history.push({ id: tempId, sender: currentUser, text: text, type: 'out', time: time, isRead: false, isEdited: false });
                localStorage.setItem(`chat_history_${activeChatId}`, JSON.stringify(history));
                
                // Append to UI immediately (will have single grey tick)
                const newMsgEl = appendMessageUI(currentUser, text, 'out', time, false, tempId, false, false);
                input.value = '';
                scrollToBottom();

                // Simulate "Read Receipt" turning blue after 2 seconds
                setTimeout(() => {
                    const h = JSON.parse(localStorage.getItem(`chat_history_${activeChatId}`)) || [];
                    const msgToUpdate = h.find(m => m.id === tempId);
                    if(msgToUpdate) {
                        msgToUpdate.isRead = true;
                        localStorage.setItem(`chat_history_${activeChatId}`, JSON.stringify(h));
                        
                        // Update UI Tick to Blue
                        if(newMsgEl) {
                            const tick = newMsgEl.querySelector('.read-receipt');
                            if(tick) {
                                tick.classList.add('read');
                                tick.innerHTML = '<i class="fas fa-check-double"></i>';
                            }
                        }
                    }
                }, 2000);
            }
        }

        // --- 5. EDIT PROTOCOL ---
        function initiateEdit(id, text, element) {
            isEditing = true;
            editMsgId = id;
            editMsgElement = element;

            const input = document.getElementById('msg-input');
            const btn = document.getElementById('sendBtn');
            const micBtn = document.getElementById('micBtn');

            input.value = text;
            input.classList.add('edit-mode');
            input.focus();
            
            btn.innerHTML = '<i class="fas fa-check"></i>';
            btn.classList.add('edit-mode');
            micBtn.style.display = 'none'; // Hide mic during edit
        }

        function saveEditedMessage() {
            const input = document.getElementById('msg-input');
            const newText = input.value.trim();
            
            if (!newText) { resetEditState(); return; } // If empty, cancel edit

            if (activeChatId !== 'general') {
                const history = JSON.parse(localStorage.getItem(`chat_history_${activeChatId}`)) || [];
                const msgIndex = history.findIndex(m => m.id === editMsgId);
                
                if (msgIndex !== -1) {
                    history[msgIndex].text = newText;
                    history[msgIndex].isEdited = true;
                    localStorage.setItem(`chat_history_${activeChatId}`, JSON.stringify(history));
                    
                    // Update UI Bubble directly without full reload
                    const bubble = editMsgElement.querySelector('.msg-bubble');
                    // We clear it out and re-insert the text and the (edited) tag
                    bubble.innerHTML = newText + '<span class="edited-tag">(edited)</span>';
                }
            } else {
                alert("Editing messages in the National General Room requires Admin clearance.");
            }

            resetEditState();
        }

        function resetEditState() {
            isEditing = false;
            editMsgId = null;
            editMsgElement = null;

            const input = document.getElementById('msg-input');
            const btn = document.getElementById('sendBtn');
            const micBtn = document.getElementById('micBtn');

            input.value = '';
            input.classList.remove('edit-mode');
            
            btn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            btn.classList.remove('edit-mode');
            micBtn.style.display = 'block';
        }


        // --- 6. PREMIUM MESSAGE RENDERER ---
        function appendMessageUI(senderName, text, type, time, isAdmin = false, msgId = null, isRead = false, isEdited = false) {
            const container = document.getElementById('msg-container');
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg-wrapper ${type}`;
            msgDiv.dataset.id = msgId; // Store ID for editing finding
            
            // Handle Code Formatting
            let bubbleContent = text;
            if (text.startsWith('/code ')) {
                const cleanCode = text.replace('/code ', '');
                bubbleContent = `
                    <div class="code-block">
                        <div class="code-header"><span>Snippet</span><i class="far fa-copy" style="cursor:pointer;" title="Copy to clipboard"></i></div>
                        ${cleanCode}
                    </div>
                `;
            }

            // Append Edited Tag if true
            if (isEdited) {
                bubbleContent += '<span class="edited-tag">(edited)</span>';
            }

            const adminBadge = isAdmin ? 'admin-badge' : '';
            const senderLabel = type === 'in' ? `<div class="msg-sender ${adminBadge}">${senderName}</div>` : '';
            
            // Setup Read Receipts (Double Ticks) for OUT messages
            let tickHTML = '';
            if (type === 'out') {
                if (isRead) {
                    tickHTML = '<span class="read-receipt read"><i class="fas fa-check-double"></i></span>'; // Blue
                } else {
                    tickHTML = '<span class="read-receipt"><i class="fas fa-check"></i></span>'; // Grey Single Tick
                }
            }

            // Hover Tools (Includes new Edit button logic)
            const hoverTools = `
                <div class="msg-hover-tools">
                    <div class="tool-btn" title="React"><i class="far fa-smile"></i></div>
                    <div class="tool-btn" title="Reply in Thread"><i class="fas fa-reply"></i></div>
                    ${type === 'out' && !text.startsWith('/code ') ? `<div class="tool-btn" title="Edit" onclick="initiateEdit(${msgId}, '${text.replace(/'/g, "\\'")}', this.closest('.msg-wrapper'))"><i class="fas fa-pen"></i></div>` : ''}
                </div>
            `;

            let reactionsHTML = '';
            if(type === 'in' && !isAdmin && Math.random() > 0.6) {
                reactionsHTML = `
                    <div class="reactions">
                        <div class="reaction-badge" onclick="this.classList.toggle('active')">üëç ${Math.floor(Math.random()*5)+1}</div>
                    </div>
                `;
            }

            msgDiv.innerHTML = `
                ${senderLabel}
                <div class="msg-bubble">${bubbleContent}</div>
                ${reactionsHTML}
                <div class="msg-meta">
                    <span class="time">${time}</span>
                    ${tickHTML}
                </div>
                ${hoverTools}
            `;
            container.appendChild(msgDiv);
            return msgDiv; // Return element so we can update ticks later
        }

        // --- 7. PREMIUM VOICE NOTE SIMULATION ---
        let isRecording = false;
        function toggleRecording() {
            if (isEditing) return; // Disable audio recording while editing

            const micBtn = document.getElementById('micBtn');
            const input = document.getElementById('msg-input');
            
            isRecording = !isRecording;
            
            if (isRecording) {
                micBtn.classList.add('recording');
                input.value = "Recording high-fidelity audio... (0:03)";
                input.disabled = true;
            } else {
                micBtn.classList.remove('recording');
                input.value = "";
                input.disabled = false;
                
                const container = document.getElementById('msg-container');
                const timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const msgDiv = document.createElement('div');
                msgDiv.className = 'msg-wrapper out';
                msgDiv.innerHTML = `
                    <div class="msg-bubble" style="background: var(--primary-color); padding: 10px 15px;">
                        <div class="audio-msg">
                            <div class="play-btn" onclick="playAudioNote(this)"><i class="fas fa-play" style="color:white; font-size:0.8rem; margin-left: 2px;"></i></div>
                            <div class="audio-wave">
                                ${Array(15).fill(0).map(() => '<div class="wave-bar"></div>').join('')}
                            </div>
                            <span class="audio-timer" style="font-size:0.75rem; font-weight:bold; color:white; min-width: 25px;">0:03</span>
                        </div>
                    </div>
                    <div class="msg-meta">
                        <span class="time">${timeStr}</span>
                        <span class="read-receipt"><i class="fas fa-check"></i></span>
                    </div>
                `;
                container.appendChild(msgDiv);
                scrollToBottom();

                // Make the tick turn blue after 2 seconds
                setTimeout(() => {
                    const tick = msgDiv.querySelector('.read-receipt');
                    if(tick) {
                        tick.classList.add('read');
                        tick.innerHTML = '<i class="fas fa-check-double"></i>';
                    }
                }, 2000);
            }
        }

        // Play audio logic with animations
        function playAudioNote(btn) {
            const icon = btn.querySelector('i');
            const waveBars = btn.nextElementSibling.querySelectorAll('.wave-bar');
            const timer = btn.nextElementSibling.nextElementSibling;

            if (icon.classList.contains('fa-play')) {
                // Play State
                icon.classList.remove('fa-play');
                icon.classList.add('fa-pause');
                icon.style.marginLeft = '0px';
                
                // Animate waves
                waveBars.forEach((bar, i) => {
                    bar.classList.add('active');
                    bar.style.animationDelay = `${i * 0.1}s`;
                });

                // Simulate countdown
                let timeLeft = 3;
                btn.dataset.interval = setInterval(() => {
                    timeLeft--;
                    timer.innerText = `0:0${timeLeft}`;
                    if(timeLeft <= 0) {
                        clearInterval(btn.dataset.interval);
                        resetAudioNote(btn, waveBars, timer);
                    }
                }, 1000);

            } else {
                // Pause State
                clearInterval(btn.dataset.interval);
                resetAudioNote(btn, waveBars, timer);
            }
        }

        function resetAudioNote(btn, waveBars, timer) {
            const icon = btn.querySelector('i');
            icon.classList.remove('fa-pause');
            icon.classList.add('fa-play');
            icon.style.marginLeft = '2px';
            waveBars.forEach(bar => bar.classList.remove('active'));
            timer.innerText = "0:03";
        }

        function scrollToBottom() {
            const container = document.getElementById('msg-container');
            container.scrollTop = container.scrollHeight;
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') handleSendAction();
        }
    </script>
</body>
</html>