<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Connect | Secure Hub</title>
    
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="theme.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="db.js"></script> <style>
        /* --- 1. CORE LAYOUT & NAVBAR --- */
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-color); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        .navbar { height: 65px; background: var(--card-bg); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; flex-shrink: 0; z-index: 50; }
        .logo { font-weight: 800; font-size: 1.3rem; color: var(--primary-color); display: flex; align-items: center; gap: 10px; letter-spacing: -0.5px; }

        .chat-layout { display: grid; grid-template-columns: 340px 1fr; flex: 1; overflow: hidden; max-width: 1600px; margin: 0 auto; width: 100%; background: var(--bg-color); }

        /* --- 2. SIDEBAR (CHATS & HUBS) --- */
        .chat-sidebar { border-right: 1px solid var(--border-color); background: var(--card-bg); display: flex; flex-direction: column; overflow: hidden; z-index: 10; }
        
        .user-profile-widget { padding: 20px; text-align: center; border-bottom: 1px solid var(--border-color); background: var(--card-bg); display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--primary-color); object-fit: cover; background: #1e293b; flex-shrink: 0; }
        .user-info { text-align: left; overflow: hidden; }
        .user-name { font-weight: 700; color: var(--text-color); font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-role { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }

        .chat-search { padding: 20px; border-bottom: 1px solid var(--border-color); }
        .chat-search input { width: 100%; padding: 12px 18px; border-radius: 25px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); outline: none; font-size: 0.9rem; transition: 0.2s; }
        .chat-search input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        
        .user-list { flex: 1; overflow-y: auto; padding: 15px 10px; }
        .chat-category { font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin: 15px 10px 8px; display: flex; justify-content: space-between; align-items: center; }
        .add-btn { cursor: pointer; color: var(--primary-color); font-size: 1.1rem; transition: 0.2s; }
        .add-btn:hover { transform: scale(1.1); }
        
        .user-item { display: flex; align-items: center; gap: 15px; padding: 12px 15px; border-radius: 10px; cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; margin-bottom: 2px; }
        .user-item:hover { background: var(--input-bg); }
        .user-item.active { background: rgba(37, 99, 235, 0.08); border-left: 3px solid var(--primary-color); }

        .avatar-wrapper { position: relative; width: 45px; height: 45px; flex-shrink: 0; }
        .avatar-initials { width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; background: var(--primary-color); font-size: 1.2rem; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; position: absolute; bottom: 0; right: 0; border: 2px solid var(--card-bg); background: #10b981; }

        /* --- 3. MAIN CHAT AREA --- */
        .chat-main { display: flex; flex-direction: column; background: var(--bg-color); position: relative; min-width: 0; }
        
        .chat-header { padding: 15px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); flex-shrink: 0; height: 75px; z-index: 5; }
        .header-actions { display: flex; gap: 12px; }
        .action-icon { width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-muted); background: var(--input-bg); cursor: pointer; transition: 0.2s; font-size: 1.1rem; }
        .action-icon:hover { background: rgba(37, 99, 235, 0.1); color: var(--primary-color); }
        .action-icon.video:hover { background: rgba(16, 185, 129, 0.1); color: #10b981; }

        .pinned-banner { background: rgba(245, 158, 11, 0.1); border-bottom: 1px solid rgba(245, 158, 11, 0.2); padding: 12px 25px; display: flex; align-items: center; gap: 12px; font-size: 0.85rem; color: #d97706; cursor: pointer; transition: 0.2s; }
        .pinned-banner:hover { background: rgba(245, 158, 11, 0.15); }

        /* --- 4. MESSAGES FEED --- */
        .messages-area { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; background: url('https://www.transparenttextures.com/patterns/cubes.png'); }

        .msg-wrapper { display: flex; flex-direction: column; max-width: 70%; position: relative; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg-wrapper.in { align-self: flex-start; }
        .msg-wrapper.out { align-self: flex-end; align-items: flex-end; }
        
        .msg-sender { font-size: 0.75rem; font-weight: 700; color: var(--primary-color); margin-bottom: 5px; display: flex; align-items: center; gap: 6px; }
        .msg-sender.admin-badge::after { content: 'Admin'; background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .msg-bubble { padding: 14px 18px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.02); position: relative; }
        .msg-wrapper.in .msg-bubble { background: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); border-top-left-radius: 4px; }
        .msg-wrapper.out .msg-bubble { background: var(--primary-color); color: white; border-top-right-radius: 4px; }
        
        /* Message Meta (Time & Read Receipts) */
        .msg-meta { display: flex; align-items: center; gap: 5px; font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; font-weight: 500; }
        .msg-wrapper.out .msg-meta { justify-content: flex-end; }
        .read-receipt { font-size: 0.8rem; color: #3b82f6; transition: color 0.5s ease; } /* Force Blue tick in Live */

        .edited-tag { font-size: 0.65rem; opacity: 0.7; font-style: italic; margin-left: 5px; }

        .code-block { background: #0f172a; color: #e2e8f0; font-family: 'Fira Code', monospace; padding: 15px; border-radius: 8px; margin-top: 8px; font-size: 0.85rem; overflow-x: auto; border: 1px solid #334155; }
        .code-header { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px; border-bottom: 1px solid #334155; padding-bottom: 5px; display: flex; justify-content: space-between; }
        
        .reactions { display: flex; gap: 5px; margin-top: 6px; flex-wrap: wrap; }
        .reaction-badge { background: var(--input-bg); border: 1px solid var(--border-color); padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px; color: var(--text-color); transition: 0.2s; font-weight: 600; }
        .reaction-badge:hover, .reaction-badge.active { background: rgba(37,99,235,0.1); border-color: var(--primary-color); color: var(--primary-color); }

        .audio-msg { display: flex; align-items: center; gap: 12px; min-width: 240px; }
        .play-btn { width: 35px; height: 35px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .play-btn:hover { background: rgba(255,255,255,0.4); }
        .audio-wave { flex: 1; height: 30px; display: flex; align-items: center; gap: 2px; }
        .wave-bar { width: 3px; background: rgba(255,255,255,0.4); border-radius: 2px; transition: height 0.1s ease; }
        .wave-bar.active { background: white; animation: bounce 0.5s infinite alternate; }
        @keyframes bounce { 0% { height: 5px; } 100% { height: 25px; } }

        .msg-hover-tools { position: absolute; top: -15px; right: 10px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; display: flex; box-shadow: 0 4px 15px rgba(0,0,0,0.08); opacity: 0; transform: translateY(5px); transition: all 0.2s ease; z-index: 10; padding: 2px; }
        .msg-wrapper:hover .msg-hover-tools { opacity: 1; transform: translateY(0); }
        .msg-wrapper.out .msg-hover-tools { right: auto; left: 10px; }
        .tool-btn { padding: 6px 12px; cursor: pointer; color: var(--text-muted); font-size: 0.9rem; transition: 0.2s; border-radius: 6px; }
        .tool-btn:hover { background: var(--input-bg); color: var(--primary-color); }

        /* --- 5. INPUT & MENUS --- */
        .chat-input-area { padding: 18px 25px; border-top: 1px solid var(--border-color); display: flex; gap: 15px; background: var(--card-bg); align-items: center; z-index: 20; position: relative; }
        
        .input-tool-btn { background: none; border: none; color: var(--text-muted); font-size: 1.4rem; cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .input-tool-btn:hover { color: var(--primary-color); background: var(--input-bg); }
        
        .input-wrapper { flex: 1; position: relative; display: flex; align-items: center; }
        .chat-input { width: 100%; padding: 15px 50px 15px 20px; border-radius: 25px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); font-size: 0.95rem; outline: none; transition: 0.2s; font-family: inherit; }
        .chat-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .chat-input.edit-mode { border-color: #f59e0b; box-shadow: 0 0 0 3px rgba(245,158,11,0.1); }
        
        .voice-btn { position: absolute; right: 15px; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .voice-btn:hover { color: #dc2626; }
        .voice-btn.recording { color: #dc2626; animation: flash 1s infinite; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        
        .send-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--primary-color); color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); flex-shrink: 0; }
        .send-btn:hover { transform: scale(1.05); background: #1d4ed8; }
        .send-btn.edit-mode { background: #f59e0b; box-shadow: 0 4px 15px rgba(245,158,11,0.3); }
        .send-btn.edit-mode:hover { background: #d97706; }

        .popover-menu { position: absolute; bottom: 85px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: none; z-index: 100; animation: slideUp 0.2s ease-out; }
        .popover-menu.active { display: block; }
        @keyframes slideUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        
        .attach-menu { left: 25px; width: 220px; }
        .menu-item { padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: var(--text-color); border-radius: 8px; font-size: 0.95rem; font-weight: 600; transition: 0.2s; }
        .menu-item:hover { background: var(--input-bg); }
        .menu-icon { width: 30px; display: flex; justify-content: center; font-size: 1.1rem; }

        .emoji-menu { right: 85px; width: 280px; display: none; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 15px; }
        .emoji-menu.active { display: grid; }
        .emoji-item { font-size: 1.5rem; cursor: pointer; text-align: center; padding: 5px; border-radius: 8px; transition: 0.2s; }
        .emoji-item:hover { background: var(--input-bg); transform: scale(1.2); }

        /* --- 6. UNIVERSAL MODALS --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        
        .call-avatar { width: 150px; height: 150px; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 4rem; background: var(--primary-color); color: white; position: relative; }
        .call-avatar::after { content:''; position: absolute; width:100%; height:100%; border-radius:50%; border:2px solid var(--primary-color); animation: ripple 2s infinite; }
        @keyframes ripple { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

        .modal-content { background: var(--card-bg); padding: 35px; border-radius: 16px; max-width: 450px; width: 90%; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid var(--border-color); }
        .close-modal { position: absolute; top: 15px; right: 20px; color: var(--text-muted); font-size: 2rem; cursor: pointer; transition: 0.2s; z-index: 10; }
        .close-modal:hover { color: #ef4444; }

        @media (max-width: 850px) {
            .chat-layout { display: block; position: relative; }
            .chat-sidebar { width: 100%; height: 100%; position: absolute; border: none; }
            .chat-main { display: none; height: 100%; }
            .chat-layout.mobile-chat-active .chat-sidebar { display: none; }
            .chat-layout.mobile-chat-active .chat-main { display: flex; }
        }
    </style>
</head>
<body>

    <div id="createHubModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModals()">&times;</span>
            <h2 style="margin: 0 0 10px; color: var(--text-color);"><i class="fas fa-satellite-dish" style="color: var(--primary-color);"></i> Create Public Hub</h2>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 25px;">Establish a new topic-based chat room. This hub will be visible to all verified students on the National Network.</p>
            
            <form onsubmit="event.preventDefault(); createHub();">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase;">Hub Name</label>
                <input type="text" id="newHubName" placeholder="e.g. Computer Science Class of '26" style="width: 100%; padding: 14px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); font-family: inherit; font-size: 0.95rem; box-sizing: border-box; margin-bottom: 25px;" required>
                
                <button type="submit" id="createHubBtn" style="width: 100%; padding: 14px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 1rem;">
                    Launch Hub
                </button>
            </form>
        </div>
    </div>

    <div id="callModal" class="modal">
        <div style="text-align: center; color: white;">
            <div class="call-avatar" id="callAvatarBg"><i class="fas fa-video"></i></div>
            <div style="font-size: 2rem; font-weight: 800; margin-bottom: 10px;" id="callName">...</div>
            <div style="font-size: 1.1rem; color: #94a3b8; margin-bottom: 40px; letter-spacing: 2px; text-transform: uppercase;" id="callStatus">Establishing Secure P2P Connection...</div>
            
            <div style="display: flex; justify-content: center; gap: 30px;">
                <button style="width: 65px; height: 65px; border-radius: 50%; border: none; font-size: 1.5rem; cursor: pointer; color: white; background: rgba(255,255,255,0.2); backdrop-filter: blur(5px);"><i class="fas fa-microphone-slash"></i></button>
                <button style="width: 65px; height: 65px; border-radius: 50%; border: none; font-size: 1.5rem; cursor: pointer; color: white; background: #ef4444; box-shadow: 0 0 20px rgba(239,68,68,0.4);" onclick="closeModals()"><i class="fas fa-phone-slash"></i></button>
            </div>
        </div>
    </div>

    <nav class="navbar">
        <div class="logo"><i class="fas fa-network-wired"></i> Student Connect</div>
        <div style="display: flex; gap: 20px; align-items: center;">
            <a href="dashboard.html" style="font-weight: 600; text-decoration: none; color: var(--text-color); display: flex; align-items: center; gap: 8px;"><i class="fas fa-arrow-left"></i> Dashboard</a>
            <div class="theme-wrapper">
                <select onchange="setTheme(this.value)" style="padding: 8px 12px; border-radius: 8px; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); cursor: pointer; font-weight: 600;">
                    <option value="system">üíª System</option>
                    <option value="light">‚òÄÔ∏è Light</option>
                    <option value="dark">üåô Dark</option>
                </select>
            </div>
        </div>
    </nav>

    <div class="chat-layout" id="mainLayout">
        
        <aside class="chat-sidebar">
            <div class="user-profile-widget">
                <img id="sidebar-pic" src="https://via.placeholder.com/45" class="user-avatar" alt="Profile">
                <div class="user-info">
                    <div id="sidebar-name" class="user-name">User</div>
                    <div id="sidebar-role" class="user-role">Verified Student</div>
                </div>
            </div>

            <div class="chat-search">
                <input type="text" id="searchInput" placeholder="Search hubs or students...">
            </div>
            
            <div class="user-list" id="userList">
                <div class="chat-category">
                    <span>Public Hubs</span>
                    <i class="fas fa-plus-circle add-btn" title="Create Hub" onclick="openCreateHubModal()"></i>
                </div>
                
                <div id="dynamic-hubs">
                    </div>

                <div class="chat-category" style="margin-top: 25px;">Direct Messages</div>
                <div id="dynamic-users">
                    <div style="text-align: center; color: var(--text-muted); font-size: 0.85rem; margin-top: 10px;">
                        <i class="fas fa-circle-notch fa-spin"></i> Syncing User Directory...
                    </div>
                </div>
            </div>
        </aside>

        <main class="chat-main">
            <header class="chat-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-arrow-left" style="font-size: 1.3rem; cursor: pointer; display: none; color: var(--text-color);" id="mobileBack" onclick="closeChat()"></i>
                    <div class="avatar-wrapper" style="width: 45px; height: 45px;">
                        <div class="avatar-initials" id="activeAvatar" style="background:#2563eb"><i class="fas fa-globe-africa"></i></div>
                    </div>
                    <div>
                        <h3 id="chat-title" style="margin: 0; font-size: 1.15rem;">National General Room</h3>
                        <div id="chat-status" style="font-size: 0.8rem; color: #10b981; font-weight: 600; margin-top: 2px;">Cloud Server Connected</div>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="action-icon" title="Search Thread"><i class="fas fa-search"></i></div>
                    <div class="action-icon" title="Shared Media"><i class="fas fa-folder-open"></i></div>
                    <div class="action-icon video" title="Start WebRTC Call" onclick="startCall()"><i class="fas fa-video"></i></div>
                </div>
            </header>

            <div class="pinned-banner" id="pinnedBanner">
                <i class="fas fa-thumbtack"></i>
                <div style="flex: 1;"><strong>Pinned by Admin:</strong> Welcome to the Secure Hub. Please ensure all shared code snippets and library documents follow academic integrity guidelines.</div>
            </div>

            <div class="messages-area" id="msg-container">
                </div>

            <div class="popover-menu attach-menu" id="attachMenu">
                <div class="menu-item">
                    <div class="menu-icon"><i class="fas fa-image" style="color: #a855f7;"></i></div> Photos & Video
                </div>
                <div class="menu-item">
                    <div class="menu-icon"><i class="fas fa-file-pdf" style="color: #ef4444;"></i></div> Document
                </div>
                <div class="menu-item" style="border-top: 1px solid var(--border-color); margin-top: 5px; padding-top: 10px;">
                    <div class="menu-icon"><i class="fas fa-book" style="color: #10b981;"></i></div> Link Library Item
                </div>
            </div>

            <div class="popover-menu emoji-menu" id="emojiMenu">
                <div class="emoji-item" onclick="insertEmoji('üëç')">üëç</div>
                <div class="emoji-item" onclick="insertEmoji('üëè')">üëè</div>
                <div class="emoji-item" onclick="insertEmoji('üí°')">üí°</div>
                <div class="emoji-item" onclick="insertEmoji('üéØ')">üéØ</div>
                <div class="emoji-item" onclick="insertEmoji('‚úÖ')">‚úÖ</div>
                <div class="emoji-item" onclick="insertEmoji('üî•')">üî•</div>
                <div class="emoji-item" onclick="insertEmoji('üöÄ')">üöÄ</div>
                <div class="emoji-item" onclick="insertEmoji('üíØ')">üíØ</div>
                <div class="emoji-item" onclick="insertEmoji('üìö')">üìö</div>
                <div class="emoji-item" onclick="insertEmoji('üôè')">üôè</div>
            </div>

            <div class="chat-input-area">
                <button class="input-tool-btn" onclick="toggleMenu('attachMenu')" title="Attach Media"><i class="fas fa-paperclip"></i></button>
                
                <div class="input-wrapper">
                    <input type="text" id="msg-input" class="chat-input" placeholder="Type a message or use /code for snippets..." onkeypress="handleKeyPress(event)">
                    <div class="voice-btn" id="micBtn" title="Hold to Record Audio" onclick="toggleRecording()"><i class="fas fa-microphone"></i></div>
                </div>
                
                <button class="input-tool-btn" onclick="toggleMenu('emojiMenu')" title="Insert Emoji/Sticker"><i class="far fa-smile"></i></button>
                <button class="send-btn" id="sendBtn" onclick="handleSendAction()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </main>
    </div>

    <script>
        // --- 1. GLOBAL STATE & DB SYNC ---
        let activeChatId = 'general';
        const currentUser = localStorage.getItem('portal-user-name') || 'Student';
        let currentChatListener = null; // Important to prevent duplicate messages when switching rooms
        
        // Editing State Tracking
        let isEditing = false;
        let editMsgId = null; 

        document.addEventListener('DOMContentLoaded', () => {
            // Sync Identity Profile
            const name = localStorage.getItem('portal-user-name') || 'Student User';
            const pic = localStorage.getItem('portal-avatar');
            const elName = document.getElementById('sidebar-name');
            if(elName) elName.innerText = name;
            if(pic && document.getElementById('sidebar-pic')) document.getElementById('sidebar-pic').src = pic;

            loadLiveUsers(); // Firebase User Directory
            loadLiveHubs();  // Firebase Hubs
            loadMessages('general'); // Open General Chat by default

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.chat-input-area')) {
                    document.getElementById('attachMenu').classList.remove('active');
                    document.getElementById('emojiMenu').classList.remove('active');
                }
            });
        });

        // --- 2. FIREBASE USER DIRECTORY (LIVE) ---
        function loadLiveUsers() {
            db.ref('users').on('value', (snapshot) => {
                const dynamicList = document.getElementById('dynamic-users');
                dynamicList.innerHTML = '';
                
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const s = child.val();
                        // Don't show yourself in the DM list, and don't show Admin (optional)
                        if (s.name !== currentUser && s.role !== 'ADMIN') {
                            const avatarChar = s.name.charAt(0).toUpperCase();
                            // Generate a consistent color based on name length
                            const colors = ['#ec4899', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
                            const color = colors[s.name.length % colors.length];
                            
                            // Use unique ID to create a private chat room between the two users
                            const roomId = generatePrivateRoomId(currentUser, s.name);

                            dynamicList.innerHTML += `
                                <div class="user-item" onclick="openChat('${roomId}', '${s.name}', '${avatarChar}', '${color}')" id="chat-${roomId}">
                                    <div class="avatar-wrapper">
                                        <div class="avatar-initials" style="background:${color}">${avatarChar}</div>
                                        <div class="status-dot"></div>
                                    </div>
                                    <div style="flex: 1; overflow: hidden;">
                                        <div style="font-weight: 700; color: var(--text-color); font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${s.name}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">${s.institution || 'Student'}</div>
                                    </div>
                                </div>
                            `;
                        }
                    });
                } else {
                    dynamicList.innerHTML = '<div style="text-align: center; color: var(--text-muted); font-size: 0.85rem; margin-top: 10px;">No registered users found.</div>';
                }
            });
        }

        function generatePrivateRoomId(user1, user2) {
            // Sort names alphabetically so user1->user2 is the same room as user2->user1
            return [user1, user2].sort().join('_').replace(/[^a-zA-Z0-9]/g, '');
        }

        // --- 3. DYNAMIC HUB CREATION (LIVE) ---
        function openCreateHubModal() { document.getElementById('createHubModal').style.display = 'flex'; }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

        function createHub() {
            const name = document.getElementById('newHubName').value.trim();
            if(!name) return;

            const hubId = 'hub_' + Date.now();
            
            db.ref('hubs').push({ id: hubId, name: name })
            .then(() => {
                closeModals();
                document.getElementById('newHubName').value = '';
                openChat(hubId, name, '<i class="fas fa-users"></i>', '#f59e0b');
            });
        }

        function loadLiveHubs() {
            db.ref('hubs').on('value', (snapshot) => {
                const container = document.getElementById('dynamic-hubs');
                
                // Always keep General Room at top
                container.innerHTML = `
                    <div class="user-item active" onclick="openChat('general', 'National General Room', '<i class=\\'fas fa-globe-africa\\'></i>', '#2563eb')" id="chat-general">
                        <div class="avatar-wrapper">
                            <div class="avatar-initials" style="background:#2563eb"><i class="fas fa-globe-africa"></i></div>
                            <div class="status-dot"></div>
                        </div>
                        <div>
                            <div style="font-weight: 700; color: var(--text-color); font-size: 0.95rem;">National General Room</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Global Campus Hub</div>
                        </div>
                    </div>
                `;

                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const h = child.val();
                        container.innerHTML += `
                            <div class="user-item" onclick="openChat('${h.id}', '${h.name.replace(/'/g, "\\'")}', '<i class=\\'fas fa-users\\'></i>', '#f59e0b')" id="chat-${h.id}">
                                <div class="avatar-wrapper">
                                    <div class="avatar-initials" style="background:#f59e0b"><i class="fas fa-users"></i></div>
                                    <div class="status-dot"></div>
                                </div>
                                <div style="flex: 1; overflow: hidden;">
                                    <div style="font-weight: 700; color: var(--text-color); font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${h.name}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Public Hub</div>
                                </div>
                            </div>
                        `;
                    });
                }
            });
        }


        // --- 4. UI TOGGLES ---
        function toggleMenu(menuId) {
            document.querySelectorAll('.popover-menu').forEach(m => {
                if(m.id !== menuId) m.classList.remove('active');
            });
            document.getElementById(menuId).classList.toggle('active');
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('msg-input');
            input.value += emoji;
            input.focus();
            document.getElementById('emojiMenu').classList.remove('active');
        }

        function openChat(id, name, avatarData, color) {
            activeChatId = id;
            resetEditState(); 
            
            document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
            const targetEl = document.getElementById(`chat-${id}`);
            if(targetEl) targetEl.classList.add('active');

            document.getElementById('chat-title').innerText = name;
            const avatarBox = document.getElementById('activeAvatar');
            avatarBox.style.background = color;
            avatarBox.innerHTML = avatarData;

            if (window.innerWidth <= 850) {
                document.getElementById('mainLayout').classList.add('mobile-chat-active');
                document.getElementById('mobileBack').style.display = 'block';
            }

            document.getElementById('pinnedBanner').style.display = id === 'general' ? 'flex' : 'none';
            loadMessages(id);
        }

        function closeChat() {
            document.getElementById('mainLayout').classList.remove('mobile-chat-active');
        }

        function startCall() {
            const modal = document.getElementById('callModal');
            document.getElementById('callName').innerText = document.getElementById('chat-title').innerText;
            document.getElementById('callAvatarBg').innerHTML = document.getElementById('activeAvatar').innerHTML;
            document.getElementById('callAvatarBg').style.background = document.getElementById('activeAvatar').style.background;
            modal.style.display = 'flex';
        }

        // --- 5. FIREBASE LIVE MESSAGE ENGINE ---
        function loadMessages(chatId) {
            const container = document.getElementById('msg-container');
            
            // Unsubscribe from previous chat room to prevent overlapping messages
            if (currentChatListener) {
                currentChatListener.off();
            }

            let statusText = chatId === 'general' ? 'NATIONAL GLOBAL NETWORK' : 'END-TO-END ENCRYPTED (LIVE)';
            container.innerHTML = `<div style="text-align: center; margin: 20px 0;"><span style="background: var(--input-bg); padding: 5px 15px; border-radius: 20px; font-size: 0.75rem; color: var(--text-muted); font-weight: bold; border: 1px solid var(--border-color);">${statusText}</span></div>`;
            
            if (chatId === 'general') {
                appendMessageUI('Directorate Admin', 'Welcome to the Live National Portal Secure Hub. All messages sent here are synced globally to all connected users.', 'in', new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), true, 'admin1', true, false);
            }

            // Set up Real-Time Listener
            currentChatListener = db.ref('chats/' + chatId);
            
            // Listen for NEW messages added to the database
            currentChatListener.on('child_added', (snapshot) => {
                const msg = snapshot.val();
                const key = snapshot.key;
                const type = msg.sender === currentUser ? 'out' : 'in';
                
                appendMessageUI(msg.sender, msg.text, type, msg.time, msg.sender.includes('Admin'), key, true, msg.isEdited);
                scrollToBottom();
            });

            // Listen for EDITED messages in the database
            currentChatListener.on('child_changed', (snapshot) => {
                const msg = snapshot.val();
                const msgEl = document.querySelector(`.msg-wrapper[data-id="${snapshot.key}"]`);
                if(msgEl && msg.isEdited) {
                    const bubble = msgEl.querySelector('.msg-bubble');
                    if(msg.text.startsWith('/code ')) {
                        const cleanCode = msg.text.replace('/code ', '');
                        bubble.innerHTML = `<div class="code-block"><div class="code-header"><span>Snippet</span></div>${cleanCode}</div><span class="edited-tag">(edited)</span>`;
                    } else {
                        bubble.innerHTML = msg.text + '<span class="edited-tag">(edited)</span>';
                    }
                }
            });
        }

        function handleSendAction() {
            if (isEditing) saveEditedMessage();
            else sendMessage();
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !activeChatId) return;

            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const payload = {
                sender: currentUser,
                text: text,
                time: time,
                isEdited: false
            };

            // Push to Firebase. The 'child_added' listener will automatically pick it up and render it!
            db.ref('chats/' + activeChatId).push(payload);
            input.value = '';
            
            // Still trigger the auto-reply bot for presentation flair
            simulateBotResponse(activeChatId, text);
        }

        function simulateBotResponse(chatId, userMessage) {
            // Random chance to get an automated reply in General room
            if (chatId === 'general' && Math.random() > 0.4) {
                setTimeout(() => {
                    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    db.ref('chats/' + chatId).push({
                        sender: 'System Bot',
                        text: "Welcome to the Hub! Have you checked the new Library resources yet?",
                        time: time,
                        isEdited: false
                    });
                }, 3500);
            } else if (chatId !== 'general' && !chatId.startsWith('hub_')) {
                // If it's a DM, reply that user is offline
                setTimeout(() => {
                    const chatTitle = document.getElementById('chat-title').innerText;
                    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    db.ref('chats/' + chatId).push({
                        sender: chatTitle,
                        text: `(Auto-Reply): I am currently offline. I will check my messages later!`,
                        time: time,
                        isEdited: false
                    });
                }, 2000);
            }
        }

        // --- 6. EDIT PROTOCOL (LIVE) ---
        function initiateEdit(id, text, element) {
            isEditing = true;
            editMsgId = id; // Firebase Key

            const input = document.getElementById('msg-input');
            const btn = document.getElementById('sendBtn');
            const micBtn = document.getElementById('micBtn');

            input.value = text;
            input.classList.add('edit-mode');
            input.focus();
            
            btn.innerHTML = '<i class="fas fa-check"></i>';
            btn.classList.add('edit-mode');
            micBtn.style.display = 'none'; 
        }

        function saveEditedMessage() {
            const input = document.getElementById('msg-input');
            const newText = input.value.trim();
            
            if (!newText) { resetEditState(); return; } 

            // Update directly in Firebase. 'child_changed' listener will update UI.
            db.ref('chats/' + activeChatId + '/' + editMsgId).update({
                text: newText,
                isEdited: true
            });

            resetEditState();
        }

        function resetEditState() {
            isEditing = false;
            editMsgId = null;

            const input = document.getElementById('msg-input');
            const btn = document.getElementById('sendBtn');
            const micBtn = document.getElementById('micBtn');

            input.value = '';
            input.classList.remove('edit-mode');
            
            btn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            btn.classList.remove('edit-mode');
            micBtn.style.display = 'block';
        }

        // --- 7. PREMIUM MESSAGE RENDERER ---
        function appendMessageUI(senderName, text, type, time, isAdmin = false, msgId = null, isRead = false, isEdited = false) {
            const container = document.getElementById('msg-container');
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg-wrapper ${type}`;
            msgDiv.dataset.id = msgId; // Store Firebase Key for editing
            
            let bubbleContent = text;
            if (text.startsWith('/code ')) {
                const cleanCode = text.replace('/code ', '');
                bubbleContent = `
                    <div class="code-block">
                        <div class="code-header"><span>Snippet</span><i class="far fa-copy" style="cursor:pointer;" title="Copy to clipboard"></i></div>
                        ${cleanCode}
                    </div>
                `;
            }

            if (isEdited) {
                bubbleContent += '<span class="edited-tag">(edited)</span>';
            }

            const adminBadge = isAdmin ? 'admin-badge' : '';
            const senderLabel = type === 'in' ? `<div class="msg-sender ${adminBadge}">${senderName}</div>` : '';
            
            // Force read receipt to blue for live feel
            let tickHTML = '';
            if (type === 'out') {
                tickHTML = '<span class="read-receipt read"><i class="fas fa-check-double"></i></span>'; 
            }

            const hoverTools = `
                <div class="msg-hover-tools">
                    <div class="tool-btn" title="React"><i class="far fa-smile"></i></div>
                    <div class="tool-btn" title="Reply in Thread"><i class="fas fa-reply"></i></div>
                    ${type === 'out' && !text.startsWith('/code ') ? `<div class="tool-btn" title="Edit" onclick="initiateEdit('${msgId}', '${text.replace(/'/g, "\\'")}', this.closest('.msg-wrapper'))"><i class="fas fa-pen"></i></div>` : ''}
                </div>
            `;

            let reactionsHTML = '';
            if(type === 'in' && !isAdmin && Math.random() > 0.6) {
                reactionsHTML = `
                    <div class="reactions">
                        <div class="reaction-badge" onclick="this.classList.toggle('active')">üëç ${Math.floor(Math.random()*5)+1}</div>
                    </div>
                `;
            }

            msgDiv.innerHTML = `
                ${senderLabel}
                <div class="msg-bubble">${bubbleContent}</div>
                ${reactionsHTML}
                <div class="msg-meta">
                    <span class="time">${time}</span>
                    ${tickHTML}
                </div>
                ${hoverTools}
            `;
            container.appendChild(msgDiv);
            return msgDiv; 
        }

        // --- 8. PREMIUM VOICE NOTE SIMULATION ---
        let isRecording = false;
        function toggleRecording() {
            if (isEditing) return; 

            const micBtn = document.getElementById('micBtn');
            const input = document.getElementById('msg-input');
            
            isRecording = !isRecording;
            
            if (isRecording) {
                micBtn.classList.add('recording');
                input.value = "Recording high-fidelity audio... (0:03)";
                input.disabled = true;
            } else {
                micBtn.classList.remove('recording');
                input.value = "";
                input.disabled = false;
                
                const timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // We fake the audio note push for UI appeal
                const container = document.getElementById('msg-container');
                const msgDiv = document.createElement('div');
                msgDiv.className = 'msg-wrapper out';
                msgDiv.innerHTML = `
                    <div class="msg-bubble" style="background: var(--primary-color); padding: 10px 15px;">
                        <div class="audio-msg">
                            <div class="play-btn" onclick="playAudioNote(this)"><i class="fas fa-play" style="color:white; font-size:0.8rem; margin-left: 2px;"></i></div>
                            <div class="audio-wave">
                                ${Array(15).fill(0).map(() => '<div class="wave-bar"></div>').join('')}
                            </div>
                            <span class="audio-timer" style="font-size:0.75rem; font-weight:bold; color:white; min-width: 25px;">0:03</span>
                        </div>
                    </div>
                    <div class="msg-meta">
                        <span class="time">${timeStr}</span>
                        <span class="read-receipt read"><i class="fas fa-check-double"></i></span>
                    </div>
                `;
                container.appendChild(msgDiv);
                scrollToBottom();
            }
        }

        function playAudioNote(btn) {
            const icon = btn.querySelector('i');
            const waveBars = btn.nextElementSibling.querySelectorAll('.wave-bar');
            const timer = btn.nextElementSibling.nextElementSibling;

            if (icon.classList.contains('fa-play')) {
                icon.classList.remove('fa-play');
                icon.classList.add('fa-pause');
                icon.style.marginLeft = '0px';
                
                waveBars.forEach((bar, i) => {
                    bar.classList.add('active');
                    bar.style.animationDelay = `${i * 0.1}s`;
                });

                let timeLeft = 3;
                btn.dataset.interval = setInterval(() => {
                    timeLeft--;
                    timer.innerText = `0:0${timeLeft}`;
                    if(timeLeft <= 0) {
                        clearInterval(btn.dataset.interval);
                        resetAudioNote(btn, waveBars, timer);
                    }
                }, 1000);

            } else {
                clearInterval(btn.dataset.interval);
                resetAudioNote(btn, waveBars, timer);
            }
        }

        function resetAudioNote(btn, waveBars, timer) {
            const icon = btn.querySelector('i');
            icon.classList.remove('fa-pause');
            icon.classList.add('fa-play');
            icon.style.marginLeft = '2px';
            waveBars.forEach(bar => bar.classList.remove('active'));
            timer.innerText = "0:03";
        }

        function scrollToBottom() {
            const container = document.getElementById('msg-container');
            container.scrollTop = container.scrollHeight;
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') handleSendAction();
        }
    </script>
</body>
</html>