<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPA Calculator | Student Portal</title>
    
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="theme.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="db.js"></script> <style>
        /* --- LAYOUT & CORE --- */
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; }
        .wrapper { display: flex; width: 100%; height: 100%; position: relative;}

        /* SIDEBAR (Consistent) */
        .sidebar { width: 260px; background: #0f172a; color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; }
        .sidebar-header { padding: 25px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; font-size: 1.1rem;}
        .nav-links { list-style: none; padding: 20px; margin: 0; }
        .nav-links li { margin-bottom: 8px; }
        .nav-links a { display: flex; align-items: center; gap: 12px; color: #94a3b8; text-decoration: none; padding: 12px 15px; border-radius: 8px; transition: 0.2s; border-left: 3px solid transparent; font-weight: 500;}
        .nav-links a:hover, .nav-links a.active { background: linear-gradient(90deg, rgba(37, 99, 235, 0.2) 0%, transparent 100%); border-left: 3px solid #3b82f6; color: white; transform: translateX(4px); }

        /* MAIN SCROLLABLE AREA */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: var(--bg-color); position: relative; }
        
        .gpa-layout {
            display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; max-width: 1300px; margin: 0 auto;
        }

        /* --- CALCULATOR CARD --- */
        .calc-card {
            background: var(--card-bg); padding: 30px; border-radius: 16px;
            border: 1px solid var(--border-color); box-shadow: 0 4px 20px rgba(0,0,0,0.02);
        }

        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        h2 { margin: 0; font-size: 1.5rem; color: var(--text-color); }

        .scale-selector {
            padding: 10px 15px; border-radius: 8px; border: 1px solid var(--primary-color);
            background: var(--input-bg); color: var(--text-color); font-weight: 600; cursor: pointer;
        }

        /* INPUT ROWS */
        .course-header {
            display: grid; grid-template-columns: 1fr 2.5fr 1fr 1.5fr auto; gap: 15px;
            font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 15px;
        }
        .course-row {
            display: grid; grid-template-columns: 1fr 2.5fr 1fr 1.5fr auto; gap: 15px; margin-bottom: 12px; align-items: center;
            background: var(--bg-color); padding: 10px; border-radius: 10px; border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .course-row:hover { transform: translateX(5px); border-color: var(--primary-color); }

        input, select {
            width: 100%; padding: 10px; border: 1px solid var(--border-color);
            background: var(--card-bg); color: var(--text-color); border-radius: 6px;
            font-family: inherit; font-size: 0.95rem; box-sizing: border-box; transition: 0.2s;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        /* BUTTONS */
        .btn-remove {
            background: #fee2e2; color: #dc2626; border: 1px solid #fecaca;
            width: 38px; height: 38px; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .btn-remove:hover { background: #ef4444; color: white; transform: scale(1.1); }

        .btn-add {
            width: 100%; padding: 12px; border: 2px dashed var(--border-color); background: transparent;
            color: var(--text-muted); border-radius: 8px; font-weight: 600; cursor: pointer;
            margin-top: 15px; transition: 0.2s;
        }
        .btn-add:hover { border-color: var(--primary-color); color: var(--primary-color); background: rgba(37, 99, 235, 0.05); }

        .btn-calc {
            width: 100%; padding: 15px; background: var(--primary-color); color: white;
            border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700;
            cursor: pointer; margin-top: 20px; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
            transition: transform 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-calc:hover { transform: translateY(-2px); opacity: 0.95; }

        /* --- RESULT PANEL --- */
        .result-panel {
            background: var(--card-bg); border-radius: 16px; border: 1px solid var(--border-color);
            padding: 30px; position: sticky; top: 20px; text-align: center; height: fit-content;
        }

        .gpa-circle {
            width: 150px; height: 150px; margin: 0 auto 20px;
            border-radius: 50%; border: 8px solid var(--border-color);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 3.5rem; font-weight: 800; color: var(--text-color);
            position: relative; transition: border-color 0.5s ease;
        }
        .gpa-label { font-size: 0.9rem; color: var(--text-muted); font-weight: 600; margin-top: 5px; }

        .class-badge {
            display: inline-block; padding: 6px 15px; border-radius: 20px;
            font-weight: 800; font-size: 0.9rem; text-transform: uppercase;
            margin-bottom: 10px; background: var(--input-bg); color: var(--text-muted);
            letter-spacing: 0.5px;
        }

        /* Dynamic Remarks */
        .gpa-remarks {
            margin: 0 0 20px 0; font-size: 0.95rem; font-weight: 600; color: var(--text-muted); 
            line-height: 1.5; padding: 10px; border-radius: 8px; background: var(--input-bg);
            border: 1px dashed var(--border-color);
        }

        .action-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 25px; }
        
        .btn-save {
            background: #10b981; color: white; border: none;
            padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s; font-size: 1rem; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .btn-save:hover { background: #059669; transform: translateY(-2px); }

        .btn-download {
            background: transparent; color: var(--text-color); border: 2px solid var(--border-color);
            padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s; font-size: 1rem;
        }
        .btn-download:hover { border-color: var(--primary-color); color: var(--primary-color); background: var(--input-bg); }

        /* --- GRADING SCALE REFERENCE --- */
        .scale-ref { margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px; text-align: left; }
        .scale-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .scale-table th { text-align: left; color: var(--text-muted); padding: 5px 0; }
        .scale-table td { padding: 5px 0; border-bottom: 1px solid var(--border-color); }

        /* Mobile specific */
        .mobile-menu-btn { display: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color); }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 998; backdrop-filter: blur(3px); }

        @media (max-width: 1000px) { 
            .gpa-layout { grid-template-columns: 1fr; } 
            .sidebar { position: fixed; height: 100%; left: -280px; box-shadow: none; }
            .sidebar.mobile-open { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .sidebar-overlay.mobile-open { display: block; }
            .mobile-menu-btn { display: block; }
            .course-header { display: none; } 
            .course-row { grid-template-columns: 1fr 1fr; }
            .c-code { grid-column: 1 / 2; }
            .c-name { grid-column: 2 / -1; } 
            .btn-remove { grid-column: 1 / -1; width: 100%; }
        }

        /* ========================================================= */
        /* --- PREMIUM ENTERPRISE TRANSCRIPT PRINT ARCHITECTURE ---  */
        /* ========================================================= */
        .print-only-transcript { display: none; }

        @media print {
            @page { size: A4 portrait; margin: 15mm; }
            body { background: white !important; color: black !important; font-family: 'Inter', Helvetica, Arial, sans-serif; }
            
            /* Hide entire web UI */
            .wrapper, .sidebar, .mobile-menu-btn, .theme-wrapper, .gpa-layout { display: none !important; }
            
            /* Reveal Print DOM */
            .print-only-transcript { 
                display: block !important; 
                width: 100%; 
                text-transform: uppercase; /* Force ALL CAPS as requested */
            }

            /* Watermark Overlay */
            .print-only-transcript::after {
                content: "OFFICIAL TRANSCRIPT";
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg);
                font-size: 8rem; color: rgba(0,0,0,0.03); font-weight: 900; z-index: -1; white-space: nowrap; pointer-events: none;
            }

            /* Header Section */
            .t-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 4px double #000; padding-bottom: 20px; margin-bottom: 20px; }
            .t-logo { width: 110px; height: 110px; object-fit: contain; }
            .t-avatar { width: 110px; height: 110px; border-radius: 50%; border: 3px solid #000; object-fit: cover; }
            
            .t-title-block { text-align: center; flex: 1; padding: 0 20px; }
            .t-title-block h1 { margin: 0 0 5px 0; font-family: 'Playfair Display', serif; font-size: 22pt; font-weight: 900; letter-spacing: 1px;}
            .t-title-block h2 { margin: 0 0 8px 0; font-size: 14pt; font-weight: 700; color: #333; }
            .t-title-block h3 { margin: 0; font-size: 16pt; font-weight: 800; text-decoration: underline; letter-spacing: 2px;}

            /* Bio Data Section */
            .t-bio-grid { display: flex; justify-content: space-between; margin-bottom: 25px; font-size: 10.5pt; line-height: 1.8; }
            .t-bio-left { text-align: left; }
            .t-bio-right { text-align: right; }
            .t-bio-grid strong { width: 130px; display: inline-block; }

            /* Term Headers */
            .t-term-center { text-align: center; font-size: 12pt; font-weight: 900; margin: 15px 0; text-decoration: underline;}
            .t-term-left { text-align: left; font-size: 11pt; font-weight: 800; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;}

            /* Transcript Table */
            .t-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 10pt; }
            .t-table th, .t-table td { border: 1px solid #000; padding: 10px 8px; text-align: center; }
            .t-table th { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-weight: 800; }
            .t-table td:nth-child(1) { text-align: left; font-weight: bold; width: 15%; }
            .t-table td:nth-child(2) { text-align: left; width: 50%; }
            
            /* Summary */
            .t-summary { font-size: 12pt; font-weight: 900; margin-bottom: 50px; background: #f9f9f9 !important; -webkit-print-color-adjust: exact; padding: 10px; border: 1px solid #000; text-align: center; letter-spacing: 1px;}
            
            /* Signatures */
            .t-signatures { display: flex; justify-content: space-between; margin-bottom: 50px; }
            .t-sig-box { width: 250px; text-align: center; position: relative;}
            .t-sig-line { border-top: 1px solid #000; padding-top: 8px; font-size: 10pt; font-weight: 800; margin-top: 60px; }
            .t-stamp { position: absolute; top: 10px; left: 50%; transform: translate(-50%, -20%) rotate(-10deg); font-family: 'Playfair Display', serif; font-size: 24pt; color: rgba(0,0,0,0.3); border: 3px double rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 8px;}

            /* Barcode */
            .t-barcode-container { text-align: center; margin-top: auto; }
            .t-barcode { height: 60px; margin-bottom: 5px; }
            .t-index { font-family: monospace; font-size: 11pt; font-weight: bold; letter-spacing: 4px; }
        }
    </style>
</head>
<body>

    <div class="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

    <div class="print-only-transcript">
        <div class="t-header">
            <img id="t-logo" class="t-logo" src="" alt="University Logo">
            <div class="t-title-block">
                <h1 id="t-inst">NATIONAL TERTIARY PORTAL</h1>
                <h2 id="t-dept">DEPARTMENT OF GENERAL ACADEMICS</h2>
                <h3>STATEMENT OF RESULTS</h3>
            </div>
            <img id="t-avatar" class="t-avatar" src="https://via.placeholder.com/150" alt="Student Photo">
        </div>

        <div class="t-bio-grid">
            <div class="t-bio-left">
                <div><strong>STUDENT ID:</strong> <span id="t-id">...</span></div>
                <div><strong>NAME:</strong> <span id="t-name">...</span></div>
                <div><strong>PROGRAMME:</strong> <span id="t-prog">...</span></div>
                <div><strong>STUDY STATUS:</strong> ON-GOING</div>
            </div>
            <div class="t-bio-right">
                <div><strong>FEE CATEGORY:</strong> <span id="t-fee">REGULAR</span></div>
                <div><strong>LEVEL:</strong> <span id="t-level">...</span></div>
                <div><strong>DATE PRINTED:</strong> <span id="t-date">...</span></div>
                <div><strong>ACADEMIC YR:</strong> 2025/2026</div>
                <div><strong>SEMESTER:</strong> ONE</div>
            </div>
        </div>

        <div class="t-term-center">[FIRST YEAR(2025/2026)]</div>
        <div class="t-term-left">TRIMESTER 1</div>

        <table class="t-table">
            <thead>
                <tr>
                    <th>COURSE CODE</th>
                    <th>COURSE TITLE</th>
                    <th>CREDITS</th>
                    <th>MARK/SCORE</th>
                    <th>GRADE</th>
                </tr>
            </thead>
            <tbody id="t-tbody">
                </tbody>
        </table>

        <div class="t-summary" id="t-summary-text">
            CC (TOTAL CREDITS): 00 | GPA: 0.00 | CGPA: 0.00
        </div>

        <div class="t-signatures">
            <div class="t-sig-box">
                <div class="t-sig-line">STUDENT SIGNATURE</div>
            </div>
            <div class="t-sig-box">
                <div class="t-stamp">VERIFIED</div>
                <div class="t-sig-line">HEAD OF DEPARTMENT (HOD)</div>
                <div style="font-size: 9pt; margin-top: 5px;" id="t-sig-date">DATE: ...</div>
            </div>
        </div>

        <div class="t-barcode-container">
            <img id="t-barcode-img" class="t-barcode" src="" alt="Barcode">
            <div class="t-index" id="t-index-text">INDEX: 000000</div>
        </div>
    </div>
    <div class="wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-university"></i> Student Portal
                <i class="fas fa-times mobile-menu-btn" style="margin-left: auto; color: white;" onclick="toggleMobileSidebar()"></i>
            </div>
            <ul class="nav-links">
                <li><a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="profile.html"><i class="fas fa-user"></i> My Profile</a></li>
                <li><a href="leadership.html"><i class="fas fa-medal"></i> Leadership</a></li>
                <li><a href="courses.html"><i class="fas fa-book-open"></i> Courses</a></li>
                <li><a href="gpa.html" class="active"><i class="fas fa-calculator"></i> GPA Calc</a></li>
                <li><a href="library.html"><i class="fas fa-book"></i> Library</a></li>
                <li><a href="opportunities.html"><i class="fas fa-briefcase"></i> Opportunities Hub</a></li>
                <li><a href="connect.html"><i class="fas fa-comments"></i> Connect</a></li>
                <li style="margin-top: 20px;">
    <a href="#" onclick="executeSecureLogout(event)" style="color: #ef4444; border-left-color: transparent;">
        <i class="fas fa-sign-out-alt"></i> Logout
    </a>
</li>
            </ul>
        </aside>

        <main class="main-content">
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-bars mobile-menu-btn" onclick="toggleMobileSidebar()"></i>
                    <h1 style="margin:0; font-size: 1.8rem; font-weight: 800;">Academic Calculator</h1>
                </div>
                <div class="theme-wrapper">
                    <select onchange="setTheme(this.value)" style="padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); cursor: pointer; font-weight: 600;">
                        <option value="system">üíª System</option>
                        <option value="light">‚òÄÔ∏è Light</option>
                        <option value="dark">üåô Dark</option>
                    </select>
                </div>
            </div>

            <div class="gpa-layout">
                
                <section class="calc-card">
                    <div class="header-row">
                        <h2>Course Grades</h2>
                        <select id="scaleSelect" class="scale-selector" onchange="updateScaleReference()">
                            <option value="4.0">Standard 4.0 Scale</option>
                            <option value="5.0" selected>Weighted 5.0 Scale</option>
                        </select>
                    </div>

                    <form id="gpaForm" onsubmit="event.preventDefault(); calculate();">
                        <div class="course-header">
                            <span>Course Code</span>
                            <span>Course Title</span>
                            <span>Credits</span>
                            <span>Score (0-100)</span>
                            <span></span>
                        </div>

                        <div id="course-rows">
                            </div>

                        <button type="button" class="btn-add" onclick="addRow()">
                            <i class="fas fa-plus"></i> Add Another Course
                        </button>

                        <button type="submit" class="btn-calc">
                            <i class="fas fa-microchip"></i> Execute Calculation 
                        </button>
                    </form>
                </section>

                <aside class="result-panel" id="resultCard" style="opacity: 0.6; pointer-events: none;">
                    
                    <div id="gpaCircle" class="gpa-circle">
                        <span id="gpaValue">0.00</span>
                        <span class="gpa-label">CGPA</span>
                    </div>

                    <div id="classBadge" class="class-badge">Pending Calculation</div>

                    <div id="gpaRemarks" class="gpa-remarks">Input your scores and hit calculate to see your academic standing.</div>
                  
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                        <div style="background: var(--bg-color); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="font-size:0.75rem; color:var(--text-muted); font-weight:bold;">TOTAL CREDITS</div>
                            <div id="totalCredits" style="font-size:1.5rem; font-weight:bold; color: var(--text-color);">0</div>
                        </div>
                        <div style="background: var(--bg-color); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="font-size:0.75rem; color:var(--text-muted); font-weight:bold;">TOTAL POINTS</div>
                            <div id="totalPoints" style="font-size:1.5rem; font-weight:bold; color: var(--text-color);">0</div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button type="button" class="btn-save" id="syncBtn" onclick="saveToCloud()">
                            <i class="fas fa-cloud-upload-alt"></i> Sync CGPA to National DB
                        </button>
                        
                        <button type="button" class="btn-download" onclick="generateOfficialTranscript()">
                            <i class="fas fa-file-pdf"></i> Export Official Transcript
                        </button>
                    </div>

                    <div class="scale-ref">
                        <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--text-color);">Grading System Reference</h4>
                        <table class="scale-table">
                            <thead><tr><th>Score Range</th><th>Grade</th><th>Point</th></tr></thead>
                            <tbody id="scaleTableBody">
                                </tbody>
                        </table>
                    </div>

                </aside>

            </div>
        </main>
    </div>

    <script>
        // --- 1. GLOBAL STATE & FIREBASE SYNC ---
        function toggleMobileSidebar() {
            document.querySelector('.sidebar').classList.toggle('mobile-open');
            document.querySelector('.sidebar-overlay').classList.toggle('mobile-open');
        }

        let userDbKey = null;
        let globalUserProfile = {}; // Holds profile data for transcript generation

        document.addEventListener('DOMContentLoaded', () => {
            initCloudSync();
            updateScaleReference();
        });

        function initCloudSync() {
            const cachedEmail = localStorage.getItem("portal-user-email");
            
            if (cachedEmail) {
                db.ref('users').orderByChild('email').equalTo(cachedEmail).once('value', (snapshot) => {
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            userDbKey = child.key;
                            globalUserProfile = child.val();
                            
                            // Load previous calculator courses if they exist
                            const savedCourses = globalUserProfile.gpa_courses || JSON.parse(localStorage.getItem('portal-gpa-courses')) || [];
                            loadRows(savedCourses);
                        });
                    } else {
                        fallbackLocalLoad();
                    }
                });
            } else {
                fallbackLocalLoad();
            }
        }

        function fallbackLocalLoad() {
            const savedCourses = JSON.parse(localStorage.getItem('portal-gpa-courses')) || [];
            loadRows(savedCourses);
        }

        function loadRows(courses) {
            const container = document.getElementById('course-rows');
            container.innerHTML = ''; 

            if (courses.length > 0) {
                courses.forEach(c => addRow(c.code, c.name, c.credits, c.score));
                setTimeout(calculate, 100);
            } else {
                for(let i=0; i<4; i++) addRow(); // Blank default rows
            }
        }

        // --- 3. ROW MANAGEMENT ---
        function addRow(code = '', name = '', credits = '', score = '') {
            const container = document.getElementById('course-rows');
            const row = document.createElement('div');
            row.className = 'course-row';
            row.innerHTML = `
                <input type="text" placeholder="Code" value="${code}" class="c-code">
                <input type="text" placeholder="Course Title" value="${name}" class="c-name">
                <input type="number" placeholder="Cr" value="${credits}" min="1" max="6" class="c-credit">
                <input type="number" placeholder="Score" value="${score}" min="0" max="100" class="c-score">
                <button type="button" class="btn-remove" onclick="this.parentElement.remove()" title="Delete Row">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
            container.appendChild(row);
        }

        // --- 4. THE MATH ENGINE ---
        function calculate() {
            const scale = document.getElementById('scaleSelect').value;
            const rows = document.querySelectorAll('.course-row');
            
            let totalGradePoints = 0;
            let totalCredits = 0;
            let hasData = false;

            rows.forEach(row => {
                const cred = parseFloat(row.querySelector('.c-credit').value);
                const score = parseFloat(row.querySelector('.c-score').value);

                if (!isNaN(cred) && !isNaN(score)) {
                    hasData = true;
                    const pointPerCredit = getGradePoint(score, scale);
                    totalGradePoints += (pointPerCredit * cred);
                    totalCredits += cred;
                }
            });

            if (!hasData) return; 

            const gpa = (totalGradePoints / totalCredits).toFixed(2);
            
            // Activate Results Panel
            const resCard = document.getElementById('resultCard');
            resCard.style.opacity = '1';
            resCard.style.pointerEvents = 'all';

            // Update Values with Animation
            animateValue("gpaValue", 0, parseFloat(gpa), 800);
            document.getElementById('totalCredits').innerText = totalCredits;
            document.getElementById('totalPoints').innerText = totalGradePoints.toFixed(1);

            updateVisuals(parseFloat(gpa), scale);
        }

        // --- 5. GRADE SCALES & LETTER LOGIC ---
        function getGradePoint(score, scale) {
            if (scale === '5.0') {
                if (score >= 80) return 5.00; 
                if (score >= 70) return 4.50; 
                if (score >= 65) return 4.00; 
                if (score >= 60) return 3.50; 
                if (score >= 55) return 3.00; 
                if (score >= 50) return 2.50; 
                if (score >= 45) return 2.00; 
                if (score >= 40) return 1.50; 
                return 0.00; 
            } else {
                if (score >= 70) return 4.00; 
                if (score >= 60) return 3.50; 
                if (score >= 50) return 3.00; 
                if (score >= 45) return 2.50; 
                if (score >= 40) return 2.00; 
                return 0.00; 
            }
        }

        function getGradeLetter(score, scale) {
            if (scale === '5.0') {
                if (score >= 80) return 'A+'; 
                if (score >= 70) return 'A'; 
                if (score >= 65) return 'B+'; 
                if (score >= 60) return 'B'; 
                if (score >= 55) return 'C+'; 
                if (score >= 50) return 'C'; 
                if (score >= 45) return 'D+'; 
                if (score >= 40) return 'D'; 
                return 'F'; 
            } else {
                if (score >= 70) return 'A'; 
                if (score >= 60) return 'B+'; 
                if (score >= 50) return 'B'; 
                if (score >= 45) return 'C+'; 
                if (score >= 40) return 'C'; 
                return 'F'; 
            }
        }

        // --- 6. VISUAL FEEDBACK & REMARKS ---
        function updateVisuals(gpa, scale) {
            const circle = document.getElementById('gpaCircle');
            const badge = document.getElementById('classBadge');
            const remarks = document.getElementById('gpaRemarks');
            
            let color = "#ef4444"; 
            let label = "Academic Probation";
            let remarkText = "";

            if (scale === '5.0') {
                if(gpa >= 4.5) { 
                    color = "#10b981"; label = "First Class Honours"; 
                    remarkText = "Outstanding! You are demonstrating exceptional academic mastery.";
                } else if(gpa >= 3.5) { 
                    color = "#10b981"; label = "Second Class (Upper)"; 
                    remarkText = "Impressive work! You are maintaining a very strong academic record.";
                } else if(gpa >= 2.5) { 
                    color = "#f59e0b"; label = "Second Class (Lower)"; 
                    remarkText = "A solid performance. Consistency is key to reaching the next level.";
                } else if(gpa >= 1.5) { 
                    color = "#f97316"; label = "Third Class"; 
                    remarkText = "You have passed, but there is significant room for improvement.";
                } else {
                    remarkText = "Your academic standing is at risk. Please prioritize your studies.";
                }
            } else {
                if(gpa >= 3.6) { 
                    color = "#10b981"; label = "First Class Honours"; 
                    remarkText = "Exceptional! You are currently among the top-performing students. Push harder with consistence!!";
                } else if(gpa >= 3.0) { 
                    color = "#10b981"; label = "Second Class (Upper)"; 
                    remarkText = "Very good! Your hard work is reflecting in your grades. Greatness awaits you, you can get to the top!!";
                } else if(gpa >= 2.5) { 
                    color = "#f59e0b"; label = "Second Class (Lower)"; 
                    remarkText = "Good progress. Aim higher in the coming semesters/trimesters to reach the top.";
                } else if(gpa >= 2.0) { 
                    color = "#f97316"; label = "Third Class"; 
                    remarkText = "You are on track, but extra effort could yield much better results. Keep Pushing!!!";
                } else {
                    remarkText = "Urgent: Your grades are below standard. Seek academic support immediately. Do not be discouraged, but rather know that you can do it. Keep Pushing!!";
                }
            }

            circle.style.borderColor = color;
            circle.style.color = color;
            badge.style.background = color + "15"; 
            badge.style.color = color;
            badge.style.border = `1px solid ${color}40`;
            badge.innerText = label;
            
            remarks.innerText = `"${remarkText}"`;
            remarks.style.color = color;
            remarks.style.borderColor = `${color}40`;
            remarks.style.background = `${color}05`;
        }

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = (progress * (end - start) + start).toFixed(2);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function updateScaleReference() {
            const scale = document.getElementById('scaleSelect').value;
            const tbody = document.getElementById('scaleTableBody');
            tbody.innerHTML = '';

            let data = [];
            if (scale === '5.0') {
                data = [
                    { range: '80 - 100', grade: 'A+', point: '5.00' },
                    { range: '70 - 79', grade: 'A', point: '4.50' },
                    { range: '65 - 69', grade: 'B+', point: '4.00' },
                    { range: '60 - 64', grade: 'B', point: '3.50' },
                    { range: '55 - 59', grade: 'C+', point: '3.00' },
                    { range: '50 - 54', grade: 'C', point: '2.50' },
                    { range: '45 - 49', grade: 'D+', point: '2.00' },
                    { range: '40 - 44', grade: 'D', point: '1.50' },
                    { range: '0 - 39', grade: 'F', point: '0.00' }
                ];
            } else {
                data = [
                    { range: '70 - 100', grade: 'A', point: '4.00' },
                    { range: '60 - 69', grade: 'B+', point: '3.50' },
                    { range: '50 - 59', grade: 'B', point: '3.00' },
                    { range: '45 - 49', grade: 'C+', point: '2.50' },
                    { range: '40 - 44', grade: 'C', point: '2.00' },
                    { range: '0 - 39', grade: 'F', point: '0.00' }
                ];
            }

            data.forEach(row => {
                tbody.innerHTML += `<tr><td>${row.range}</td><td><b>${row.grade}</b></td><td>${row.point}</td></tr>`;
            });
        }

        // --- 8. DATABASE CLOUD SYNC ---
        function saveToCloud() {
            const gpaValue = document.getElementById('gpaValue').innerText;
            const btn = document.getElementById('syncBtn');
            
            if (gpaValue === "0.00") {
                alert("Please calculate your GPA before syncing to the database.");
                return;
            }

            const rows = document.querySelectorAll('.course-row');
            let courseData = [];
            rows.forEach(row => {
                const code = row.querySelector('.c-code').value.trim();
                const name = row.querySelector('.c-name').value.trim();
                const cred = row.querySelector('.c-credit').value;
                const score = row.querySelector('.c-score').value;
                if(name && cred && score) {
                    courseData.push({ code: code, name: name, credits: cred, score: score });
                }
            });

            // Instant Local Backup
            localStorage.setItem('portal-gpa', gpaValue);
            localStorage.setItem('portal-gpa-courses', JSON.stringify(courseData));

            // UI Feedback
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Syncing to Cloud...`;
            btn.disabled = true;

            if (userDbKey) {
                db.ref('users/' + userDbKey).update({ 
                    gpa: gpaValue,
                    gpa_courses: courseData
                })
                .then(() => {
                    btn.innerHTML = `<i class="fas fa-check-circle"></i> Successfully Synced!`;
                    btn.style.background = "#10b981";
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = "#10b981";
                        btn.disabled = false;
                    }, 2500);
                })
                .catch(err => {
                    btn.innerHTML = `<i class="fas fa-hdd"></i> Saved Locally`;
                    btn.style.background = "#f59e0b"; 
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = "#10b981";
                        btn.disabled = false;
                    }, 3000);
                });
            } else {
                btn.innerHTML = `<i class="fas fa-hdd"></i> Saved Locally`;
                btn.style.background = "#f59e0b"; 
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = "#10b981";
                    btn.disabled = false;
                }, 3000);
            }
        }

        // --- 9. PREMIUM TRANSCRIPT GENERATOR ---
        function generateOfficialTranscript() {
            // Check if calculation was run
            const gpaValue = document.getElementById('gpaValue').innerText;
            if (gpaValue === "0.00") {
                alert("Please enter scores and calculate before exporting.");
                return;
            }

            // 1. Populate Header Bio Data
            const id = globalUserProfile.id ? `102${globalUserProfile.id.toString().substring(0,4)}09` : (localStorage.getItem('portal-user-id') || 'PENDING');
            const inst = globalUserProfile.institution || localStorage.getItem('portal-institution') || 'NATIONAL TERTIARY PORTAL';
            
            document.getElementById('t-name').innerText = (globalUserProfile.name || localStorage.getItem('portal-user-name') || 'Student User');
            document.getElementById('t-id').innerText = id;
            document.getElementById('t-prog').innerText = globalUserProfile.program || 'DEGREE PROGRAMME';
            document.getElementById('t-inst').innerText = inst;
            document.getElementById('t-dept').innerText = "DEPARTMENT OF " + (globalUserProfile.department || 'GENERAL ACADEMICS').toUpperCase();
            document.getElementById('t-fee').innerText = (globalUserProfile.financial_status || 'REGULAR').toUpperCase();
            document.getElementById('t-level').innerText = globalUserProfile.level ? `LEVEL ${globalUserProfile.level}` : 'LEVEL 100';
            document.getElementById('t-date').innerText = new Date().toLocaleDateString();
            document.getElementById('t-sig-date').innerText = "DATE: " + new Date().toLocaleDateString();

            // Setup Logo & Avatar
            const initials = inst.split(' ').map(n=>n[0]).join('').substring(0,3).toUpperCase();
            document.getElementById('t-logo').src = `https://ui-avatars.com/api/?name=${initials}&background=fff&color=000&size=200&font-size=0.4&bold=true`;
            
            const avatar = globalUserProfile.avatar || localStorage.getItem('portal-avatar') || 'https://via.placeholder.com/150';
            document.getElementById('t-avatar').src = avatar;

            // Generate Barcode
            document.getElementById('t-index-text').innerText = "INDEX: " + id;
            document.getElementById('t-barcode-img').src = `https://barcode.tec-it.com/barcode.ashx?data=${id}&code=Code128&dpi=96`;

            // 2. Populate Table
            const scale = document.getElementById('scaleSelect').value;
            const rows = document.querySelectorAll('.course-row');
            const tbody = document.getElementById('t-tbody');
            tbody.innerHTML = '';

            rows.forEach(row => {
                const code = row.querySelector('.c-code').value.trim() || 'N/A';
                const name = row.querySelector('.c-name').value.trim() || 'UNNAMED COURSE';
                const cred = row.querySelector('.c-credit').value || '0';
                const score = row.querySelector('.c-score').value || '0';
                
                if (name !== 'UNNAMED COURSE' && score !== '') {
                    const grade = getGradeLetter(parseFloat(score), scale);
                    tbody.innerHTML += `
                        <tr>
                            <td>${code}</td>
                            <td>${name}</td>
                            <td>${cred}</td>
                            <td>${score}</td>
                            <td><strong style="font-size:11pt;">${grade}</strong></td>
                        </tr>
                    `;
                }
            });

            // 3. Populate Summary
            const totalCr = document.getElementById('totalCredits').innerText;
            document.getElementById('t-summary-text').innerText = `CC (TOTAL CREDITS): ${totalCr} | GPA: ${gpaValue} | CGPA: ${gpaValue}`;

            // 4. Execute Print Dialog
            window.print();
        }
    </script>
</body>
</html>